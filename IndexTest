<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Notification Tester</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; }
        #status { font-size: 1.2em; font-weight: bold; }
        #history, #realtime { margin-top: 20px; }
        h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        pre { background-color: #333; color: #00ff00; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Notification Tester</h1>
    <div id="status">Status: Connecting...</div>
    <div id="history">
        <h2>History (from /api/notifications)</h2>
        <pre id="history-data">Loading...</pre>
    </div>
    <div id="realtime">
        <h2>Real-Time Events (from /api/notifications/stream)</h2>
        <pre id="realtime-data">Waiting for events...</pre>
    </div>

    <script>
        const API_BASE_URL = "http://localhost:8085/api/notifications";
        const statusEl = document.getElementById("status");
        const historyEl = document.getElementById("history-data");
        const realtimeEl = document.getElementById("realtime-data");

        // --- 1. Fetch History ---
        async function fetchHistory() {
            try {
                const response = await fetch(API_BASE_URL + "?page=0&size=20");
                if (!response.ok) {
                    throw new Error("Failed to fetch history. Is service running?");
                }
                const data = await response.json();
                // Just dump the raw JSON into the <pre> tag
                historyEl.textContent = JSON.stringify(data.content, null, 2);
            } catch (err) {
                console.error("History Error:", err);
                historyEl.textContent = "Error: " + err.message;
            }
        }

        // --- 2. Connect to Real-Time Stream (SSE) ---
        function connectToStream() {
            const eventSource = new EventSource(API_BASE_URL + "/stream");

            eventSource.onopen = () => {
                console.log("SSE Connection Established!");
                statusEl.textContent = "Status: ● Connected";
                statusEl.style.color = "green";
            };

            // This is the main listener for your notifications
            eventSource.addEventListener("new_notification", (event) => {
                console.log("SSE Received:", event.data);
                const newNotification = JSON.parse(event.data);
                
                // Add the new event to the top of the <pre> tag
                realtimeEl.textContent = JSON.stringify(newNotification, null, 2) + "\n\n" + realtimeEl.textContent;
            });

            // Handle any errors
            eventSource.onerror = () => {
                console.error("SSE Error. Connection failed.");
                statusEl.textContent = "Status: ● Connection Failed. Retrying...";
                statusEl.style.color = "red";
                // The browser will automatically try to reconnect
            };
        }

        // --- Run Everything ---
        fetchHistory();
        connectToStream();

    </script>
</body>
</html>



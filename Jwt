<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.0</version> <!-- Use your project's Spring Boot version -->
        <relativePath/>
    </parent>

    <groupId>com.tcs.f1</groupId>
    <artifactId>security-jwt-lib</artifactId>
    <version>1.0.0</version>
    <name>security-jwt-lib</name>
    <description>Shared library for production-grade JWT validation and role conversion</description>
    <packaging>jar</packaging> <!-- This is a library, not a runnable WAR -->

    <properties>
        <java.version>17</java.version>
    </properties>

    <dependencies>
        <!--
            Provides all necessary classes for being a secure OAuth2 Resource Server.
            Includes JWT validation, claim extraction, and security context management.
        -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
        </dependency>

        <!--
            Required for the auto-configuration to work and to provide a web security context.
        -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- Lombok for reducing boilerplate code -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
    </dependencies>
</project>








package com.tcs.f1.security.config;

import org.springframework.core.convert.converter.Converter;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.jwt.Jwt;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

/**
 * A custom Spring Converter to extract the 'userRole' claim from a JWT
 * and map specific numeric codes to standard Spring Security GrantedAuthorities.
 * This is the central point for role translation logic.
 */
public class JwtRoleConverter implements Converter<Jwt, Collection<GrantedAuthority>> {

    private static final String ROLE_CLAIM = "userRole";
    private static final int MAKER_ROLE_CODE = 51;
    private static final int CHECKER_ROLE_CODE = 52;

    @Override
    public Collection<GrantedAuthority> convert(Jwt jwt) {
        Object roles = jwt.getClaim(ROLE_CLAIM);
        if (roles == null) {
            return Collections.emptyList();
        }

        // The 'userRole' claim could be a single number or a collection of numbers.
        // This code handles both scenarios gracefully.
        if (roles instanceof Number) {
            return List.of(mapRole((Number) roles));
        }

        if (roles instanceof Collection) {
            return ((Collection<?>) roles).stream()
                    .filter(Number.class::isInstance)
                    .map(role -> mapRole((Number) role))
                    .collect(Collectors.toList());
        }

        return Collections.emptyList();
    }

    private GrantedAuthority mapRole(Number roleCode) {
        int role = roleCode.intValue();
        if (role == MAKER_ROLE_CODE) {
            return new SimpleGrantedAuthority("ROLE_MAKER");
        }
        if (role == CHECKER_ROLE_CODE) {
            return new SimpleGrantedAuthority("ROLE_CHECKER");
        }
        // If the role code is unknown, we grant no authority.
        return null;
    }
}








package com.tcs.f1.security.util;

import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.jwt.Jwt;

/**
 * A secure, production-ready utility to extract information from the validated JWT
 * that Spring Security places in the SecurityContext.
 */
public class JwtUtil {

    /**
     * Safely retrieves the user ID (from the standard 'sub' claim) from the
     * authenticated principal in the SecurityContext.
     * <p>
     * This method is safe to use because it can only be called after Spring's security
     * filter chain has successfully validated the token's signature and claims.
     *
     * @return The user ID string.
     * @throws IllegalStateException if called from an unsecured context where the principal
     * is not a validated Jwt, indicating a severe configuration error.
     */
    public static String getUserIdFromContext() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();

        if (principal instanceof Jwt) {
            // The 'sub' (subject) claim is the standard, secure way to identify a user.
            return ((Jwt) principal).getSubject();
        }

        // This should never be reached in a properly secured application.
        throw new IllegalStateException("Could not extract user ID. The principal in the SecurityContext is not a valid JWT.");
    }
}










package com.tcs.f1.security.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationConverter;

/**
 * Spring Boot auto-configuration class for the security library.
 * This class automatically creates the necessary beans for JWT handling
 * in any service that includes this library as a dependency.
 */
@Configuration
public class SecurityJwtAutoConfiguration {

    /**
     * Creates the bean for our custom role converter.
     */
    @Bean
    public JwtRoleConverter jwtRoleConverter() {
        return new JwtRoleConverter();
    }

    /**
     * Creates the main JWT authentication converter and wires in our custom role converter.
     * This bean will be used by the SecurityConfig in the consumer applications.
     *
     * @param jwtRoleConverter The custom role converter bean.
     * @return A fully configured JwtAuthenticationConverter.
     */
    @Bean
    public JwtAuthenticationConverter jwtAuthenticationConverter(JwtRoleConverter jwtRoleConverter) {
        JwtAuthenticationConverter converter = new JwtAuthenticationConverter();
        converter.setJwtGrantedAuthoritiesConverter(jwtRoleConverter);
        return converter;
    }
}

Part 2: How to Build and Use This Library
Follow this two-step process for each of your microservices (like CommonRequestService).
Step 1: Build the JAR
 * Open a terminal or command prompt.
 * Navigate to the root folder of the security-jwt-lib project.
 * Run the Maven command: mvn clean install
 * This will build the security-jwt-lib-1.0.0.jar and install it into your local Maven repository (your .m2 folder, e.g., on your C: drive).
Step 2: Include the JAR in Your Service
 * Go to your CommonRequestService project.
 * Open its pom.xml file.
 * Add the following block inside the <dependencies> section:
   <!-- Your other dependencies (spring-boot-starter-web, etc.) -->

<!-- == ADD THIS BLOCK == -->
<dependency>
    <groupId>com.tcs.f1</groupId>
    <artifactId>security-jwt-lib</artifactId>
    <version>1.0.0</version>
</dependency>
<!-- ===================== -->

<!-- Your other dependencies (lombok, ojdbc8, etc.) -->






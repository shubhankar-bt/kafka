package com.fincore.gateway.Service;

import com.fincore.gateway.dto.ChildMenu;
import com.fincore.gateway.dto.MenuResponse;
import com.fincore.gateway.dto.PermissionRow;
import com.fincore.gateway.dto.RootMenu;
import com.fincore.gateway.model.Permissions;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.*;
import java.util.stream.Collectors;

/**
 * Builds navigational menu structures from permission entities or projections.
 * UPDATED: Merges 'menuAction' for Root Menus with the same Title.
 */
@Slf4j
@Service
public class MenuService {

    /**
     * Transforms a list of {@link Permissions} entities into a {@link MenuResponse}.
     */
    public MenuResponse transform(List<Permissions> permissionsList) {
        MenuResponse response = new MenuResponse();

        if (permissionsList == null || permissionsList.isEmpty()) {
            response.setRoot_menus(Collections.emptyList());
            return response;
        }

        // Group by root menu title
        Map<String, List<Permissions>> grouped =
                permissionsList.stream().collect(Collectors.groupingBy(Permissions::getMenuTitle));

        List<RootMenu> rootMenus = new ArrayList<>();

        for (Map.Entry<String, List<Permissions>> entry : grouped.entrySet()) {
            List<Permissions> group = entry.getValue();

            // 1. Pick a representative for basic fields (Icon, Route, Desc)
            // Prefer the one with the smallest non-null orderId
            Permissions rootPerm = group.stream()
                    .min(Comparator.comparing(MenuService::safeOrderId))
                    .orElse(group.get(0));

            RootMenu rootMenu = buildRootFromPermissions(rootPerm);

            // 2. [CRITICAL FIX]: MERGE ROOT ACTIONS
            // Collect actions from ALL rows in this group (e.g. Maker + Blocker),
            // split them by pipe, deduplicate, and rejoin.
            String mergedAction = group.stream()
                    .map(Permissions::getMenuAction)
                    .filter(Objects::nonNull)
                    .flatMap(action -> Arrays.stream(action.split("\\|"))) // Split "create|modify"
                    .map(String::trim)
                    .distinct() // Remove duplicates (e.g. if both have "view")
                    .collect(Collectors.joining("|"));

            rootMenu.setMenuAction(mergedAction); // Ensure RootMenu has this setter

            // 3. Build children from items that actually have a sub-menu
            List<ChildMenu> children = group.stream()
                    .filter(p -> p.getSubMenu() != null)
                    .map(this::buildChildFromPermissions)
                    .sorted(Comparator.comparing(MenuService::safeOrderIdChild))
                    .collect(Collectors.toList());

            rootMenu.setHasChildren(!children.isEmpty());
            rootMenu.setChildren(children);
            rootMenus.add(rootMenu);
        }

        // Sort roots by orderId
        rootMenus.sort(Comparator.comparing(MenuService::safeOrderIdRoot));

        response.setRoot_menus(rootMenus);
        return response;
    }

    /**
     * Transforms a list of {@link PermissionRow} projections into a {@link MenuResponse}.
     */
    public MenuResponse transformFromProjection(List<PermissionRow> rows) {
        MenuResponse response = new MenuResponse();

        if (rows == null || rows.isEmpty()) {
            response.setRoot_menus(Collections.emptyList());
            return response;
        }

        // Group by root menu title
        Map<String, List<PermissionRow>> grouped =
                rows.stream().collect(Collectors.groupingBy(PermissionRow::getMenuTitle));

        List<RootMenu> rootMenus = new ArrayList<>();

        for (Map.Entry<String, List<PermissionRow>> entry : grouped.entrySet()) {
            List<PermissionRow> group = entry.getValue();

            // 1. Representative root row
            PermissionRow root = group.stream()
                    .min(Comparator.comparing(MenuService::safePermissionOrder))
                    .orElse(group.get(0));

            RootMenu rootMenu = buildRootFromProjection(root);

            // 2. [CRITICAL FIX]: MERGE ROOT ACTIONS
            String mergedAction = group.stream()
                    .map(PermissionRow::getMenuAction)
                    .filter(Objects::nonNull)
                    .flatMap(action -> Arrays.stream(action.split("\\|")))
                    .map(String::trim)
                    .distinct()
                    .collect(Collectors.joining("|"));

            rootMenu.setMenuAction(mergedAction);

            // 3. Children (only rows that actually represent a sub-menu)
            List<ChildMenu> children = group.stream()
                    .filter(r -> r.getSubMenu() != null)
                    .map(this::buildChildFromProjection)
                    .sorted(Comparator.comparing(MenuService::safeOrderIdChild))
                    .collect(Collectors.toList());

            rootMenu.setHasChildren(!children.isEmpty());
            rootMenu.setChildren(children);
            rootMenus.add(rootMenu);
        }

        rootMenus.sort(Comparator.comparing(MenuService::safeOrderIdRoot));

        response.setRoot_menus(rootMenus);
        return response;
    }

    // --------------------------------------------------------------------------------------------
    // Builders
    // --------------------------------------------------------------------------------------------

    private RootMenu buildRootFromPermissions(Permissions p) {
        RootMenu root = new RootMenu();
        root.setId(p.getMenuId());
        root.setTitle(p.getMenuTitle());
        root.setIcon(p.getMenuIcon());
        root.setRoute(p.getMenuUrl());
        root.setComponentPath(p.getComponentPath());
        root.setScreenDescription(p.getMenuDescription());
        root.setOrderId(safeOrderId(p));
        // Note: menuAction is set by the merge logic in the caller method
        return root;
    }

    private ChildMenu buildChildFromPermissions(Permissions p) {
        ChildMenu child = new ChildMenu();
        child.setId(p.getMenuId());
        child.setTitle(p.getSubMenu());
        child.setIcon(p.getMenuIcon());
        child.setRoute(p.getMenuUrl());
        child.setComponentPath(p.getComponentPath());
        child.setScreenDescription(p.getMenuDescription());
        child.setOrderId(safeOrderId(p));
        return child;
    }

    private RootMenu buildRootFromProjection(PermissionRow r) {
        RootMenu root = new RootMenu();
        root.setId(r.getMenuId());
        root.setTitle(r.getMenuTitle());
        root.setIcon(r.getMenuIcon());
        root.setRoute(r.getMenuUrl());
        // setMenuAction is handled by merge logic, but we can set default here
        root.setMenuAction(r.getMenuAction());
        root.setComponentPath(r.getComponentPath());
        root.setScreenDescription(r.getMenuDescription());
        root.setOrderId(safePermissionOrder(r));
        root.setRequestType(r.getRequestType());
        return root;
    }

    private ChildMenu buildChildFromProjection(PermissionRow r) {
        ChildMenu c = new ChildMenu();
        c.setId(r.getMenuId());
        c.setTitle(r.getSubMenu());
        c.setIcon(r.getMenuIcon());
        c.setRoute(r.getMenuUrl());
        c.setComponentPath(r.getComponentPath());
        c.setScreenDescription(r.getMenuDescription());
        c.setOrderId(safePermissionOrder(r));
        return c;
    }

    // --------------------------------------------------------------------------------------------
    // Null-safe order helpers
    // --------------------------------------------------------------------------------------------

    private static int safeOrderId(Permissions p) {
        Integer v = p.getOrderId();
        return v != null ? v : Integer.MAX_VALUE;
    }

    private static int safePermissionOrder(PermissionRow r) {
        Integer v = r.getPermissionOrder();
        return v != null ? v : Integer.MAX_VALUE;
    }

    private static int safeOrderIdRoot(RootMenu r) {
        Integer v = r.getOrderId();
        return v != null ? v : Integer.MAX_VALUE;
    }

    private static int safeOrderIdChild(ChildMenu c) {
        Integer v = c.getOrderId();
        return v != null ? v : Integer.MAX_VALUE;
    }
}


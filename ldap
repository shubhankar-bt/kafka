package com.fincore.gateway.Config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.ldap.core.LdapTemplate;
import org.springframework.ldap.core.support.LdapContextSource;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

@Slf4j
@Configuration
public class LdapConfig {

    // Network Config
    @Value("${spring.ldap.urls:ldaps://uatrootdc1.uatad.sbi:3269}")
    private String ldapUrl;

    @Value("${spring.ldap.base:DC=UATAD,DC=SBI}")
    private String ldapBaseDn;

    // CRITICAL: Bind User Credentials (fincorecbops)
    @Value("${spring.ldap.username:}")
    private String ldapUsername;

    @Value("${spring.ldap.password:}")
    private String ldapPassword;

    // SSL Truststore Config
    @Value("${security.ldap.truststore-path:}")
    private String trustStorePath;

    @Value("${security.ldap.truststore-password:changeit}")
    private String trustStorePassword;

    private final ResourceLoader resourceLoader;

    public LdapConfig(ResourceLoader resourceLoader) {
        this.resourceLoader = resourceLoader;
    }

    @Bean
    public LdapContextSource contextSource() {
        log.info("Configuring LDAP Context Source. URL: {}", ldapUrl);

        // ==========================================
        // 1. SSL TRUSTSTORE SETUP (Proven Working)
        // ==========================================
        if (ldapUrl.toLowerCase().startsWith("ldaps") && trustStorePath != null && !trustStorePath.isBlank()) {
            try {
                Resource trustStore = resourceLoader.getResource(trustStorePath);
                if (trustStore.exists()) {
                    String absolutePath = trustStore.getFile().getAbsolutePath();
                    log.info("Loading External Truststore from: {}", absolutePath);
                    System.setProperty("javax.net.ssl.trustStore", absolutePath);
                    System.setProperty("javax.net.ssl.trustStorePassword", trustStorePassword);
                } else {
                    log.error("CRITICAL: Truststore configured at '{}' but FILE NOT FOUND.", trustStorePath);
                }
            } catch (IOException e) {
                log.error("Error loading truststore file", e);
            }
        }

        // ==========================================
        // 2. CONFIGURE CONNECTION
        // ==========================================
        LdapContextSource contextSource = new LdapContextSource();
        contextSource.setUrl(ldapUrl);
        contextSource.setBase(ldapBaseDn);

        // ==========================================
        // 3. SET BIND CREDENTIALS (Fixes Error 000004DC)
        // ==========================================
        if (ldapUsername != null && !ldapUsername.isBlank()) {
            log.info("Setting LDAP Bind User (Service Account): {}", ldapUsername);
            contextSource.setUserDn(ldapUsername);
            contextSource.setPassword(ldapPassword);
        } else {
            // If this warning prints, your application.yml / env vars are misconfigured
            log.warn("⚠️ WARNING: spring.ldap.username is EMPTY! Anonymous connection will be used. Directory searches WILL fail.");
        }

        // ==========================================
        // 4. TIMEOUTS & PROTOCOL SETTINGS
        // ==========================================
        Map<String, Object> baseEnv = new HashMap<>();
        if (ldapUrl.toLowerCase().startsWith("ldaps")) {
             baseEnv.put("java.naming.security.protocol", "ssl");
        }
        baseEnv.put("com.sun.jndi.ldap.connect.timeout", "5000");
        baseEnv.put("com.sun.jndi.ldap.read.timeout", "5000");

        // Enable connection pooling for better performance using the service account
        contextSource.setPooled(true);
        contextSource.setBaseEnvironmentProperties(baseEnv);

        return contextSource;
    }

    @Bean
    public LdapTemplate ldapTemplate() {
        return new LdapTemplate(contextSource());
    }
}



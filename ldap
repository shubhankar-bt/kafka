package com.fincore.gateway.Config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.ldap.core.LdapTemplate;
import org.springframework.ldap.core.support.LdapContextSource;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

@Slf4j
@Configuration
public class LdapConfig {

    @Value("${spring.ldap.urls:ldaps://10.189.42.83:636}")
    private String ldapUrl;

    @Value("${spring.ldap.base:DC=UATAD,DC=SBI}")
    private String ldapBaseDn;

    // We will inject the ResourceLoader to find the file
    private final ResourceLoader resourceLoader;

    public LdapConfig(ResourceLoader resourceLoader) {
        this.resourceLoader = resourceLoader;
    }

    @Bean
    public LdapContextSource contextSource() {
        log.info("Configuring LDAP Context Source. URL: {}", ldapUrl);

        // =========================================================================
        // DYNAMIC TRUSTSTORE LOADING
        // This allows us to keep the cert in the application resources
        // =========================================================================
        try {
            Resource trustStore = resourceLoader.getResource("classpath:ad-truststore.jks");
            if (trustStore.exists()) {
                String trustStorePath = trustStore.getFile().getAbsolutePath();
                log.info("Setting custom truststore from: {}", trustStorePath);
                
                System.setProperty("javax.net.ssl.trustStore", trustStorePath);
                System.setProperty("javax.net.ssl.trustStorePassword", "changeit");
            } else {
                log.warn("ad-truststore.jks NOT FOUND in classpath. Falling back to system truststore.");
            }
        } catch (IOException e) {
            log.error("Could not load custom truststore", e);
        }

        LdapContextSource contextSource = new LdapContextSource();
        contextSource.setUrl(ldapUrl);
        contextSource.setBase(ldapBaseDn);
        
        // Timeout Configuration
        Map<String, Object> baseEnv = new HashMap<>();
        baseEnv.put("java.naming.security.protocol", "ssl");
        baseEnv.put("com.sun.jndi.ldap.connect.timeout", "5000"); 
        baseEnv.put("com.sun.jndi.ldap.read.timeout", "5000");    
        
        contextSource.setBaseEnvironmentProperties(baseEnv);
        return contextSource;
    }

    @Bean
    public LdapTemplate ldapTemplate() {
        return new LdapTemplate(contextSource());
    }
}



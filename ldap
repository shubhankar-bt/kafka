package com.fincore.gateway.Config;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.ldap.core.LdapTemplate;
import org.springframework.stereotype.Component;

import javax.naming.directory.DirContext;

/**
 * TEMPORARY CLASS: 100% Accurate validation of Network, SSL, Credentials, AND Read Permissions.
 * Remove this class before Production.
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class LdapConnectionTester implements CommandLineRunner {

    // Inject the fully configured Spring LDAP Template
    private final LdapTemplate ldapTemplate;

    @Override
    public void run(String... args) {
        log.info("==========================================");
        log.info("üß™ STARTING 100% ACCURATE LDAP BIND & READ TEST...");

        try {
            // ==========================================
            // TEST 1: Network, SSL, and Authentication
            // ==========================================
            log.info("Step 1: Attempting to Connect and Bind...");
            DirContext context = ldapTemplate.getContextSource().getReadOnlyContext();
            log.info("‚úÖ SUCCESS 1/2: Network is Reachable, SSL is valid, and Bind Credentials are correct!");

            // ==========================================
            // TEST 2: Authorization & Read Permissions
            // ==========================================
            log.info("Step 2: Attempting to Read the Directory Base...");
            // Looking up "" means we are asking AD to read our configured Base DN (DC=UATAD,DC=SBI)
            ldapTemplate.lookupContext("");
            log.info("‚úÖ SUCCESS 2/2: The Bind User has READ permissions on the Active Directory tree!");
            
            log.info("üöÄ SYSTEM IS 100% READY FOR REAL USER LOGINS.");

            // Clean up
            if (context != null) {
                context.close();
            }

        } catch (org.springframework.ldap.AuthenticationException e) {
            log.error("‚ùå BIND ERROR (Step 1 Failed): Invalid Username or Password for the Bind User.");
            log.error("Are you sure you used the correct format (e.g., fincorecbops@UATAD.SBI)?");
            log.error("Details: {}", e.getMessage());
        } catch (org.springframework.ldap.CommunicationException e) {
            log.error("‚ùå NETWORK/SSL ERROR (Step 1 Failed): Connection failed. Check Hostname, Port, or Certificate.");
            log.error("Details: {}", e.getMessage());
        } catch (org.springframework.ldap.NamingException e) {
            log.error("‚ùå READ ERROR (Step 2 Failed): Bind succeeded, but the user lacks permissions to read the Base DN.");
            log.error("Details: {}", e.getMessage());
        } catch (Exception e) {
            log.error("‚ùå UNKNOWN ERROR: ", e);
        }
        log.info("==========================================");
    }
}











        # ADD THESE TWO VARIABLES
        - name: SPRING_LDAP_USERNAME
          value: "fincorecbops@UATAD.SBI"
          
        - name: SPRING_LDAP_PASSWORD
          value: "F1C0re#15"

### **What will this prove?**
When you deploy this, look at the logs. 
* If **Step 1** fails, you know the username format or password is wrong (or the network/SSL is still broken).
* If **Step 1** passes but **Step 2** fails, you know the AD team gave you a user, but forgot to give that user permission to read the directory.
* If **Both Steps** pass, you have **mathematical certainty** that your Java application is perfectly connected to the Bank's AD, and the moment you get those 5 test users, the login API will work flawlessly.

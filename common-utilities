package com.fincore.commonutilities.jwt;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.io.IOException;
import java.util.Base64;

public class JwtUtil {
    private static final ObjectMapper objectMapper = new ObjectMapper();

    /**
     * todo Extracts the User ID (subject) from a JWT token.
     * NOTE: This method DOES NOT verify the token's signature. It is intended for
     * development and debugging purposes where the token is assumed to be valid.
     * In a production environment, you MUST use a proper JWT validation library
     * with a public key to ensure the token is authentic and not tampered with.
     *
     * @param token The full "Bearer <token>" string.
     * @return The User ID (from the "sub" claim).
     */
    public static String getUserIdFromToken(String token) {
        // Shared logic to extract and parse the payload from the token string.
        JsonNode payloadNode = extractAndParsePayload(token);

        if (payloadNode.has("sub")) {
            return payloadNode.get("sub").asText();
        }
        throw new IllegalArgumentException("JWT token does not contain 'sub' (subject) claim");
    }

    /**
     * Extracts the User Role from a JWT token.
     * NOTE: This method DOES NOT verify the token's signature. It is intended for
     * development and debugging purposes where the token is assumed to be valid.
     *
     * @param token The full "Bearer <token>" string.
     * @return The User Role (from the "role" claim) as an integer.
     */
    public static int getUserRoleFromToken(String token) {
        // Shared logic to extract and parse the payload from the token string.
        JsonNode payloadNode = extractAndParsePayload(token);

        if (payloadNode.has("role")) {
            JsonNode roleNode = payloadNode.get("role");
            if (roleNode.isInt()) {
                return roleNode.asInt();
            } else {
                throw new IllegalArgumentException("Role value is not numeric");
            }
        }
        throw new IllegalArgumentException("JWT token does not contain 'role' claim");
    }

    /**
     * Helper method to handle the common logic of extracting the raw JWT,
     * decoding the payload, and parsing it into a JsonNode.
     */
    private static JsonNode extractAndParsePayload(String token) {
        if (token == null || !token.startsWith("Bearer ")) {
            throw new IllegalArgumentException("Invalid Authorization header");
        }
        String jwt = token.substring(7);
        String[] chunks = jwt.split("\\.");
        if (chunks.length < 2) {
            throw new IllegalArgumentException("Invalid JWT token");
        }
        Base64.Decoder decoder = Base64.getUrlDecoder();
        String payload;
        try {
            payload = new String(decoder.decode(chunks[1]));
        } catch (IllegalArgumentException e) {
            throw new IllegalArgumentException("Invalid Base64 encoding in JWT payload", e);
        }
        try {
            return objectMapper.readTree(payload);
        } catch (IOException e) {
            throw new RuntimeException("Failed to parse JWT payload as JSON", e);
        }
    }
}









// application.propeties
spring.application.name=CommonUtilities



pom.xml :
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<groupId>com.fincore</groupId>
	<artifactId>common-utilities</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>CommonUtilities</name>
	<description>Common utilities used across the application.</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>22</java.version>
	</properties>
	<dependencies>

        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.20.0</version>
        </dependency>
	</dependencies>

	<build>
		<plugins>
		</plugins>
	</build>

</project>







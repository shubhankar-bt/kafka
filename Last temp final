package com.fincore.ReportService.service;

import com.jcraft.jsch.*;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.Vector;

@Service
@Slf4j
public class SftpService {

    @Value("${sftp.host}")
    private String host;

    @Value("${sftp.port}")
    private int port;

    @Value("${sftp.user}")
    private String user;

    @Value("${sftp.password}")
    private String password;

    @Value("${sftp.strict-host-key-checking:no}")
    private String strictHostKeyChecking;

    /**
     * Connects to SFTP and executes the provided action.
     */
    public <T> T execute(SftpAction<T> action) throws IOException {
        Session session = null;
        ChannelSftp channelSftp = null;

        try {
            // DETAILED LOGGING FOR DEBUGGING
            log.info("SFTP Connecting... Host: {}, Port: {}, User: {}", host, port, user);
            
            JSch jsch = new JSch();
            session = jsch.getSession(user, host, port);
            session.setPassword(password);

            java.util.Properties config = new java.util.Properties();
            config.put("StrictHostKeyChecking", strictHostKeyChecking);
            // Optimization: Increase buffer sizes for speed
            config.put("PreferredAuthentications", "publickey,keyboard-interactive,password");
            session.setConfig(config);

            // Connect Session (Network Layer)
            session.connect(10000); // Set 10s timeout
            log.info("SFTP Session Connected. Opening Channel...");
            
            // Open Channel (Application Layer)
            Channel channel = session.openChannel("sftp");
            channel.connect();
            channelSftp = (ChannelSftp) channel;
            log.info("SFTP Channel Opened. Executing action...");

            return action.doInSftp(channelSftp);

        } catch (JSchException | SftpException e) {
            log.error("SFTP Connection Failed to {}:{} -> {}", host, port, e.getMessage());
            // Helpful Hint for "NoRouteToHost"
            if (e.getMessage().contains("NoRouteToHost")) {
                log.error("HINT: The server IP is unreachable. Check VPN, Firewall, or if IP is correct.");
            }
            throw new IOException("SFTP Failure: " + e.getMessage(), e);
        } finally {
            if (channelSftp != null) channelSftp.exit();
            if (session != null) session.disconnect();
        }
    }

    public interface SftpAction<T> {
        T doInSftp(ChannelSftp channel) throws SftpException, IOException;
    }

    public List<String> listFiles(String directoryPath, String filePrefix) throws IOException {
        return execute(channel -> {
            log.info("Listing files in: {} with prefix: {}", directoryPath, filePrefix);
            List<String> matchingFiles = new ArrayList<>();
            try {
                Vector<ChannelSftp.LsEntry> entries = channel.ls(directoryPath);
                for (ChannelSftp.LsEntry entry : entries) {
                    if (!entry.getAttrs().isDir() && entry.getFilename().startsWith(filePrefix)) {
                        matchingFiles.add(entry.getFilename());
                    }
                }
                log.info("Found {} matching files.", matchingFiles.size());
            } catch (SftpException e) {
                if (e.id == ChannelSftp.SSH_FX_NO_SUCH_FILE) {
                    log.warn("SFTP Directory missing: {}", directoryPath);
                    return new ArrayList<>();
                }
                throw e;
            }
            return matchingFiles;
        });
    }

    public InputStream getFileStream(String fullPath) throws IOException, JSchException, SftpException {
        // ... (Keep your previous InputStream wrapper logic here) ...
        // Re-implementing connection logic here with same logs for consistency
        log.info("Opening stream for file: {}", fullPath);
        
        JSch jsch = new JSch();
        Session session = jsch.getSession(user, host, port);
        session.setPassword(password);
        java.util.Properties config = new java.util.Properties();
        config.put("StrictHostKeyChecking", strictHostKeyChecking);
        session.setConfig(config);
        
        session.connect(10000); // 10s timeout
        Channel channel = session.openChannel("sftp");
        channel.connect();
        ChannelSftp channelSftp = (ChannelSftp) channel;

        InputStream rawStream = channelSftp.get(fullPath);
        
        return new InputStream() {
            @Override
            public int read() throws IOException { return rawStream.read(); }
            @Override
            public int read(byte[] b, int off, int len) throws IOException { return rawStream.read(b, off, len); }
            @Override
            public void close() throws IOException {
                try { rawStream.close(); } finally {
                    channelSftp.exit();
                    session.disconnect();
                    log.info("Stream Closed. SFTP Session disconnected.");
                }
            }
        };
    }
}



package com.tcs.fincore.CommonRequestService;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableScheduling;

@SpringBootApplication
@EnableScheduling // <--- ADD THIS
public class CommonRequestServiceApplication {
    public static void main(String[] args) {
        System.setProperty("spring.classformat.ignore", "true");
        SpringApplication.run(CommonRequestServiceApplication.class, args);
    }
}






package com.tcs.fincore.CommonRequestService.service;

import com.tcs.fincore.CommonRequestService.repository.NotificationRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Instant;
import java.time.temporal.ChronoUnit;

@Service
@RequiredArgsConstructor
@Slf4j
public class OutboxCleanupService {

    private final NotificationRepository notificationRepository;

    /**
     * Runs every day at 2:00 AM.
     * Deletes Outbox events older than 24 hours.
     * By the time 24 hours have passed, Debezium is guaranteed to have read them.
     */
    @Scheduled(cron = "0 0 2 * * ?") // 2 AM daily
    @Transactional
    public void cleanUpOldEvents() {
        log.info("Starting Outbox Cleanup Job...");
        
        Instant cutoff = Instant.now().minus(1, ChronoUnit.DAYS);
        
        // Note: You need to add this method to your Repository (see below)
        int deletedCount = notificationRepository.deleteByEventTimestampBefore(cutoff);
        
        log.info("Outbox Cleanup Complete. Deleted {} processed events older than {}.", deletedCount, cutoff);
    }
}








package com.tcs.fincore.CommonRequestService.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import com.tcs.fincore.CommonRequestService.model.NotificationTable;
import java.time.Instant;
import java.util.UUID;

@Repository
public interface NotificationRepository extends JpaRepository<NotificationTable, UUID>{
    
    // New method for cleanup
    int deleteByEventTimestampBefore(Instant timestamp);
}












package com.fincore.NotificationService.service;

import com.fincore.NotificationService.repository.NotificationRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Instant;
import java.time.temporal.ChronoUnit;

@Service
@RequiredArgsConstructor
@Slf4j
public class NotificationCleanupService {

    private final NotificationRepository notificationRepository;

    /**
     * Runs every day at 3:00 AM.
     * Deletes User Notifications older than 30 days.
     */
    @Scheduled(cron = "0 0 3 * * ?") // 3 AM daily
    @Transactional
    public void cleanUpOldHistory() {
        log.info("Starting Notification History Cleanup Job...");
        
        // Keep history for 30 days
        Instant cutoff = Instant.now().minus(30, ChronoUnit.DAYS);
        
        // Note: You need to add this method to your Repository
        int deletedCount = notificationRepository.deleteByCreatedAtBefore(cutoff);
        
        log.info("History Cleanup Complete. Deleted {} notifications older than {}.", deletedCount, cutoff);
    }
}
















package com.fincore.NotificationService.service;

import com.fincore.NotificationService.repository.NotificationRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Instant;
import java.time.temporal.ChronoUnit;

@Service
@RequiredArgsConstructor
@Slf4j
public class NotificationCleanupService {

    private final NotificationRepository notificationRepository;

    /**
     * Runs every day at 3:00 AM.
     * Deletes User Notifications older than 30 days.
     */
    @Scheduled(cron = "0 0 3 * * ?") // 3 AM daily
    @Transactional
    public void cleanUpOldHistory() {
        log.info("Starting Notification History Cleanup Job...");
        
        // Keep history for 30 days
        Instant cutoff = Instant.now().minus(30, ChronoUnit.DAYS);
        
        // Note: You need to add this method to your Repository
        int deletedCount = notificationRepository.deleteByCreatedAtBefore(cutoff);
        
        log.info("History Cleanup Complete. Deleted {} notifications older than {}.", deletedCount, cutoff);
    }
}














package com.fincore.NotificationService.repository;

import java.util.UUID;
import java.time.Instant; // Import Instant

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;

import com.fincore.NotificationService.model.Notification;

public interface NotificationRepository extends JpaRepository<Notification, UUID> {

    Page<Notification> findByUserIdOrderByCreatedAtDesc(String userId, Pageable pageable);

    long countByUserIdAndIsReadFalse(String userId);

    // New method for cleanup
    int deleteByCreatedAtBefore(Instant timestamp);
}






spring:
  ldap:
    urls: ldaps://10.189.42.83:636
    base: DC=UATAD,DC=SBI
    
security:
  ldap:
    # LOCAL WINDOWS PATH EXAMPLE (Note the forward slashes /)
    truststore-path: file:C:/fincore/secrets/ad-truststore.jks
    # FOR LINUX SERVER IT WOULD BE: file:/etc/fincore/secrets/ad-truststore.jks
    truststore-password: changeit












package com.fincore.gateway.Config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.ldap.core.LdapTemplate;
import org.springframework.ldap.core.support.LdapContextSource;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

@Slf4j
@Configuration
public class LdapConfig {

    @Value("${spring.ldap.urls:ldaps://10.189.42.83:636}")
    private String ldapUrl;

    @Value("${spring.ldap.base:DC=UATAD,DC=SBI}")
    private String ldapBaseDn;

    // INJECT THE PATH FROM YML
    @Value("${security.ldap.truststore-path:}")
    private String trustStorePath;

    // INJECT THE PASSWORD FROM YML
    @Value("${security.ldap.truststore-password:changeit}")
    private String trustStorePassword;

    private final ResourceLoader resourceLoader;

    public LdapConfig(ResourceLoader resourceLoader) {
        this.resourceLoader = resourceLoader;
    }

    @Bean
    public LdapContextSource contextSource() {
        log.info("Configuring LDAP Context Source. URL: {}", ldapUrl);

        // =========================================================================
        // SECURE DYNAMIC TRUSTSTORE LOADING
        // Reads from external file location defined in application.yml
        // =========================================================================
        if (ldapUrl.toLowerCase().startsWith("ldaps") && trustStorePath != null && !trustStorePath.isBlank()) {
            try {
                // ResourceLoader handles "file:C:/..." or "classpath:..." automatically
                Resource trustStore = resourceLoader.getResource(trustStorePath);
                
                if (trustStore.exists()) {
                    String absolutePath = trustStore.getFile().getAbsolutePath();
                    log.info("Loading External Truststore from: {}", absolutePath);

                    System.setProperty("javax.net.ssl.trustStore", absolutePath);
                    System.setProperty("javax.net.ssl.trustStorePassword", trustStorePassword);
                } else {
                    log.error("CRITICAL: Truststore configured at '{}' but FILE NOT FOUND.", trustStorePath);
                }
            } catch (IOException e) {
                log.error("Error loading truststore file", e);
            }
        }

        LdapContextSource contextSource = new LdapContextSource();
        contextSource.setUrl(ldapUrl);
        contextSource.setBase(ldapBaseDn);

        Map<String, Object> baseEnv = new HashMap<>();
        
        // Smart Protocol logic
        if (ldapUrl.toLowerCase().startsWith("ldaps")) {
             baseEnv.put("java.naming.security.protocol", "ssl");
        }
       
        baseEnv.put("com.sun.jndi.ldap.connect.timeout", "5000");
        baseEnv.put("com.sun.jndi.ldap.read.timeout", "5000");

        contextSource.setBaseEnvironmentProperties(baseEnv);
        return contextSource;
    }

    @Bean
    public LdapTemplate ldapTemplate() {
        return new LdapTemplate(contextSource());
    }
}










security:
  ldap:
    truststore-path: ${LDAP_TRUSTSTORE_PATH}
    truststore-password: ${LDAP_TRUSTSTORE_PASSWORD}


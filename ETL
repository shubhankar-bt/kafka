package com.fincore.helpservice.config;

import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.model.ollama.OllamaChatModel;
import dev.langchain4j.model.ollama.OllamaEmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import dev.langchain4j.store.embedding.redis.RedisEmbeddingStore;
import dev.langchain4j.data.segment.TextSegment;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;

import java.time.Duration;

/**
 * Enterprise AI Configuration.
 * Connects the JVM to the offline Docker LLMs and Vector Database.
 */
@Configuration
public class AiConfiguration {

    @Value("${langchain4j.ollama.base-url}")
    private String ollamaBaseUrl;

    @Value("${langchain4j.ollama.chat-model.name}")
    private String chatModelName;

    @Value("${langchain4j.ollama.embedding-model.name}")
    private String embeddingModelName;

    @Value("${langchain4j.vector-store.redis.host}")
    private String redisHost;

    @Value("${langchain4j.vector-store.redis.port}")
    private Integer redisPort;

    @Value("${langchain4j.vector-store.redis.index-name}")
    private String indexName;

    @Value("${langchain4j.vector-store.redis.prefix}")
    private String prefix;

    @Value("${langchain4j.vector-store.redis.dimension:1024}")
    private Integer dimension;

    // The Generative Model (The Talker)
    @Bean
    @Primary
    public ChatLanguageModel chatLanguageModel() {
        return OllamaChatModel.builder()
                .baseUrl(ollamaBaseUrl)
                .modelName(chatModelName)
                .temperature(0.1)
                .timeout(Duration.ofSeconds(60))
                .build();
    }


    // The Embedding Model (The Searcher)
    @Bean
    @Primary
    public EmbeddingModel embeddingModel() {
        return OllamaEmbeddingModel.builder()
                .baseUrl(ollamaBaseUrl)
                .modelName(embeddingModelName)
                .timeout(Duration.ofSeconds(15))
                .build();
    }

    // The Vector Database (Redis Stack on Port 6380)
    @Bean
    @Primary
    public EmbeddingStore<TextSegment> embeddingStore() {
        return RedisEmbeddingStore.builder()
                .host(redisHost)
                .port(redisPort)
                .dimension(dimension)
                .indexName(indexName)
                .prefix(prefix)
                .build();
    }
}





// -------------------------------------

package com.fincore.helpservice.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableAsync;

@Configuration
@EnableAsync
public class AsyncConfig {
}




// -----------------------------------

package com.fincore.helpservice.config;

import com.fincore.commonutilities.config.CommonSecurityConfig;
import com.fincore.commonutilities.config.RedisConfig;
import com.fincore.commonutilities.config.ResilienceConfig;
import com.fincore.commonutilities.jwt.JwtUtil;
import com.fincore.commonutilities.logging.MdcLoggingFilter;
import com.fincore.commonutilities.security.ContextRbacFilter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

/**
 * Common Security Configuration.
 * * Aligned with the "Distributed Gateway" architecture.
 * It uses the ContextRbacFilter from Common Utilities to enforce:
 * 1. Token Validity
 * 2. Single Session (Redis check)
 * 3. RBAC Permissions
 * Enforces Centralised Mdc Logging Filter, RESILIENCE4J Retry and Circuit Breaker
 */
@Configuration
@EnableWebSecurity
@Import({
        RedisConfig.class,
        JwtUtil.class,
        CommonSecurityConfig.class,
        ResilienceConfig.class,
        RedisConfig.class
})
public class SecurityConfig {

    @Autowired
    private StringRedisTemplate redisTemplate;

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private CommonSecurityConfig commonSecurityConfig;

    // --- 1. Define Filters as Beans (Explicitly) ---

    @Bean
    public MdcLoggingFilter mdcLoggingFilter() {
        return new MdcLoggingFilter(jwtUtil);
    }

    @Bean
    public ContextRbacFilter contextRbacFilter() {
        return new ContextRbacFilter(redisTemplate, jwtUtil);
    }

    // --- 2. Prevent Global Registration ---
    // This stops "The Filter class ... does not have a registered order" error

    @Bean
    public FilterRegistrationBean<MdcLoggingFilter> mdcFilterRegistration(MdcLoggingFilter filter) {
        FilterRegistrationBean<MdcLoggingFilter> registration = new FilterRegistrationBean<>(filter);
        registration.setEnabled(false); // Disable global chain
        return registration;
    }

    @Bean
    public FilterRegistrationBean<ContextRbacFilter> rbacFilterRegistration(ContextRbacFilter filter) {
        FilterRegistrationBean<ContextRbacFilter> registration = new FilterRegistrationBean<>(filter);
        registration.setEnabled(false); // Disable global chain
        return registration;
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(csrf -> csrf.disable())
                .cors(cors -> cors.configurationSource(commonSecurityConfig.corsConfigurationSource()))
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authz -> authz
                        .requestMatchers("/actuator/**", "/api/auth/**", "/error").permitAll()
                        .anyRequest().authenticated()
                )
                // Add Filters using the BEAN references (methods above)
                .addFilterBefore(mdcLoggingFilter(), UsernamePasswordAuthenticationFilter.class)
                .addFilterAfter(contextRbacFilter(), MdcLoggingFilter.class);

        return http.build();
    }

    /**
     * Explicitly indicate that local user lookup is not supported
     * Authentication is handled via JWT in ContextRbacFilter
     */
    @Bean
    public UserDetailsService userDetailsService() {
        return username ->
        { throw new UsernameNotFoundException("UserDetailsService is disabled. Use JWT authentication."); };
    }
}



















// -----------------------------------

package com.fincore.helpservice.controller;

import com.fincore.commonutilities.jwt.JwtUtil;
import com.fincore.helpservice.dto.HelpRequestDTO;
import com.fincore.helpservice.dto.HelpResponseDTO;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.fincore.helpservice.service.FinCoreChatAgent;
import com.fincore.helpservice.service.HelpAnalyticsService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * Primary REST Controller for the FinCore Help & AI Assistant.
 * Orchestrates Generative AI Chat, Static Module Help, and Global FAQs.
 */
@RestController
@RequestMapping("/api/help")
@RequiredArgsConstructor
@Slf4j
public class HelpController {

    private final JwtUtil jwtUtil;

    // 1. The New AI Brain
    private final FinCoreChatAgent chatAgent;

    // 2. The Traditional DB Repositories (For fast, non-AI queries)
    private final HelpQuestionRepository questionRepository;

    // 3. Analytics (For Thumbs Up / Thumbs Down feedback)
    private final HelpAnalyticsService analyticsService;

    // ========================================================================
    // 1. THE AI CHAT ENDPOINT (Powered by Phi-3 & Mxbai)
    // ========================================================================
    @PostMapping("/chat")
    public ResponseEntity<HelpResponseDTO> handleChatQuery(
            @RequestHeader("Authorization") String token,
            @RequestBody HelpRequestDTO request) {

        log.info("[API] Chat request received from User: {} | Role: {} | Message: '{}'", jwtUtil.getUserIdFromToken(token), jwtUtil.getUserRoleFromToken(token), request.getUserMessage());

        // Route the query through our LangChain4j RAG pipeline
        HelpResponseDTO response = chatAgent.handleChat(jwtUtil.getUserIdFromToken(token), String.valueOf(jwtUtil.getUserRoleFromToken(token)), request.getUserMessage(), request.getCurrentScreen());

        return ResponseEntity.ok(response);
    }

    // ========================================================================
    // 3. GLOBAL FAQS (Powered by fast SQL - No AI required)
    // ========================================================================
    @GetMapping("/faqs")
    public ResponseEntity<List<HelpQuestionEntity>> getGlobalFaqs(@RequestHeader("Authorization") String token) {
        log.info("[API] Fetching global FAQs");

        // Flow: Fetch predefined global questions (where permission_id is null/GLOBAL)
        List<HelpQuestionEntity> globalFaqs = questionRepository.findGlobalFaqs();

        return ResponseEntity.ok(globalFaqs);
    }

    // ========================================================================
    // 4. CHAT FEEDBACK ENDPOINT (For UI Thumbs Up / Thumbs Down)
    // ========================================================================
    @PostMapping("/feedback")
    public ResponseEntity<Void> submitChatFeedback(
            @RequestHeader("Authorization") String token,
            @RequestBody Map<String, Object> feedbackPayload) {

        // Expected payload: { "logId": 12345, "isHelpful": true }
        Long logId = Long.valueOf(feedbackPayload.get("logId").toString());
        boolean isHelpful = (Boolean) feedbackPayload.get("isHelpful");

        log.info("[API] Feedback received for Log ID: {} | Helpful: {}", logId, isHelpful);

        // Update the audit trail in Oracle to reflect user satisfaction
        analyticsService.updateFeedback(logId, isHelpful);

        return ResponseEntity.ok().build();
    }

    // Allows UI to increment the Popularity of an FAQ when a user clicks the suggestion bubble
    @PostMapping("/faqs/track")
    public ResponseEntity<Void> trackFaqClick(@RequestBody Map<String, String> payload) {
        String question = payload.get("questionText");
        chatAgent.incrementFaqPopularity(question);
        return ResponseEntity.ok().build();
    }
}








package com.fincore.helpservice.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

/**
 * Standard API Response Wrapper.
 * Ensures consistent JSON structure across the entire application.
 * * Structure:
 * {
 * "success": true,
 * "message": "Operation Successful",
 * "data": { ... payload ... },
 * "errorCode": null,
 * "timestamp": "2023-10-27T10:00:00"
 * }
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
public class ApiResponse<T> {

    @Builder.Default
    private boolean success = true;

    private String message;

    private T data;

    private String errorCode;

    @Builder.Default
    private LocalDateTime timestamp = LocalDateTime.now();

    // ========================================================================
    // STATIC FACTORY METHODS (Fluent API)
    // ========================================================================

    /**
     * Success response with data and default message.
     */
    public static <T> ApiResponse<T> success(T data) {
        return ApiResponse.<T>builder()
                .success(true)
                .message("Request processed successfully")
                .data(data)
                .build();
    }

    /**
     * Success response with data and custom message.
     */
    public static <T> ApiResponse<T> success(T data, String message) {
        return ApiResponse.<T>builder()
                .success(true)
                .message(message)
                .data(data)
                .build();
    }

    /**
     * Error response with message and code.
     */
    public static <T> ApiResponse<T> error(String message, String errorCode) {
        return ApiResponse.<T>builder()
                .success(false)
                .message(message)
                .errorCode(errorCode)
                .build();
    }
}















package com.fincore.helpservice.dto;

import lombok.Data;

@Data
public class FeedbackRequestDTO {
    private String logId;
    private String clickedQuestionId;

    // "POSITIVE" (Thumbs Up) or "NEGATIVE" (Thumbs Down)
    private String feedbackType;

    // The exact query the user typed, needed to adjust the Redis score
    private String searchQuery;
}
















package com.fincore.helpservice.dto;

import lombok.Data;

@Data
public class HelpRequestDTO {

    // The actual question typed by the user
    private String userMessage;

    // Optional: If the frontend knows what screen the user is currently on, 
    // it can pass it here so you can add it to the AI's context later!
        private String currentScreen;
}




















package com.fincore.helpservice.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class HelpResponseDTO {

    /**
     * Dictates the UI State.
     * Expected values: "TEXT_REPLY", "SUGGESTION", "ESCALATION_OFFER", "NO_MATCH"
     */
    private String responseType;

    /**
     * The actual text generated by Phi-3 (or standard fallback text).
     * Can contain HTML like <b> or <br/> for the frontend to render.
     */
    private String botReply;

    /**
     * If the AI found a relevant module, this is the URL/Route (e.g., "/cgl-management")
     */
    private String navigationLink;

    /**
     * The text to display on the UI button (e.g., "Go to CGL Management")
     */
    private String navigationLabel;

    /**
     * CRITICAL FOR FEEDBACK:
     * The Primary Key ID of the log saved in Oracle DB.
     * The UI needs this so when the user clicks "Thumbs Up", it sends this ID back to the /feedback endpoint.
     */
    private Long logId;

    /**
     * Used ONLY if responseType is "SUGGESTION".
     * A list of clickable follow-up questions for the user.
     */
    private List<String> items;
}





















package com.fincore.helpservice.exception;

import com.fincore.helpservice.dto.ApiResponse;
import com.fincore.helpservice.dto.HelpResponseDTO;
import jakarta.servlet.http.HttpServletRequest;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.servlet.resource.NoResourceFoundException;

import java.util.HashMap;
import java.util.Map;

/**
 * Centralized Exception Handler.
 * Intercepts all exceptions thrown by Controllers/Services and converts them
 * into the standard ApiResponse format.
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * Handle Custom Business Logic Exceptions.
     */
    @ExceptionHandler(HelpServiceException.class)
    public ResponseEntity<ApiResponse<HelpResponseDTO>> handleBusinessException(HelpServiceException ex) {
        log.warn("Business Exception: [{}] {}", ex.getErrorCode(), ex.getMessage());
        return buildErrorResponse(ex.getMessage());
    }

    /**
     * Handle Validation Errors (@Valid failure).
     * Returns a map of field errors in the data payload for the frontend to highlight.
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<HelpResponseDTO>> handleValidationException(MethodArgumentNotValidException ex) {
        String errorMsg = ex.getBindingResult().getFieldError() != null
                ? ex.getBindingResult().getFieldError().getDefaultMessage()
                : "Invalid Request Data";
        log.warn("Validation Error: {}", errorMsg);
        return buildErrorResponse(errorMsg);
    }

    /**
     * Handle 404 (Resource Not Found) - e.g., Wrong URL.
     */
    @ExceptionHandler(NoResourceFoundException.class)
    public ResponseEntity<ApiResponse<HelpResponseDTO>> handle404(NoResourceFoundException ex) {
        log.warn("The requested resource was not found {}", ex.getMessage());
        return buildErrorResponse("The requested resource was not found");
    }

    /**
     * Handle unexpected System Errors (Catch-All).
     * We do NOT expose the raw stack trace message to the client for security.
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<HelpResponseDTO>> handleGeneralException(Exception ex) {
        log.error("Unexpected Error", ex);
        return buildErrorResponse("I encountered a technical issue. Please contact support if this persists.");
    }

    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity<ApiResponse<HelpResponseDTO>> handleBadRequest(IllegalArgumentException ex) {
        log.warn("Bad Request: {}", ex.getMessage());
        return buildErrorResponse(ex.getMessage());
    }

    private ResponseEntity<ApiResponse<HelpResponseDTO>> buildErrorResponse(String message) {
        // Construct a safe "Chatbot Response" so the UI doesn't break
        HelpResponseDTO safeBotResponse = HelpResponseDTO.builder()
                .responseType("TEXT_REPLY")
                .botReply("⚠️ **Error:** " + message)
                .build();

        return ResponseEntity.status(HttpStatus.OK) // Return 200 OK so frontend renders the bot message
                .body(ApiResponse.success(safeBotResponse));
    }

}












// models 




package com.fincore.helpservice.model;

import jakarta.persistence.*;
import lombok.Data;

@Entity
@Table(name = "HELP_FAQ_MASTER")
@Data
public class HelpFaqEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "FAQ_ID")
    private Long faqId;

    @Column(name = "QUESTION_TEXT", length = 1000)
    private String questionText;

    @Column(name = "ANSWER_CONTENT", length = 4000)
    private String answerContent;

    @Column(name = "VIEW_COUNT")
    private Long viewCount;

    @Column(name = "IS_ACTIVE", length = 1)
    private String isActive;
}













package com.fincore.helpservice.model;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.time.LocalDateTime;

/**
 * Maps to 'HELP_INTERACTION_LOGS'.
 * Crucial for banking compliance to track exactly what the AI told the user.
 */
@Entity
@Table(name = "HELP_INTERACTION_LOGS")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class HelpInteractionLogEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "LOG_ID")
    private Long logId;

    @Column(name = "USER_ID")
    private String userId;

    @Column(name = "SOURCE_ENGINE") // e.g., AI_RAG, SQL_MODULE, UNKNOWN
    private String sourceEngine;

    @Column(name = "USER_MESSAGE", length = 2000)
    private String userMessage;

    @Column(name = "RESPONSE_TYPE") // e.g., ANSWERED, NO_MATCH, ESCALATION
    private String responseType;

    @Column(name = "CONFIDENCE_SCORE")
    private Integer confidenceScore;

    @Column(name = "IS_HELPFUL") // Populated later via the UI Thumbs Up/Down
    private Boolean isHelpful;

    @Column(name = "CREATED_AT")
    private LocalDateTime createdAt;
}













package com.fincore.helpservice.model;

import jakarta.persistence.*;
import lombok.Data;

/**
 * Maps to the Oracle DB table 'HELP_QUESTION_MASTER'.
 * This is the source of truth that gets ingested into the Redis Vector database.
 */
@Entity
@Table(name = "HELP_QUESTION_MASTER")
@Data
public class HelpQuestionEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "QUESTION_ID")
    private Long questionId;

    @Column(name = "SCREEN_NAME")
    private String screenName;

    @Column(name = "QUESTION_TEXT", length = 1000)
    private String questionText;

    @Column(name = "ANSWER_CONTENT", length = 4000)
    private String answerContent;

    // e.g., "5" for Create CGL. Null means it's a Global/General question.
    @Column(name = "PERMISSION_ID")
    private Long permissionId;

    @Column(name = "ACTION_LINK")
    private String actionLink;

    @Column(name = "ACTION_LABEL")
    private String actionLabel;

    @Column(name = "PRO_TIP", length = 1000)
    private String proTip;

    @Column(name = "IS_ACTIVE", length = 1)
    private String isActive;
}














package com.fincore.helpservice.model;

import jakarta.persistence.*;
import lombok.Data;

/**
 * Maps to the Oracle DB table 'KNOWLEDGE_BASE_MASTER'.
 * Stores long-form conceptual banking rules, definitions, and workflows.
 */
@Entity
@Table(name = "KNOWLEDGE_BASE_MASTER")
@Data
public class KnowledgeBaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "DOC_ID")
    private Long docId;

    @Column(name = "TOPIC", length = 255)
    private String topic;

    @Column(name = "CONTENT_PARAGRAPH", length = 4000)
    private String contentParagraph;

    // Can be null if it's a global concept (like "What is a CGL?")
    @Column(name = "PERMISSION_ID")
    private Long permissionId;

    @Column(name = "IS_ACTIVE", length = 1)
    private String isActive;
}















package com.fincore.helpservice.model;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.Data;

@Data
@Entity
@Table(name = "PERMISSIONS")
public class PermissionEntity {

    @Id
    @Column(name = "MENU_ID")
    private Integer menuId;

    @Column(name = "MENU_TITLE") // e.g. "CGL Management"
    private String menuTitle;

    @Column(name = "MENU_ACTION") // e.g. "view|create|modify"
    private String menuAction;

    @Column(name = "MENU_URL")
    private String menuUrl;

}















package com.fincore.helpservice.model;

import jakarta.persistence.*;
import lombok.Data;

@Data
@Entity
@Table(name = "ROLE_PERMISSIONS")
@IdClass(RolePermissionId.class)
public class RolePermissionEntity {
    @Id
    @Column(name = "ROLE_ID")
    private Integer roleId;

    @Id
    @Column(name = "PERMISSION_ID")
    private Integer permissionId;
}




package com.fincore.helpservice.model;


import lombok.Data;

import java.io.Serializable;

@Data
class RolePermissionId implements Serializable {
    private Integer roleId;
    private Integer permissionId;
}







// repo

package com.fincore.helpservice.repository;

import com.fincore.helpservice.model.HelpFaqEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface HelpFaqRepository extends JpaRepository<HelpFaqEntity, Long> {
    // Fetch Top 10 most popular active FAQs to display in the Quick Actions menu
    List<HelpFaqEntity> findTop10ByIsActiveOrderByViewCountDesc(String isActive);

    Optional<HelpFaqEntity> findByQuestionTextAndIsActive(String questionText, String isActive);
}






package com.fincore.helpservice.repository;

import com.fincore.helpservice.model.HelpInteractionLogEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface HelpInteractionLogRepository extends JpaRepository<HelpInteractionLogEntity, Long> {
    // Standard save and findById methods are auto-implemented by Spring
}









package com.fincore.helpservice.repository;


import com.fincore.helpservice.model.HelpQuestionEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface HelpQuestionRepository extends JpaRepository<HelpQuestionEntity, String> {


    // Used by DocumentIngestionService to load all active data into Redis
    List<HelpQuestionEntity> findByIsActive(String isActive);

    // Used by HelpController for fast, static UI module buttons
    List<HelpQuestionEntity> findByScreenNameAndIsActive(String screenName, String isActive);

    // Used by HelpController for the Global FAQs tab
    @Query("SELECT q FROM HelpQuestionEntity q WHERE q.permissionId IS NULL AND q.isActive = 'Y'")
    List<HelpQuestionEntity> findGlobalFaqs();

}










package com.fincore.helpservice.repository;

import com.fincore.helpservice.model.KnowledgeBaseEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface KnowledgeBaseRepository extends JpaRepository<KnowledgeBaseEntity, Long> {

    // Used by DocumentIngestionService to load active paragraphs
    List<KnowledgeBaseEntity> findByIsActive(String isActive);
}










package com.fincore.helpservice.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Manages the "3-Strike" Escalation Engine.
 * If the AI fails to answer a user's question multiple times in a row,
 * this service triggers the IT Support handoff.
 */
@Service
@Slf4j
public class ChatSessionService {

    // In-memory strike counter mapped by UserId.
    private final Map<String, Integer> userStrikes = new ConcurrentHashMap<>();

    private static final int MAX_STRIKES = 3;

    public boolean isEscalationRequired(String userId) {
        int currentStrikes = userStrikes.getOrDefault(userId, 0);
        return currentStrikes >= MAX_STRIKES;
    }

    public void addStrikes(String userId, int count) {
        int newStrikes = userStrikes.getOrDefault(userId, 0) + count;
        userStrikes.put(userId, newStrikes);
        log.warn("[SESSION] User {} gained a strike. Current strikes: {}/{}", userId, newStrikes, MAX_STRIKES);
    }

    public void resetStrikes(String userId) {
        if (userStrikes.containsKey(userId)) {
            userStrikes.remove(userId);
            log.debug("[SESSION] User {} chat strikes reset to 0 due to successful AI response.", userId);
        }
    }
}









package com.fincore.helpservice.service;

import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.model.KnowledgeBaseEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.fincore.helpservice.repository.KnowledgeBaseRepository;
import dev.langchain4j.data.document.Document;
import dev.langchain4j.data.document.Metadata;
import dev.langchain4j.data.document.splitter.DocumentSplitters;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

import static java.util.Collections.singletonList;

/**
 * Handles converting ALL Oracle DB text (Procedural + Conceptual)
 * into AI Mathematical Vectors using LangChain4j and Redis.
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class DocumentIngestionService {

    private final HelpQuestionRepository questionRepository;
    private final KnowledgeBaseRepository knowledgeBaseRepository;
    private final HelpFaqRepository faqRepository;

    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> embeddingStore;

    @EventListener(ApplicationReadyEvent.class)
    public void ingestKnowledgeBase() {
        log.info("[AI-INGEST] Starting Knowledge Ingestion to Redis via mxbai-embed...");

        List<Document> allDocuments = new ArrayList<>();

        // ---------------------------------------------------------
        // 1. INGEST PROCEDURAL DATA (Help Questions & UI Buttons)
        // ---------------------------------------------------------
        List<HelpQuestionEntity> questions = questionRepository.findByIsActive("Y");
        for (HelpQuestionEntity q : questions) {
            String content = "Module: " + (q.getScreenName() != null ? q.getScreenName() : "General") +
                    "\nQuestion: " + q.getQuestionText() +
                    "\nAnswer: " + q.getAnswerContent() +
                    (q.getProTip() != null ? "\nPro Tip: " + q.getProTip() : "");

            String permId = q.getPermissionId() != null ? String.valueOf(q.getPermissionId()) : "GLOBAL";

            Metadata metadata = new Metadata()
                    .put("permissionId", permId)
                    .put("actionLink", q.getActionLink() != null ? q.getActionLink() : "NONE")
                    .put("actionLabel", q.getActionLabel() != null ? q.getActionLabel() : "NONE")
                    .put("dataType", "PROCEDURAL");

            allDocuments.add(Document.from(content, metadata));
        }

        // ---------------------------------------------------------
        // 2. INGEST CONCEPTUAL DATA (Knowledge Base Paragraphs)
        // ---------------------------------------------------------
        List<KnowledgeBaseEntity> knowledgeBase = knowledgeBaseRepository.findByIsActive("Y");
        for (KnowledgeBaseEntity kb : knowledgeBase) {
            String content = "Topic: " + kb.getTopic() +
                    "\nInformation: " + kb.getContentParagraph();

            String permId = kb.getPermissionId() != null ? String.valueOf(kb.getPermissionId()) : "GLOBAL";

            // Conceptual data doesn't have UI action buttons, so we default to NONE
            Metadata metadata = new Metadata()
                    .put("permissionId", permId)
                    .put("actionLink", "NONE")
                    .put("actionLabel", "NONE")
                    .put("dataType", "CONCEPTUAL");

            allDocuments.add(Document.from(content, metadata));
        }

        // ---------------------------------------------------------
        // 2. INGEST FAQs (Knowledge Base Paragraphs)
        // ---------------------------------------------------------
        List<HelpFaqEntity> faqs = faqRepository.findAll();
        for (HelpFaqEntity faq : faqs) {
            if ("Y".equals(faq.getIsActive())) {
                String content = "FAQ Question: " + faq.getQuestionText() + "\nAnswer: " + faq.getAnswerContent();
                Metadata metadata = new Metadata().put("permissionId", "GLOBAL") // FAQs are Global
                        .put("actionLink", "NONE").put("actionLabel", "NONE").put("dataType", "FAQ");
                allDocuments.add(Document.from(content, metadata));
            }
        }

        // ---------------------------------------------------------
        // 3. CHUNK AND SAVE TO REDIS
        // ---------------------------------------------------------
        if (!allDocuments.isEmpty()) {
            // Split long documents into overlapping 300-token chunks
            List<TextSegment> segments = DocumentSplitters.recursive(300, 50).splitAll(allDocuments);
            log.info("[AI-INGEST] Chunked {} raw DB records into {} mathematical segments.", allDocuments.size(), segments.size());

            // Generate Vectors via Ollama
            List<Embedding> embeddings = embeddingModel.embedAll(segments).content();

            // FIX GAP 1: Deterministic IDs to prevent Redis duplication on restart
            for (int i = 0; i < segments.size(); i++) {
                TextSegment segment = segments.get(i);
                Embedding vector = embeddings.get(i);

                // Generate a unique, repeatable ID based on the Data Type and Permission
                String dataType = segment.metadata().getString("dataType");
                String perm = segment.metadata().getString("permissionId");

                // Example ID: "PROCEDURAL_5_chunk_0", "CONCEPTUAL_GLOBAL_chunk_1"
                String deterministicId = dataType + "_" + perm + "_chunk_" + i;

                // Save one by one using the explicit ID
                embeddingStore.addAll(
                        singletonList(deterministicId),
                        singletonList(vector),
                        singletonList(segment)
                );
            }
            log.info("[AI-INGEST] Successfully saved/overwritten {} vectors to Redis Stack.", segments.size());

        } else {
            log.warn("[AI-INGEST] No active documents found in Oracle DB to ingest!");
        }
    }
}












package com.fincore.helpservice.service;

import com.fincore.helpservice.dto.HelpResponseDTO;
import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.message.AiMessage;
import dev.langchain4j.data.message.SystemMessage;
import dev.langchain4j.data.message.UserMessage;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.memory.ChatMemory;
import dev.langchain4j.memory.chat.MessageWindowChatMemory;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingMatch;
import dev.langchain4j.store.embedding.EmbeddingSearchRequest;
import dev.langchain4j.store.embedding.EmbeddingSearchResult;
import dev.langchain4j.store.embedding.EmbeddingStore;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

/**
 * THE RAG ENGINE (LangChain4j Implementation)
 * Orchestrates Vector Search, Dynamic Prompting, and Generative AI (Phi-3).
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class FinCoreChatAgent {

    private static final String FAILURE_MSG = "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.";
    private final ChatLanguageModel chatClient;
    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> vectorStore;
    private final PermissionService permissionService;
    private final ChatSessionService sessionService;
    private final HelpAnalyticsService analyticsService;
    private final HelpQuestionRepository questionRepository;
    private final HelpFaqRepository faqRepository;
    // Session-based Chat Memory (Sessions expire after 30 minutes of inactivity.)
    private final Cache<String, ChatMemory> userMemories = Caffeine.newBuilder()
            .expireAfterAccess(30, TimeUnit.MINUTES)
            .maximumSize(10000) // Max 10,000 concurrent active chat sessions
            .build();
    // Add this variable near the top of your class
    private Embedding smallTalkAnchor;

    // Run this once when Spring Boot starts
    @PostConstruct
    public void initSemanticRouter() {
        log.info("[SEMANTIC-ROUTER] Initializing Small Talk mathematical anchor...");
        // We define the pure concept of small talk.
        String smallTalkConcept = "hello hi hey greetings good morning good afternoon what is up whats up how are you doing who are you thank you thanks";
        this.smallTalkAnchor = embeddingModel.embed(smallTalkConcept).content();
    }

    public HelpResponseDTO handleChat(String userId, String roleId, String userMessage, String currentScreen) {
        log.info("[AI-CHAT] Processing query for User: {}", userId);

        try {
            // ========================================================================
            // 0. GUIDED MENUS (System Slash Commands)
            // ========================================================================
            if ("/action faq".equalsIgnoreCase(userMessage.trim())) {
                List<String> faqQuestions = faqRepository.findTop10ByIsActiveOrderByViewCountDesc("Y")
                        .stream().map(HelpFaqEntity::getQuestionText).collect(Collectors.toList());

                return HelpResponseDTO.builder()
                        .responseType("SUGGESTION")
                        .botReply("Here are a few frequently asked questions:")
                        .items(faqQuestions)
                        .build();
            }

            if (userMessage.trim().startsWith("/action module")) {
                String requestedScreen = userMessage.replace("/action module", "").trim();
                List<String> moduleQuestions = questionRepository.findByScreenNameAndIsActive(requestedScreen, "Y")
                        .stream().map(HelpQuestionEntity::getQuestionText).collect(Collectors.toList());

                if (moduleQuestions.isEmpty()) {
                    return HelpResponseDTO.builder()
                            .responseType("TEXT_REPLY")
                            .botReply("I don't have predefined questions for " + requestedScreen + ", but feel free to ask me anything about it!")
                            .build();
                }

                return HelpResponseDTO.builder()
                        .responseType("SUGGESTION")
                        .botReply("Here are a few common questions for " + requestedScreen + ":")
                        .items(moduleQuestions)
                        .build();
            }

            // ========================================================================
            // 1. RAG AI PIPELINE (For regular typed questions or clicked suggestions)
            // ========================================================================

            // ==========================================
            // 2. QUERY PRE-CLEANING (Noise Reduction)
            // ==========================================
            String cleanedQuery = userMessage
                    .replaceAll("(?i)\\b(hi|hello|hey|greetings|dear)\\b", "")
                    .replaceAll("[^a-zA-Z0-9\\s?]", "") // Remove weird special characters, keep question marks
                    .trim();

            log.debug("[AI-CHAT] Original: '{}' | Cleaned: '{}'", userMessage, cleanedQuery);


            // 1. ESCALATION CHECK
            if (sessionService.isEscalationRequired(userId)) {
                log.warn("[AI-CHAT] User {} requires IT escalation.", userId);
                sessionService.resetStrikes(userId);
                return HelpResponseDTO.builder()
                        .responseType("ESCALATION_OFFER")
                        .botReply("I seem to be having trouble helping you today. Would you like me to raise an IT Support Ticket with your chat history attached?")
                        .build();
            }

            // ==========================================
            // 4. VECTOR SEARCH WITH HARD THRESHOLD
            // ==========================================
            List<String> allowedPerms = permissionService.getAllAllowedPermissionIdsForRole(roleId)
                    .stream().map(String::valueOf).collect(Collectors.toList());
            allowedPerms.add("GLOBAL");

            String enhancedSearchQuery = cleanedQuery;
            if (currentScreen != null && !currentScreen.isEmpty()) {
                enhancedSearchQuery = cleanedQuery + " regarding the " + currentScreen + " screen.";
            }

            // 3. EXECUTE SECURE VECTOR SEARCH
            // Convert user text to vector using mxbai
            Embedding queryEmbedding = embeddingModel.embed(userMessage).content();

            EmbeddingSearchRequest searchRequest = EmbeddingSearchRequest.builder()
                    .queryEmbedding(queryEmbedding)
                    .maxResults(30)
                    .minScore(0.45) // Lowered to 0.45. We let the LLM do the final filtering.
                    .build();

            EmbeddingSearchResult<TextSegment> searchResult = vectorStore.search(searchRequest);

            // Stream Filter & Track Highest Confidence Score
            double highestScore = 0.0;
            List<EmbeddingMatch<TextSegment>> matches = searchResult.matches().stream()
                    .filter(match -> allowedPerms.contains(match.embedded().metadata().getString("permissionId")))
                    .limit(3)
                    .collect(Collectors.toList());

            if (!matches.isEmpty()) {
                highestScore = matches.get(0).score(); // Capture confidence for analytics!
            }

            // ==========================================
            // 5. DETERMINISTIC GUARD (Bypass LLM entirely!)
            // ==========================================
            if (matches.isEmpty()) {
                log.info("[AI-CHAT] No context found. Applying Hybrid Router.");

                // We pass the mathematical vector of what the user typed into our NLP classifier
                // Pass BOTH the cleaned string and the mathematical vector
                if (isSmallTalk(userMessage, queryEmbedding)) {
                    Long logId = analyticsService.logChatInteraction(userId, "JAVA_ROUTER", userMessage, "SMALL_TALK", 100);
                    return HelpResponseDTO.builder()
                            .responseType("TEXT_REPLY")
                            .botReply("Hello! I am the FinCore Smart Assistant developed by Shubhankar. How can I help you with your banking needs today?")
                            .logId(logId)
                            .build();
                }

                // If it is NOT small talk, and NOT in the database -> Fast Fail
                sessionService.addStrikes(userId, 1);
                Long failLogId = analyticsService.logChatInteraction(userId, "SEMANTIC_ROUTER", userMessage, "NO_MATCH", 0);
                return HelpResponseDTO.builder()
                        .responseType("NO_MATCH")
                        .botReply(FAILURE_MSG)
                        .logId(failLogId)
                        .build();
            }


            // ==========================================
            // 6. GENERATIVE AI EXECUTION
            // ==========================================
            StringBuilder contextBuilder = new StringBuilder();
            String primaryActionLink = null;
            String primaryActionLabel = null;

            for (EmbeddingMatch<TextSegment> match : matches) {
                contextBuilder.append("- ").append(match.embedded().text()).append("\n\n");
                if (primaryActionLink == null) {
                    String link = match.embedded().metadata().getString("actionLink");
                    if (!"NONE".equals(link)) {
                        primaryActionLink = link;
                        primaryActionLabel = match.embedded().metadata().getString("actionLabel");
                    }
                }
            }

            // 5. DYNAMIC PROMPT INJECTION
            String liveEtlDate = permissionService.getLiveEtlDate();
            String currentTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("EEEE, MMMM dd, yyyy - hh:mm a"));
            String currentScreenContext = (currentScreen != null && !currentScreen.isEmpty()) ? currentScreen : "Unknown";

            // We inject the Screen Context here so the LLM knows it, without ruining the mathematical search!
            String dynamicPrompt = """
                     You are the FinCore Smart Assistant, an AI banking bot.
                     Current Time: %s
                     System ETL Date: %s
                     User's Current Screen: %s
                    
                     RULES:
                     1. Answer the user's question using ONLY the [BANKING CONTEXT] below.
                     2. Be direct, professional, and use HTML tags like <b> for formatting.
                     3. Do NOT explain your thought process.
                     4. If the context does not fully answer the question, reply EXACTLY: '%s'
                    
                    [BANKING CONTEXT]
                     %s
                    """.formatted(currentTime, liveEtlDate, currentScreenContext, FAILURE_MSG, contextBuilder.toString());

            ChatMemory memory = userMemories.get(userId, k -> MessageWindowChatMemory.withMaxMessages(5));
            memory.add(UserMessage.from(userMessage));

            log.info("[AI-CHAT] Sending Context to Phi-3 LLM. Confidence Score: {}", highestScore);
            AiMessage responseMessage = chatClient.generate(
                    SystemMessage.from(dynamicPrompt),
                    memory.messages().get(memory.messages().size() - 1)
            ).content();

            String aiResponse = responseMessage.text();

            if (aiResponse.contains("I cannot find this information") || aiResponse.contains(FAILURE_MSG)) {
                sessionService.addStrikes(userId, 1);
                Long failLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "NO_MATCH", (int) (highestScore * 100));
                memory.add(AiMessage.from(FAILURE_MSG));
                return HelpResponseDTO.builder().responseType("NO_MATCH").botReply(FAILURE_MSG).logId(failLogId).build();
            }

            sessionService.resetStrikes(userId);
            memory.add(responseMessage);

            // Pass the Redis Math Score to your Database Analytics!
            Long successLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "ANSWERED", (int) (highestScore * 100));

            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply(aiResponse.trim())
                    .navigationLink(primaryActionLink)
                    .navigationLabel(primaryActionLabel)
                    .logId(successLogId)
                    .build();

        } catch (Exception e) {
            log.error("[AI-CHAT] Critical AI Generation Failure", e);
            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply("I am currently experiencing a cognitive delay. Please try again in a moment.")
                    .build();
        }
    }

    /**
     * HYBRID INTENT CLASSIFIER
     * Uses Regex mxbai-embed-large to mathematically compare the user's sentence
     * against the concept of "Small Talk".
     */
    private boolean isSmallTalk(String userMessage, Embedding userEmbedding) {
        String q = userMessage.toLowerCase().trim();
        if (q.isEmpty()) return true;

        // Expanded Regex: Catches hi, hii, hiii, hey, heyy, and common questions.
        if (q.matches(".*\\b(how are you|who are you|who built you|what is your name|what time is it|thanks|thank you|hello|hi+|hey+|greetings)\\b.*")) {
            log.info("[ROUTER] Caught by Regex.");
            return true;
        }

        float[] vectorA = userEmbedding.vector();
        float[] vectorB = this.smallTalkAnchor.vector();
        double dotProduct = 0.0, normA = 0.0, normB = 0.0;

        for (int i = 0; i < vectorA.length; i++) {
            dotProduct += vectorA[i] * vectorB[i];
            normA += vectorA[i] * vectorA[i];
            normB += vectorB[i] * vectorB[i];
        }

        double cosineSimilarity = dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        log.info("[ROUTER] Semantic Score: {}%", (int) (cosineSimilarity * 100));

        // Dropped to 0.65 to be slightly more forgiving of typos
        return cosineSimilarity > 0.65;
    }

    public void incrementFaqPopularity(String questionText) {
        faqRepository.findByQuestionTextAndIsActive(questionText, "Y").ifPresent(faq -> {
            faq.setViewCount(faq.getViewCount() + 1);
            faqRepository.save(faq);
        });
    }
}











package com.fincore.helpservice.service;

import com.fincore.helpservice.model.HelpInteractionLogEntity;
import com.fincore.helpservice.repository.HelpInteractionLogRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;

/**
 * Handles the Oracle Database Audit Trail.
 * Records every AI interaction and processes the UI Thumbs Up/Down feedback.
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class HelpAnalyticsService {

    private final HelpInteractionLogRepository logRepository;

    /**
     * Logs the chat attempt and returns the DB Primary Key (LogId).
     * This ID is sent to the frontend so the user can rate this specific answer.
     */
    @Transactional
    public Long logChatInteraction(String userId, String sourceEngine, String userMessage, String responseType, int confidenceScore) {
        try {
            HelpInteractionLogEntity logEntity = HelpInteractionLogEntity.builder()
                    .userId(userId)
                    .sourceEngine(sourceEngine)
                    .userMessage(userMessage)
                    .responseType(responseType)
                    .confidenceScore(confidenceScore)
                    .createdAt(LocalDateTime.now())
                    .build();

            logEntity = logRepository.save(logEntity);
            log.debug("[ANALYTICS] Saved interaction log for user {} with LogID {}", userId, logEntity.getLogId());

            return logEntity.getLogId();

        } catch (Exception e) {
            log.error("[ANALYTICS] Failed to save interaction log to Oracle DB.", e);
            return null; // Don't crash the chat just because logging failed
        }
    }

    /**
     * Called when the user clicks the Thumbs Up or Thumbs Down button in the UI.
     */
    @Transactional
    public void updateFeedback(Long logId, boolean isHelpful) {
        if (logId == null) return;

        logRepository.findById(logId).ifPresentOrElse(logEntity -> {
            logEntity.setIsHelpful(isHelpful);
            logRepository.save(logEntity);
            log.info("[ANALYTICS] LogID {} marked as helpful: {}", logId, isHelpful);
        }, () -> log.warn("[ANALYTICS] Received feedback for unknown LogID: {}", logId));
    }
}












package com.fincore.helpservice.service;

import com.fincore.helpservice.repository.PermissionRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class PermissionService {

    private final JdbcTemplate jdbcTemplate;

    /**
     * Used by the Vector Store to filter which documents the user is mathematically allowed to search.
     * Returns a list of Permission IDs (e.g., ["5", "6", "12"])
     */
    public List<String> getAllAllowedPermissionIdsForRole(String roleId) {
        String sql = "SELECT CAST(p.MENU_ID AS VARCHAR2(50)) FROM PERMISSIONS p JOIN ROLE_PERMISSIONS rp ON p.MENU_ID = rp.PERMISSION_ID WHERE rp.ROLE_ID = ?";
        return jdbcTemplate.queryForList(sql, String.class, roleId);
    }

    /**
     * Used by the Dynamic Prompt Injection so Phi-3 knows what the user is capable of doing.
     * Returns a list of human-readable action names (e.g., ["Create CGL", "Approve CGL"])
     */
    public List<String> getAllowedActionNamesForRole(String roleId) {
        String sql = "SELECT COALESCE(p.MENU_SUBMENU, p.MENU_TITLE) FROM PERMISSIONS p JOIN ROLE_PERMISSIONS rp ON p.MENU_ID = rp.PERMISSION_ID WHERE rp.ROLE_ID = ?";
        return jdbcTemplate.queryForList(sql, String.class, roleId);
    }


    /**
     * LIVE DATA INJECTION: Prevents stale vectors by fetching ETL date at query time.
     */
    public String getLiveEtlDate() {
        try {
            String sql = "SELECT TO_CHAR(ETL_DATE, 'DD-Mon-YYYY') FROM FINCORE_DATE FETCH FIRST 1 ROWS ONLY";
            return jdbcTemplate.queryForObject(sql, String.class);
        } catch (Exception e) {
            log.warn("Could not fetch ETL Date", e);
            return "System Date Unavailable";
        }
    }

}












package com.fincore.helpservice;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cache.annotation.EnableCaching;

@SpringBootApplication
@EnableCaching
public class HelpServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(HelpServiceApplication.class, args);
    }

}







application.properties :

# ==============================================================
# FIN CORE - HELP SERVICE CONFIGURATION
# ==============================================================
spring.application.name=HelpService
server.port=9099

# --- ORACLE DATABASE ---
spring.datasource.url=jdbc:oracle:thin:@10.177.103.192:1523/fincorepdb1
spring.datasource.username=fincore
spring.datasource.password=Password#1234
spring.datasource.driver-class-name=oracle.jdbc.OracleDriver

# --- JPA / HIBERNATE ---
spring.jpa.show-sql=false
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.open-in-view=false

# --- REDIS CACHE ---
spring.data.redis.host=10.0.17.242
spring.data.redis.port=6379
spring.cache.type=redis
# Cache time-to-live (1 Hour) - Refresh help content every hour
spring.cache.redis.time-to-live=3600000

# --- LOGGING ---
logging.level.com.fincore.HelpService=INFO

# --- Security ---
jwt.secret=bWV0aGlvbnlsdGhyZW9ueWx0aHJlb255bGdsdXRhbWlueWxhbGFueWw=


# DB Timeouts: Configuration of connection pooling timeouts in application.properties.
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.maximum-pool-size=30

# --- Actuator Base Config ---
# Enable the endpoints, but control exposure in specific profile files
management.endpoints.web.base-path=/actuator
management.endpoint.health.probes.enabled=true
management.endpoints.web.exposure.include=health, info, prometheus
management.endpoint.health.show-details=always
management.metrics.tags.application=${spring.application.name}
management.info.env.enabled=true


# ==============================================================
# RESILIENCE4J CONFIGURATION (Global Rules)
# ==============================================================
# --- 1. RETRY STRATEGY ---
# A. RETRY ON THESE (Transient / "Blips")
# 1. Spring's wrapper for DB Timeouts, Deadlocks, Connection Drops
resilience4j.retry.instances.defaultService.retry-exceptions[0]=org.springframework.dao.TransientDataAccessException
# 2. Connection failure at start of transaction
resilience4j.retry.instances.defaultService.retry-exceptions[1]=org.springframework.transaction.CannotCreateTransactionException
# 3. DB Resource Failure (DB Down)
resilience4j.retry.instances.defaultService.retry-exceptions[2]=org.springframework.dao.DataAccessResourceFailureException
# 4. Network I/O errors (for Feign/RestCalls)
resilience4j.retry.instances.defaultService.retry-exceptions[3]=java.io.IOException
resilience4j.retry.instances.defaultService.retry-exceptions[4]=java.net.ConnectException
resilience4j.retry.instances.defaultService.retry-exceptions[5]=java.net.SocketTimeoutException

# B. DO NOT RETRY ON THESE (Logic / Permanent Errors)
# Even if these happen, we fail immediately so GlobalExceptionHandler can return 400/409
resilience4j.retry.instances.defaultService.ignore-exceptions[0]=java.lang.IllegalArgumentException
resilience4j.retry.instances.defaultService.ignore-exceptions[1]=java.lang.NullPointerException
resilience4j.retry.instances.defaultService.ignore-exceptions[2]=org.springframework.dao.DataIntegrityViolationException
resilience4j.retry.instances.defaultService.ignore-exceptions[3]=org.springframework.dao.DuplicateKeyException
resilience4j.retry.instances.defaultService.ignore-exceptions[4]=org.springframework.web.client.HttpClientErrorException

# --- 2. CIRCUIT BREAKER STRATEGY ---
# If 50% of requests fail, OPEN the circuit (Fail Fast)
resilience4j.circuitbreaker.instances.defaultService.failure-rate-threshold=50
# Wait 10 seconds before trying again (Half-Open state)
resilience4j.circuitbreaker.instances.defaultService.wait-duration-in-open-state=10s
# Must have at least 5 calls to calculate failure rate
resilience4j.circuitbreaker.instances.defaultService.minimum-number-of-calls=5
# When Half-Open, allow 3 test calls to see if backend is up
resilience4j.circuitbreaker.instances.defaultService.permitted-number-of-calls-in-half-open-state=3
# Automatically move from Open to Half-Open
resilience4j.circuitbreaker.instances.defaultService.automatic-transition-from-open-to-half-open-enabled=true




# ==============================================================
#                           AI CONFIGS
# ==============================================================
#
## Ollama Configuration
#spring.ai.ollama.base-url=http://localhost:11434
#spring.ai.ollama.chat.model=phi3-mini
#spring.ai.ollama.chat.options.temperature=0.1
#spring.ai.ollama.embedding.model=mxbai-embed
#
## Redis Vector Store Configuration
#spring.ai.vectorstore.redis.uri=redis://localhost:6380
#spring.ai.vectorstore.redis.index=fincore-help-index
#spring.ai.vectorstore.redis.prefix=fincore:doc:
#
## Web MVC Async Settings - 30 SEC LATER
#spring.mvc.async.request-timeout=90000
#


# Base URL and Model
# Ollama Connection
langchain4j.ollama.base-url=http://10.0.26.102:11434
langchain4j.ollama.chat-model.name=phi3-mini
langchain4j.ollama.chat-model.temperature=0.1
langchain4j.ollama.embedding-model.name=mxbai-embed

# Redis Vector Store (Port 6380)
langchain4j.vector-store.redis.host=localhost
langchain4j.vector-store.redis.port=6380
langchain4j.vector-store.redis.index-name=fincore-help-index
langchain4j.vector-store.redis.prefix=fincore:doc:
langchain4j.vector-store.redis.dimension=1024


## Web MVC Async Settings - TODO 30 SEC LATER
spring.mvc.async.request-timeout=180000












pom.xml :

<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.3.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.fincore</groupId>
    <artifactId>HelpService</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>HelpService</name>
    <description>HelpService</description>
    <url/>
    <licenses>
        <license/>
    </licenses>
    <developers>
        <developer/>
    </developers>
    <scm>
        <connection/>
        <developerConnection/>
        <tag/>
        <url/>
    </scm>
    <properties>
        <java.version>21</java.version>
    </properties>


    <dependencies>
        <!-- Core Web -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- Persistence -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>com.oracle.database.jdbc</groupId>
            <artifactId>ojdbc11</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- Caching (Redis) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <!-- Tools -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>

        <dependency>
            <groupId>com.fincore</groupId>
            <artifactId>common-utilities</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>net.logstash.logback</groupId>
            <artifactId>logstash-logback-encoder</artifactId>
            <version>7.4</version>
        </dependency>

        <!-- health metrics -->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-registry-prometheus</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>


<!--        &lt;!&ndash; Apache OpenNLP for POS Tagging & Tokenization &ndash;&gt;-->
<!--        <dependency>-->
<!--            <groupId>org.apache.opennlp</groupId>-->
<!--            <artifactId>opennlp-tools</artifactId>-->
<!--            <version>2.3.0</version>-->
<!--        </dependency>-->

        <!-- Apache Commons Lang for optimized Levenshtein Distance -->
<!--        <dependency>-->
<!--            <groupId>org.apache.commons</groupId>-->
<!--            <artifactId>commons-lang3</artifactId>-->
<!--            <version>3.18.0</version>-->
<!--        </dependency>-->

        <!-- Source: https://mvnrepository.com/artifact/org.apache.commons/commons-text -->
<!--        <dependency>-->
<!--            <groupId>org.apache.commons</groupId>-->
<!--            <artifactId>commons-text</artifactId>-->
<!--            <version>1.15.0</version>-->
<!--        </dependency>-->

<!--        <dependency>-->
<!--            <groupId>commons-codec</groupId>-->
<!--            <artifactId>commons-codec</artifactId>-->
<!--            <version>1.16.0</version>-->
<!--        </dependency>-->

        <!-- 1. LangChain4j Core -->
        <dependency>
            <groupId>dev.langchain4j</groupId>
            <artifactId>langchain4j</artifactId>
            <version>1.0.0-alpha1</version>
        </dependency>

        <!-- 2. LangChain4j Ollama (To talk to Phi-3 and Mxbai) -->
        <dependency>
            <groupId>dev.langchain4j</groupId>
            <artifactId>langchain4j-ollama</artifactId>
            <version>1.0.0-alpha1</version>
        </dependency>

        <!-- 3. LangChain4j Redis (Core API only - No Starter to prevent Bean clashes) -->
        <dependency>
            <groupId>dev.langchain4j</groupId>
            <artifactId>langchain4j-redis</artifactId>
            <version>1.0.0-alpha1</version>
        </dependency>

        <dependency>
            <groupId>com.github.ben-manes.caffeine</groupId>
            <artifactId>caffeine</artifactId>
        </dependency>



    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.springframework.boot</groupId>
                            <artifactId>spring-boot-configuration-processor</artifactId>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>









db tables :













PERMISSIONS TABLE: (where all screen info is there)

MENU_ID	NUMBER(38,0)	No	"FINCORE"."MENU_ITEMS_SEQ"."NEXTVAL"	1	
MENU_TITLE	VARCHAR2(100 CHAR)	No		2	
MENU_ICON	VARCHAR2(100 CHAR)	Yes		3	
MENU_SUBMENU	VARCHAR2(100 CHAR)	Yes		4	
MENU_ACTION	VARCHAR2(200 CHAR)	No	NULL	5	
MENU_URL	VARCHAR2(200 CHAR)	No		6	
MENU_COMPONENT_PATH	VARCHAR2(200 CHAR)	No		7	
MENU_DESCRIPTION	VARCHAR2(255 BYTE)	No		8	
MENU_DEPENDANT	NUMBER(38,0)	Yes		9	
MAPPED_REQUEST_TYPE	VARCHAR2(50 CHAR)	Yes		10	
MENU_ORDER	VARCHAR2(255 CHAR)	Yes		11	
API_RESOURCE_PATTERN	VARCHAR2(255 CHAR)	Yes		12	"Defines the Backend REST API Endpoint pattern (e.g., /user/**, /cgl*) required to ACCESS data for this screen.
CRITICAL: This is used by the RBAC Filter to grant "Read/View" access.
If NULL, the screen may load blank."


DATA :

1	Circle Management	AccountTree	Manage Circles	view|create|modify|cancel	/circle-management	circle/CircleMaster	To manage circles and view status of self request		CIRCLE		/api/common-master/circle-codes/**,/api/common-master/zone-codes/**
2	Circle Management	Ballot	Circle Requests	view|approve|reject	/circle-requests	common/CommonRequestScreen	To review/approve pending requests for circles created by other user		CIRCLE		/api/common-master/circle-codes/**,/api/common-master/zone-codes/**
5	CGL Management	Casino	Manage CGL's	view|create|modify|cancel	/cgl-management	cgl/CGLMaster	To edit or update active CGLs and to view pending CGL requests		CGL_CODE		/api/common-master/cgl*
6	CGL Management	WorkspacePremium	CGL Requests	view|approve|reject	/cgl-requests	common/CommonRequestScreen	To efficiently review and process the pending requests for CGL master		CGL_CODE		/api/common-master/cgl*
7	Segment Management	Segment	Manage Segments	view|create|modify|cancel	/segment-management	segment/SegmentMaster	To manage segments in application		SEGMENT_CODE		/api/common-master/segment-codes
8	Segment Management	Grading	Segment Requests	view|approve|reject	/segment-requests	common/CommonRequestScreen	To efficiently review and process the pending requests for segment master		SEGMENT_CODE		/api/common-master/segment-codes
9	Branch Management	AccountBalance	Manage Branches	view|create|modify|cancel	/branch-management	branch/BranchMaster	To edit update branches and to check pending branch update requests		BRANCH		/api/common-master/branches*,/api/common-master/branches-check,/api/common-master/states,/api/common-master/circle-codes
10	Branch Management	AssuredWorkload	Branch Requests	view|approve|reject	/branch-requests	common/CommonRequestScreen	To efficiently review and process the pending requests for branch master		BRANCH		/api/common-master/branches*
12	User Management	People	Manage Users	view|create|modify|delete|cancel	/manage-user	user/pages/UserManagement	For creating new user		USER_MANAGEMENT		/api/user/**
13	User Management	WorkspacePremium	User Requests	view|approve|reject	/user-requests	user/pages/UserApprovals	To approve or reject user requests		USER_MANAGEMENT		/api/user/**
14	Calendar Configuration	EditCalendar	Calendar Configuration	view|create|modify|cancel	/calendar-configuration	calendarConfig/CalendarConfig	To manage financial calender configuration in application		CALENDER		/api/common-master/calendar-configuration,/api/common-master/calendar-config/**,/api/calendar-config/next-year-info/**
15	Calendar Configuration	EventAvailable	Calendar Config Requests	view|approve|reject	/calendar-config-requests	common/CommonRequestScreen	To efficiently review and process the pending requests for calender config master		CALENDER		/api/common-master/calendar-configuration
16	State Management	Domain	Manage States	view|create|modify|cancel	/state-management	state/StateMaster	To manage states in application		STATE		/api/common-master/states
17	State Management	DomainVerification	State Requests	view|approve|reject	/state-requests	common/CommonRequestScreen	To efficiently review and process the pending requests for state master		STATE		/api/common-master/states
18	Currency Management	LocalAtm	Manage Currencies	view|create|modify|cancel	/manage-currencies	currency/CurrencyMaster	To manage currency in application		CURRENCY		/api/common-master/currency*
19	Currency Management	CreditScore	Currency Requests	view|approve|reject	/currency-requests	common/CommonRequestScreen	To efficiently review and process the pending requests for currency master		CURRENCY		/api/common-master/currency*
20	Currency Rate Management	PriceChange	Currency Rate Change	view|modify|cancel	/manage-currency-rate	currency/CurrencyRateChange	To manage currency rate in application		CURRENCY_RATE_CHANGE		/api/common-master/currency-rate-change
21	Currency Rate Management	CurrencyRupee	Currency Rate Requests	view|approve|reject	/currency-rate-requests	common/CommonRequestScreen	To efficiently review and process the pending requests for currency rate master		CURRENCY_RATE_CHANGE		/api/common-master/currency-rate-change
22	Role Management	Badge	Manage Roles	view|create|modify|cancel	/manage-roles	role/RoleManagement	To manage roles in application		ROLE_MANAGEMENT		/api/role/**
23	Role Management	Elevator	Role Management Requests	view|approve|reject	/role-requests	role/RoleApprovals	To approve/reject role management related requests		ROLE_MANAGEMENT		/api/role/**
24	User Management	People	User Requests Audit	view	/user-audit	user/pages/UserLogs	Shows user audit requests		USER_MANAGEMENT		/api/user/**
25	Process Status	Memory		view|approve|reject|download|start|terminate|stop|restart|finish	/process-status	process-status/ProcessStatusPage	This is demo description				/api/processes/**,/api/airflow/**,/api/reports/**
26	Reports	Summarize	Whole Bank Reports	view|download	/reports	glifReports/GlifReports	Manage whole bank report handling for various level of users and report types featured.				/api/reports/**
27	Reports	Summarize	Branch Wise Reports	view|download	/branchwise-reports	glifReports/ReportsBranchWise	Manage branch wise report handling for various level of users and report types featured.				/api/reports/**,/api/differences/**
30	Journal Management	EditCalendar	Journal Posting	view|create	/journal-posting	journal/JournalPosting	This is demo description		JOURNAL_AUTH		/api/journals/**,/api/cgl-journal/**,/api/branches-journal/**,/api/common-master/currency,/api/**
31	Journal Management	Ballot	Journal Authorization	view|approve|reject	/journal-Authorization	journal/JournalAuthorization	This is demo description		JOURNAL_AUTH		/api/journals/**,/api/cgl-journal/**,/api/branches-journal/**
32	Journal Management	Ballot	Journal Posting Status	view|cancel	/journal-posting-status	journal/JournalPostingStatus	to cansel there own Request		JOURNAL_AUTH		/api/journals/**,/api/cgl-journal/**,/api/branches-journal/**
33	Balance Enquiry	AccountBalance		view	/balance-enquiry	balanceEnquiry/BalanceEnquiryScreen	This provides closing balance for each day according to selected range				/api/balance-enquiry/**
34	Transaction Enquiry	ReceiptLong		view	/transaction-enquiry	transaction-enquiry/TransactionEnquiry	This is demo description				/api/transactions*
35	Dashboard	GridView		view	/dashboard	dashboard/DashboardPage	Sample Dashboard screen MUI				/api/notifications/**,/api/dashboard/**
36	Journal Management	UploadFile	Journal Bulk Upload	view|upload	/journal-bulk-upload	journal/JournalBulkUpload	To Upload the Bulk Journals		JOURNAL_AUTH		/api/journals/**,/api/cgl-journal/**,/api/branches-journal/**
37	CGL Management	Visibility	View CGL Details	view	/view-cgl-details	cgl/CGLView	To View CGL details		CGL_CODE		/api/common-master/view-cgl*
38	Branch Management	Visibility	View Branch Details	view	/view-branch-details	branch/BranchView	To View Branch details				/api/common-master/view-branch*
39	Announcement Management	Campaign		view|create|modify|cancel	/announcements	announcements/Announcements	To manage announcements				/api/announcements/**
40	File Type	Topic	File Manager	view|create|modify|cancel|delete	/manage-files	filetype/FileTypeMain	type of file		FILE_TYPE_MASTER		/api/common-master/files
41	File Type	RuleFolder	File Manager Requests	view|approve|reject	/filemanage-requests	common/CommonRequestScreen	To efficiently review and process the pending requests for file manager		FILE_TYPE_MASTER		/api/common-master/files
42	Transfer Data LHO	RuleFolder	Transfer Data LHO	view|create|modify|cancel|delete	/transfer-data-lho	common/TransferDataLho	To efficiently review and process the pending requests for file manager		LHO_TRANSFER		/api/process/processes/data/7
43	Transfer Data LHO	WorkspacePremium	Transfer Data LHO Requests	view|approve|reject	/transfer-data-lho-requests	common/CommonRequestScreen	To approve/reject LHO Data transfer related requests		LHO_TRANSFER		
44	Data-Parameters	Topic	Data Parameters Manager	view|create|modify|cancel|delete	/manage-Data-Parameters	dataParameters/DataParametersmain	To manager		DATA_PARAMETERS		/api/common-master/data-parameters
45	Data-Parameters	RuleFolder	Data Parameters  Manager request	view|approve|reject	/manage-Data-Parameters-requests	common/CommonRequestScreen	To efficiently review and process the pending requests for file manager		DATA_PARAMETERS		/api/common-master/data-parameters
81	Template Management	ReceiptLong	Report Template Manager	view|create|modify|delete|cancel	/template-configuration	reportTemplateManager/pages/TemplateConfiguration	Configure, manage, and monitor your report templates				/api/template-config/**,/api/report-builder/**,/api/create-request/**




















ROLES :


ROLE_ID	NUMBER(10,0)	No	NULL 	1	 Unique identifier for the role
ROLE_NAME	VARCHAR2(255 CHAR)	No		2	 Name of the role
DESCRIPTION	VARCHAR2(255 CHAR)	Yes		3	 Description of the role
ROLE_STATUS	VARCHAR2(255 CHAR)	No	"'ACTIVE'
   "	4	Status of the role ( Active/Blocked)


DATA :

51	UCO	users will be responsible for managing users in fincore system	ACTIVE
52	PSO 	Will be monitoring the applications day to day activities, start or kill any job activity makerchecker can be added for critical activities	ACTIVE
53	FRT 	for whole bank	ACTIVE
54	Branch 	existing branch users rights	ACTIVE
55	Support 	for providing technical support for the application	ACTIVE
56	GLIF 	GLIF and IMPL teams of TCS manage their work in fincore application.	ACTIVE
148	SASANK	Testing	ACTIVE
58	External users	for providing access to other application through API's etc	ACTIVE
150	Dummy	Dummy	ACTIVE
152	JKA	Dummy	ACTIVE
157	FRT	rtrff	ACTIVE
192	Testing new role	testing purpose	ACTIVE
130	STA	TESTING FOR DROPDOWN	ACTIVE
153	OFFICE	Dummy	ACTIVE
60	Developer	For Developer access to build fincore application	ACTIVE
11	F1/BOG 	Finance One and BOG User	ACTIVE
191	Testing	bghbbdzszcb	ACTIVE
10	ADMIN	Administartor access to fincore application	ACTIVE
146	Niharika	Testing role	ACTIVE




ROLE_PERMISSIONS :

ROLE_ID	NUMBER(10,0)	No		1	Foreign key to the ROLES table.
PERMISSION_ID	NUMBER(10,0)	No		2	Foreign key to the PERMISSIONS table.
PERMISSION_ORDER	NUMBER	Yes		3	Storing permission order against each role.


DATA :
192	24	8
192	21	7
192	20	6
192	15	5
192	17	4
192	16	3
192	10	2
192	9	1
190	17	3
190	15	4
190	10	2
190	9	1
154	9	1
154	10	2
153	9	1
153	15	5
153	17	4
153	16	3
153	10	2
151	19	5
151	9	2
151	10	1
151	15	3
151	18	4
149	16	2
149	17	3
149	10	1
147	21	5
147	9	1
147	16	3
147	10	2
147	17	4
130	9	1
130	15	3
130	16	2
60	37	1
60	2	2
60	39	3
60	7	4
60	25	10
60	102	6







FINCORE_DATE : (THIS TABLE CONTAINS THE ETL DATE WHICH IS FOLLOWED MY ETL PIPELINES TO RUN PIPELINE ACCORDINGLY, CHECK IF THIS TABLE CAN INGESTED TO OUR AI, SUPPOSE IF USER ASKS WHAT IS CURRENT ETL DATE FOR THAT)
USERS_DATE	DATE	                No		1	
ETL_DATE	DATE	                No		2	
LAST_UPDATED_DATE	TIMESTAMP(6)	Yes		3	
LAST_UPDATED_IP	VARCHAR2(45 BYTE)	Yes		4	


DATA :

19-12-25	21-11-25	24-02-26 11:38:12.000000000 AM	10.0.19.123











help related tables :

knowledge_base_table:

DOC_ID	NUMBER	No	"FINCORE"."ISEQ$$_78070".nextval	1	
TOPIC	VARCHAR2(255 BYTE)	No		2	
CONTENT_PARAGRAPH	VARCHAR2(4000 BYTE)	No		3	
PERMISSION_ID	NUMBER	Yes		4	
IS_ACTIVE	VARCHAR2(1 BYTE)	Yes	"'Y'
"	5	



data :

1	CGL Maker-Checker Lifecycle	In the FinCore system, Central General Ledgers (CGLs) are governed by a strict Maker-Checker protocol. A user with "Manage CGLs" access (The Maker) can create or modify a CGL. However, the CGL does not become active immediately. It must be reviewed by a different user with "CGL Requests" access (The Checker). The Checker can either approve or reject the modification.		Y






help_question_master :

QUESTION_ID	NUMBER	No	"FINCORE"."ISEQ$$_78061".nextval	1	
SCREEN_NAME	VARCHAR2(255 BYTE)	No		2	
QUESTION_TEXT	VARCHAR2(1000 BYTE)	No		3	
ANSWER_CONTENT	VARCHAR2(4000 BYTE)	No		4	
PERMISSION_ID	NUMBER	Yes		5	
ACTION_LINK	VARCHAR2(255 BYTE)	Yes		6	
ACTION_LABEL	VARCHAR2(255 BYTE)	Yes		7	
PRO_TIP	VARCHAR2(1000 BYTE)	Yes		8	
IS_ACTIVE	VARCHAR2(1 BYTE)	Yes	"'Y'
"	9	


data :

23	Manage Circles	How do I use the Manage Circles screen?	To manage circles and view status of self request. You can perform the following actions here: view, create, modify, cancel.	1	/circle-management	Go to Manage Circles		Y
30	Circle Requests	How do I use the Circle Requests screen?	To review/approve pending requests for circles created by other user. You can perform the following actions here: view, approve, reject.	2	/circle-requests	Go to Circle Requests		Y
25	Manage CGL's	How do I use the Manage CGL's screen?	To edit or update active CGLs and to view pending CGL requests. You can perform the following actions here: view, create, modify, cancel.	5	/cgl-management	Go to Manage CGL's		Y
26	CGL Requests	How do I use the CGL Requests screen?	To efficiently review and process the pending requests for CGL master. You can perform the following actions here: view, approve, reject.	6	/cgl-requests	Go to CGL Requests		Y
27	Manage Segments	How do I use the Manage Segments screen?	To manage segments in application. You can perform the following actions here: view, create, modify, cancel.	7	/segment-management	Go to Manage Segments		Y
28	Segment Requests	How do I use the Segment Requests screen?	To efficiently review and process the pending requests for segment master. You can perform the following actions here: view, approve, reject.	8	/segment-requests	Go to Segment Requests		Y
1	Manage Branches	How do I use the Manage Branches screen?	To edit update branches and to check pending branch update requests. You can perform the following actions here: view, create, modify, cancel.	9	/branch-management	Go to Manage Branches		Y
2	Branch Requests	How do I use the Branch Requests screen?	To efficiently review and process the pending requests for branch master. You can perform the following actions here: view, approve, reject.	10	/branch-requests	Go to Branch Requests		Y
17	Manage Users	How do I use the Manage Users screen?	For creating new user. You can perform the following actions here: view, create, modify, delete, cancel.	12	/manage-user	Go to Manage Users		Y
18	User Requests	How do I use the User Requests screen?	To approve or reject user requests. You can perform the following actions here: view, approve, reject.	13	/user-requests	Go to User Requests		Y
29	Calendar Configuration	How do I use the Calendar Configuration screen?	To manage financial calender configuration in application. You can perform the following actions here: view, create, modify, cancel.	14	/calendar-configuration	Go to Calendar Configuration		Y
5	Calendar Config Requests	How do I use the Calendar Config Requests screen?	To efficiently review and process the pending requests for calender config master. You can perform the following actions here: view, approve, reject.	15	/calendar-config-requests	Go to Calendar Config Requests		Y
3	Manage States	How do I use the Manage States screen?	To manage states in application. You can perform the following actions here: view, create, modify, cancel.	16	/state-management	Go to Manage States		Y
4	State Requests	How do I use the State Requests screen?	To efficiently review and process the pending requests for state master. You can perform the following actions here: view, approve, reject.	17	/state-requests	Go to State Requests		Y
6	Manage Currencies	How do I use the Manage Currencies screen?	To manage currency in application. You can perform the following actions here: view, create, modify, cancel.	18	/manage-currencies	Go to Manage Currencies		Y
7	Currency Requests	How do I use the Currency Requests screen?	To efficiently review and process the pending requests for currency master. You can perform the following actions here: view, approve, reject.	19	/currency-requests	Go to Currency Requests		Y
8	Currency Rate Change	How do I use the Currency Rate Change screen?	To manage currency rate in application. You can perform the following actions here: view, modify, cancel.	20	/manage-currency-rate	Go to Currency Rate Change		Y
9	Currency Rate Requests	How do I use the Currency Rate Requests screen?	To efficiently review and process the pending requests for currency rate master. You can perform the following actions here: view, approve, reject.	21	/currency-rate-requests	Go to Currency Rate Requests		Y
15	Manage Roles	How do I use the Manage Roles screen?	To manage roles in application. You can perform the following actions here: view, create, modify, cancel.	22	/manage-roles	Go to Manage Roles		Y
13	Role Management Requests	How do I use the Role Management Requests screen?	To approve/reject role management related requests. You can perform the following actions here: view, approve, reject.	23	/role-requests	Go to Role Management Requests		Y
10	User Requests Audit	How do I use the User Requests Audit screen?	Shows user audit requests. You can perform the following actions here: view.	24	/user-audit	Go to User Requests Audit		Y
11	Process Status	How do I use the Process Status screen?	This is demo description. You can perform the following actions here: view, approve, reject, download, start, terminate, stop, restart, finish.	25	/process-status	Go to Process Status		Y
19	Whole Bank Reports	How do I use the Whole Bank Reports screen?	Manage whole bank report handling for various level of users and report types featured.. You can perform the following actions here: view, download.	26	/reports	Go to Whole Bank Reports		Y
44	Branch Wise Reports	How do I use the Branch Wise Reports screen?	Manage branch wise report handling for various level of users and report types featured.. You can perform the following actions here: view, download.	27	/branchwise-reports	Go to Branch Wise Reports		Y
22	Journal Posting	How do I use the Journal Posting screen?	This is demo description. You can perform the following actions here: view, create.	30	/journal-posting	Go to Journal Posting		Y
20	Journal Authorization	How do I use the Journal Authorization screen?	This is demo description. You can perform the following actions here: view, approve, reject.	31	/journal-Authorization	Go to Journal Authorization		Y
14	Journal Posting Status	How do I use the Journal Posting Status screen?	to cansel there own Request. You can perform the following actions here: view, cancel.	32	/journal-posting-status	Go to Journal Posting Status		Y
24	Balance Enquiry	How do I use the Balance Enquiry screen?	This provides closing balance for each day according to selected range. You can perform the following actions here: view.	33	/balance-enquiry	Go to Balance Enquiry		Y
21	Transaction Enquiry	How do I use the Transaction Enquiry screen?	This is demo description. You can perform the following actions here: view.	34	/transaction-enquiry	Go to Transaction Enquiry		Y
48	Dashboard	How do I use the Dashboard screen?	Sample Dashboard screen MUI. You can perform the following actions here: view.	35	/dashboard	Go to Dashboard		Y
31	Journal Bulk Upload	How do I use the Journal Bulk Upload screen?	To Upload the Bulk Journals. You can perform the following actions here: view, upload.	36	/journal-bulk-upload	Go to Journal Bulk Upload		Y
38	View CGL Details	How do I use the View CGL Details screen?	To View CGL details. You can perform the following actions here: view.	37	/view-cgl-details	Go to View CGL Details		Y
12	View Branch Details	How do I use the View Branch Details screen?	To View Branch details. You can perform the following actions here: view.	38	/view-branch-details	Go to View Branch Details		Y
32	Announcement Management	How do I use the Announcement Management screen?	To manage announcements. You can perform the following actions here: view, create, modify, cancel.	39	/announcements	Go to Announcement Management		Y
43	File Manager	How do I use the File Manager screen?	type of file. You can perform the following actions here: view, create, modify, cancel, delete.	40	/manage-files	Go to File Manager		Y
46	File Manager Requests	How do I use the File Manager Requests screen?	To efficiently review and process the pending requests for file manager. You can perform the following actions here: view, approve, reject.	41	/filemanage-requests	Go to File Manager Requests		Y
47	Transfer Data LHO	How do I use the Transfer Data LHO screen?	To efficiently review and process the pending requests for file manager. You can perform the following actions here: view, create, modify, cancel, delete.	42	/transfer-data-lho	Go to Transfer Data LHO		Y
34	Transfer Data LHO Requests	How do I use the Transfer Data LHO Requests screen?	To approve/reject LHO Data transfer related requests. You can perform the following actions here: view, approve, reject.	43	/transfer-data-lho-requests	Go to Transfer Data LHO Requests		Y
41	Data Parameters Manager	How do I use the Data Parameters Manager screen?	To manager. You can perform the following actions here: view, create, modify, cancel, delete.	44	/manage-Data-Parameters	Go to Data Parameters Manager		Y
37	Data Parameters  Manager request	How do I use the Data Parameters  Manager request screen?	To efficiently review and process the pending requests for file manager. You can perform the following actions here: view, approve, reject.	45	/manage-Data-Parameters-requests	Go to Data Parameters  Manager request		Y
40	Report Template Manager	How do I use the Report Template Manager screen?	Configure, manage, and monitor your report templates. You can perform the following actions here: view, create, modify, delete, cancel.	81	/template-configuration	Go to Report Template Manager		Y






HELP_FAQ_MASTER :

FAQ_ID	NUMBER	No	"FINCORE"."ISEQ$$_78064".nextval	1	
QUESTION_TEXT	VARCHAR2(1000 BYTE)	No		2	
ANSWER_CONTENT	VARCHAR2(4000 BYTE)	No		3	
VIEW_COUNT	NUMBER	Yes	0	4	
IS_ACTIVE	VARCHAR2(1 BYTE)	Yes	"'Y'
"	5	


DATA :

1	How do I reset my password?	Click on your profile icon in the top right, select Settings, and click Change Password.	15	Y
2	Who do I contact for IT Support?	Please email fincore-it@bank.com or call extension 4455.	42	Y




HELP_INTERACTION_LGS :

LOG_ID	NUMBER	No	"FINCORE"."ISEQ$$_78057".nextval	1	
USER_ID	VARCHAR2(50 BYTE)	No		2	
SOURCE_ENGINE	VARCHAR2(50 BYTE)	Yes		3	
USER_MESSAGE	VARCHAR2(2000 BYTE)	No		4	
RESPONSE_TYPE	VARCHAR2(50 BYTE)	Yes		5	
CONFIDENCE_SCORE	NUMBER	Yes		6	
IS_HELPFUL	NUMBER(1,0)	Yes		7	
CREATED_AT	TIMESTAMP(6)	Yes	"CURRENT_TIMESTAMP
"	8	


import React, { useState } from 'react';
import { createRoot } from 'react-dom/client';
import { LocalizationProvider } from '@mui/x-date-pickers';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { createTheme, ThemeProvider } from '@mui/material/styles';
import Box from '@mui/material/Box';
import Typography from '@mui/material/Typography';
import Card from '@mui/material/Card';
import CardContent from '@mui/material/CardContent';
import dayjs from 'dayjs';

// --- Theme Setup ---
const theme = createTheme({
  palette: {
    primary: {
      main: '#6500caff',
    },
  },
});

const App = () => {
  // --- Mock Data Setup (Simulating your backend/props) ---
  // In your real app, these come from your props or context
  const expectedStartDate = "2025-04-01"; 
  const nextFYInfo = {
    expectedStart: dayjs(expectedStartDate),
  };

  // --- State ---
  // Initialize with null or a default year
  const [selectedYear, setSelectedYear] = useState(null);

  // --- Validation Logic ---
  // Helper to determine if the selected year matches the expectation
  const isValidSelection = selectedYear && 
    nextFYInfo.expectedStart && 
    selectedYear === nextFYInfo.expectedStart.year();

  return (
    <Box className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans">
      <Card className="w-full max-w-md shadow-lg">
        <CardContent className="p-6">
          <Typography variant="h5" component="h2" className="mb-6 font-bold text-gray-800">
            Financial Year Selector
          </Typography>

          <Typography variant="body2" className="mb-4 text-gray-600">
            <strong>Context:</strong> Expected FY Start is {nextFYInfo.expectedStart.format('MMMM D, YYYY')}.
            <br />
            Try typing "2025" (valid) or "2026" (disabled/invalid).
          </Typography>

          <LocalizationProvider dateAdapter={AdapterDayjs}>
            <DatePicker
              views={["year"]}
              label="Financial Year*"
              // Ensure format matches the view so typing works naturally
              format="YYYY" 
              
              // Bind value carefully to avoid invalid dayjs objects
              value={selectedYear ? dayjs(`${selectedYear}-01-01`) : null}
              
              // Validations
              minDate={dayjs("2025-01-01")}
              maxDate={nextFYInfo.expectedStart?.endOf("year")}
              disabled={!nextFYInfo.expectedStart}
              shouldDisableYear={(year) =>
                nextFYInfo.expectedStart
                  ? year.year() !== nextFYInfo.expectedStart.year()
                  : true
              }
              
              sx={{ mt: 1, width: '100%' }}
              
              // Handle Change (Typing + Selection)
              onChange={(val) => {
                // If user backspaces/clears, val is null. We must handle this.
                if (!val || !val.isValid()) {
                  setSelectedYear(null);
                  return;
                }
                setSelectedYear(val.year());
              }}
              
              slotProps={{
                textField: {
                  size: "small",
                  fullWidth: true,
                  // REMOVED: InputProps: { readOnly: true } 
                  // This allows typing.
                  
                  // Helper Text Logic (Preserved from your code)
                  helperText:
                    selectedYear == expectedStartDate?.split("-")[0]
                      ? `Selected Financial Year : ${selectedYear} â€“ ${
                          selectedYear + 1
                        } (April to March)`
                      : nextFYInfo.expectedStart
                      ? `Requests are permitted only for Financial Year ${nextFYInfo.expectedStart.format(
                          "YYYY"
                        )}-${nextFYInfo.expectedStart
                          .add(1, "year")
                          .format("YYYY")}.`
                      : "",
                  
                  FormHelperTextProps: {
                    sx: {
                      mt: 1,
                      fontSize: "0.85rem",
                      fontWeight: 500,
                      // Change color based on validity for better UX
                      color: isValidSelection ? "#6500caff" : "#d32f2f",
                    },
                  },
                },
              }}
            />
          </LocalizationProvider>

          <Box className="mt-6 p-4 bg-gray-100 rounded text-sm text-gray-700">
            <strong>Current State:</strong> {selectedYear || "None"}
          </Box>
        </CardContent>
      </Card>
    </Box>
  );
};

const root = createRoot(document.getElementById('root'));
root.render(
  <ThemeProvider theme={theme}>
    <App />
  </ThemeProvider>
);


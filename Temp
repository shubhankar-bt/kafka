package com.fincore.helpservice.service;

import com.fincore.helpservice.model.HelpSynonymEntity;
import com.fincore.helpservice.repository.HelpAnalyticsRepository;
import com.fincore.helpservice.repository.HelpSynonymRepository;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.util.List;
import java.util.concurrent.TimeUnit;

@Service
@RequiredArgsConstructor
@Slf4j
public class AdaptiveSearchService {

    private final HelpSynonymRepository synonymRepository;
    private final HelpAnalyticsRepository analyticsRepository;
    private final StringRedisTemplate redisTemplate;

    // Redis Keys
    private static final String REDIS_KEY_SYNONYMS = "help:synonyms";
    private static final String REDIS_KEY_BOOST_PREFIX = "help:boost:";

    @PostConstruct
    @Scheduled(fixedRate = 3600000) // Refresh every hour
    public void refreshKnowledge() {
        refreshSynonymsInRedis();
    }

    /**
     * SYNC DB -> REDIS
     * Loads all active synonyms from Oracle into Redis Hash.
     */
    private void refreshSynonymsInRedis() {
        try {
            List<HelpSynonymEntity> synonyms = synonymRepository.findByIsActive("Y");
            if (synonyms.isEmpty()) return;

            // 1. Clear old cache (Optional, depending on strategy)
            redisTemplate.delete(REDIS_KEY_SYNONYMS);

            // 2. Push new data
            synonyms.forEach(syn -> {
                if (syn.getTerm() != null && syn.getRootIntent() != null) {
                    redisTemplate.opsForHash().put(
                        REDIS_KEY_SYNONYMS, 
                        syn.getTerm().toLowerCase(), 
                        syn.getRootIntent().toUpperCase()
                    );
                }
            });
            log.info("AdaptiveSearch: Synced {} synonyms to Redis.", synonyms.size());
        } catch (Exception e) {
            log.error("AdaptiveSearch: Redis Sync Failed. Bot will use fallback logic.", e);
        }
    }

    public String getRootFromSynonym(String word) {
        if (word == null) return "";
        try {
            // fast lookup in Redis
            Object root = redisTemplate.opsForHash().get(REDIS_KEY_SYNONYMS, word.toLowerCase());
            if (root != null) {
                return root.toString();
            }
        } catch (Exception e) {
            log.warn("Redis unavailable, returning original word.");
        }
        return word; // Default to original if not found or Redis down
    }

    /**
     * THE HIVE MIND LOGIC (Redis Backed)
     * Check Redis for a boost score. If missing, calculate from DB and cache it for 24 hours.
     */
    public int getBehavioralBoost(String normalizedQuery, String questionId) {
        if (normalizedQuery == null || questionId == null) return 0;

        // Key: help:boost:hashcode_questionId
        String key = REDIS_KEY_BOOST_PREFIX + normalizedQuery.hashCode() + "_" + questionId;

        try {
            // 1. Check Redis
            String cachedScore = redisTemplate.opsForValue().get(key);
            if (cachedScore != null) {
                return Integer.parseInt(cachedScore);
            }

            // 2. Cache Miss -> Calculate from DB
            // We use the first 2 words for broader matching
            String looseQuery = normalizedQuery.split("\\s+")[0];
            if (looseQuery.length() < 3) looseQuery = normalizedQuery;

            Long count = analyticsRepository.countSuccessfulInteractions(looseQuery, questionId);

            // Logic: 1 click = 1 point, Max 20 points
            int boost = (int) Math.min(count * 2, 20);

            // 3. Store in Redis (TTL: 24 Hours)
            if (boost > 0) {
                redisTemplate.opsForValue().set(key, String.valueOf(boost), 24, TimeUnit.HOURS);
            }

            return boost;

        } catch (Exception e) {
            log.error("Adaptive Boost Error", e);
            return 0; // Fail safe
        }
    }
}







{
   "requestType": "CHAT",
   "chatMessage": "how to create segment?"
}

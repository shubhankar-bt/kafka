package com.fincore.DashboardService.service;

import com.fincore.DashboardService.model.NotificationOutbox;
import com.fincore.DashboardService.repository.DashboardStatsRepository;
import com.fincore.DashboardService.repository.DashboardStatsRepository.RoleBottleneck;
import com.fincore.DashboardService.repository.NotificationOutboxRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class IntelligenceSchedulerService {

    private final DashboardStatsRepository statsRepo;
    private final NotificationOutboxRepository outboxRepo;

    /**
     * Daily Job (9:00 AM): BOTTLENECK DETECTION
     * Scans for ROLES that have > 5 items pending for more than 48 hours.
     * Writes a warning to the Outbox table using our Outbox Pattern.
     */
    @Scheduled(cron = "0 0 9 * * ?") // 9 AM Daily
    @Transactional
    public void runBottleneckDetection() {
        log.info("üïµÔ∏è Starting Daily Intelligence Scan: Bottleneck Detection...");

        List<RoleBottleneck> bottlenecks = statsRepo.findAllBottleneckRoles();

        if (bottlenecks.isEmpty()) {
            log.info("‚úÖ No bottlenecks detected today.");
            return;
        }

        log.warn("‚ö†Ô∏è Detected {} roles with critical bottlenecks.", bottlenecks.size());

        for (RoleBottleneck role : bottlenecks) {
            String roleIdStr = role.getRoleId();
            
            // Just in case the DB returns null or empty for some reason
            if (roleIdStr == null || roleIdStr.trim().isEmpty()) {
                continue;
            }

            String message = String.format("Team Alert: Your Role has %d overdue request(s) pending for over 48 hours. Please clear the queue.", role.getOverdueCount());
            
            // Create Notification Event (Outbox Pattern)
            // TARGET: ROLE (1-to-Many)
            // Note: eventId is generated by JPA/DB, so we don't set it manually here.
            NotificationOutbox event = NotificationOutbox.builder()
                    .userId(null) // Not for a specific user
                    .targetRole(roleIdStr) // Send to ALL users with this Role
                    .message(message)
                    .linkUrl("/dashboard") 
                    .eventSource("DASHBOARD_INTELLIGENCE")
                    .aggregateId("BOTTLENECK_" + System.currentTimeMillis()) 
                    .build();

            outboxRepo.save(event);
            log.info(" -> Notification dispatched for Role ID: {}", roleIdStr);
        }
    }
}






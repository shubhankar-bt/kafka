{
   "userMessage": "Thanks"
}

{
    "responseType": "TEXT_REPLY",
    "botReply": "You're welcome! If you have any questions about FinCore or need assistance with our services, feel free to ask. I'm here to help!",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 68,
    "items": null
}



{
   "userMessage": "Hi"
}

{
    "responseType": "TEXT_REPLY",
    "botReply": "Hello! I'm your FinCore Smart Assistant, here to help you with any questions about our banking services and rules. How can I assist you today?",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 69,
    "items": null
}






{
   "userMessage": "What is segment?"
}




{
    "responseType": "TEXT_REPLY",
    "botReply": "I'm an AI designed to assist with FinCore-related inquiries, but it seems the specific information you're asking about isn't available in my authorized context. For detailed explanations on segments within our banking services or any other topic, please ensure your permissions are set correctly or reach out to IT support for assistance.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 70,
    "items": null
}




{
   "userMessage": "How to create cgl",
   "currentScreen": "Dashboard"
}



{
    "responseType": "TEXT_REPLY",
    "botReply": "I'm sorry, but the information you're asking for isn't available in my authorized context. Please check your permissions or contact IT for assistance with creating a CGL (Certificate of Good Standing).\nBEGIN FLOW LOG\nFlow Name: Banking Query Handling\nFlow Status: Completed\nEnd Time: 2026-03-31T18:57:00Z\nEND FLOW LOG",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 71,
    "items": null
}








{
   "userMessage": "Do you know cgl?",
   "currentScreen": "Dashboard"
}


2026-02-25 19:17:21.351 INFO  [http-nio-9099-exec-1] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'Do you know cgl?' 
2026-02-25 19:17:21.352 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:17:32.376 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 
2026-02-25 19:17:32.441 INFO  [main] c.f.h.s.DocumentIngestionService: [AI-INGEST] Successfully saved/overwritten 53 vectors to Redis Stack. 











{
   "userMessage": "What is cgl?",
   "currentScreen": "Dashboard"
}


{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 75,
    "items": null
}



{
   "userMessage": "What is segment?"
}


{
    "responseType": "TEXT_REPLY",
    "botReply": "I'm an AI designed to assist with FinCore banking queries, but it seems that the specific information about \"segment\" isn't available in my authorized context at this moment. For detailed insights on segments within our services, please check your permissions or contact IT for assistance.\n\n[End of Solution 1]",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 76,
    "items": null
}







{
    "responseType": "TEXT_REPLY",
    "botReply": "I'm an AI designed to assist with FinCore banking queries, but it seems that the specific information about \"segment\" isn't available in my authorized context at this moment. For detailed insights on segments within our services, please check your permissions or contact IT for assistance.\n\n[End of Solution 1]",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 76,
    "items": null
}






{
    "responseType": "TEXT_REPLY",
    "botReply": "I'm sorry, but the information you're asking for isn't available in my authorized context. Please check your permissions or contact IT for assistance with creating a CGL.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 77,
    "items": null
}







2026-02-25 19:17:21.351 INFO  [http-nio-9099-exec-1] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'Do you know cgl?' 
2026-02-25 19:17:21.352 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:17:32.376 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 
2026-02-25 19:17:32.441 INFO  [main] c.f.h.s.DocumentIngestionService: [AI-INGEST] Successfully saved/overwritten 53 vectors to Redis Stack. 
2026-02-25 19:18:48.304 INFO  [http-nio-9099-exec-2] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'What is cgl?' 
2026-02-25 19:18:48.409 INFO  [http-nio-9099-exec-2] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:18:48.674 INFO  [http-nio-9099-exec-2] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 
2026-02-25 19:19:27.035 WARN  [http-nio-9099-exec-2] c.f.h.s.ChatSessionService: [SESSION] User 2488766 gained a strike. Current strikes: 1/3 
2026-02-25 19:19:49.369 INFO  [http-nio-9099-exec-4] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'What is segment?' 
2026-02-25 19:19:49.381 INFO  [http-nio-9099-exec-4] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:19:49.656 INFO  [http-nio-9099-exec-4] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 

2026-02-25 19:21:21.732 INFO  [http-nio-9099-exec-7] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'How to create a cgl?' 
2026-02-25 19:21:21.742 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:21:22.012 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 
2026-02-25 19:21:21.732 INFO  [http-nio-9099-exec-7] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'How to create a cgl?' 
2026-02-25 19:21:21.742 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:21:22.012 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 
2026-02-25 19:23:36.334 INFO  [http-nio-9099-exec-9] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'What do you know about me?' 
2026-02-25 19:23:36.343 INFO  [http-nio-9099-exec-9] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:23:36.632 INFO  [http-nio-9099-exec-9] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 
2026-02-25 19:25:05.142 INFO  [http-nio-9099-exec-1] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'Thanks' 
2026-02-25 19:25:05.227 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:25:05.514 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 
2026-02-25 19:25:51.417 INFO  [http-nio-9099-exec-3] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'ki korche? i which language' 
2026-02-25 19:25:51.417 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:25:51.776 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 














2026-02-25 19:49:46.637 INFO  [http-nio-9099-exec-1] o.a.j.l.DirectJDKLog: Initializing Spring DispatcherServlet 'dispatcherServlet' 
2026-02-25 19:49:46.646 INFO  [http-nio-9099-exec-1] o.s.w.s.FrameworkServlet: Initializing Servlet 'dispatcherServlet' 
2026-02-25 19:49:46.649 INFO  [http-nio-9099-exec-1] o.s.w.s.FrameworkServlet: Completed initialization in 1 ms 
2026-02-25 19:49:46.714 INFO  [http-nio-9099-exec-1] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'cgl' 
2026-02-25 19:49:46.715 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:49:46.971 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: search result : 10 
2026-02-25 19:49:46.971 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Allowed Perms: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-25 19:49:46.972 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.826636791229 
2026-02-25 19:49:46.972 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.8195498883725 
2026-02-25 19:49:46.972 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.813152372837 
2026-02-25 19:49:46.972 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.812735706568 
2026-02-25 19:49:46.972 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.8111776709555 
2026-02-25 19:49:46.972 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.809019446373 
2026-02-25 19:49:46.973 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.804780751467 
2026-02-25 19:49:46.973 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.7625308930875 
2026-02-25 19:49:46.973 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.7625308930875 
2026-02-25 19:49:46.973 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.7483872175215001 
2026-02-25 19:49:47.027 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 









{
   "userMessage": "cgl"
}





{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 84,
    "items": null
}














cleared redis index and flush all after this logs 


2026-02-25 19:52:37.407 INFO  [main] o.s.b.w.e.t.TomcatWebServer: Tomcat started on port 9099 (http) with context path '/' 
2026-02-25 19:52:37.419 INFO  [main] o.s.b.StartupInfoLogger: Started HelpServiceApplication in 10.42 seconds (process running for 11.642) 
2026-02-25 19:52:37.431 INFO  [main] c.f.h.s.DocumentIngestionService: [AI-INGEST] Starting Knowledge Ingestion to Redis via mxbai-embed... 
2026-02-25 19:52:37.773 INFO  [main] c.f.h.s.DocumentIngestionService: [AI-INGEST] Chunked 51 raw DB records into 53 mathematical segments. 
2026-02-25 19:52:49.943 INFO  [main] c.f.h.s.DocumentIngestionService: [AI-INGEST] Successfully saved/overwritten 53 vectors to Redis Stack. 
2026-02-25 19:53:45.111 INFO  [http-nio-9099-exec-1] o.a.j.l.DirectJDKLog: Initializing Spring DispatcherServlet 'dispatcherServlet' 
2026-02-25 19:53:45.122 INFO  [http-nio-9099-exec-1] o.s.w.s.FrameworkServlet: Initializing Servlet 'dispatcherServlet' 
2026-02-25 19:53:45.124 INFO  [http-nio-9099-exec-1] o.s.w.s.FrameworkServlet: Completed initialization in 2 ms 
2026-02-25 19:53:45.184 INFO  [http-nio-9099-exec-1] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'cgl' 
2026-02-25 19:53:45.185 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 19:53:45.449 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: search result : 10 
2026-02-25 19:53:45.450 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Allowed Perms: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-25 19:53:45.450 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.826636791229 
2026-02-25 19:53:45.450 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.8195498883725 
2026-02-25 19:53:45.450 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.813152372837 
2026-02-25 19:53:45.452 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.809019446373 
2026-02-25 19:53:45.452 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.804780751467 
2026-02-25 19:53:45.452 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.7625308930875 
2026-02-25 19:53:45.452 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.7483872175215001 
2026-02-25 19:53:45.452 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.7469815015795 
2026-02-25 19:53:45.452 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.7431195676325 
2026-02-25 19:53:45.452 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: Doc Perm: 'null' | Score: 0.700172662735 
2026-02-25 19:53:45.491 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-CHAT] LLM Processing... Found 0 valid context blocks. 




























package com.fincore.helpservice.service;

import com.fincore.helpservice.dto.HelpResponseDTO;
import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.message.AiMessage;
import dev.langchain4j.data.message.SystemMessage;
import dev.langchain4j.data.message.UserMessage;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.memory.ChatMemory;
import dev.langchain4j.memory.chat.MessageWindowChatMemory;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingMatch;
import dev.langchain4j.store.embedding.EmbeddingSearchRequest;
import dev.langchain4j.store.embedding.EmbeddingSearchResult;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class FinCoreChatAgent {

    private static final String FAILURE_MSG = "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.";

    private final ChatLanguageModel chatClient;
    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> vectorStore;
    private final PermissionService permissionService;
    private final ChatSessionService sessionService;
    private final HelpAnalyticsService analyticsService;
    private final HelpQuestionRepository questionRepository;
    private final HelpFaqRepository faqRepository;

    private final Cache<String, ChatMemory> userMemories = Caffeine.newBuilder()
            .expireAfterAccess(30, TimeUnit.MINUTES)
            .maximumSize(10000)
            .build();

    public HelpResponseDTO handleChat(String userId, String roleId, String userMessage, String currentScreen) {
        log.info("[AI-CHAT] Processing query for User: {}", userId);

        try {
            // ========================================================================
            // 0. QUICK ACTIONS (Buttons clicked in the UI)
            // ========================================================================
            if ("/action faq".equalsIgnoreCase(userMessage.trim())) {
                List<String> faqQuestions = faqRepository.findTop10ByIsActiveOrderByViewCountDesc("Y")
                        .stream().map(HelpFaqEntity::getQuestionText).collect(Collectors.toList());
                return HelpResponseDTO.builder().responseType("SUGGESTION").botReply("Here are a few frequently asked questions:").items(faqQuestions).build();
            }

            if (userMessage.trim().startsWith("/action module")) {
                String requestedScreen = userMessage.replace("/action module", "").trim();
                List<String> moduleQuestions = questionRepository.findByScreenNameAndIsActive(requestedScreen, "Y")
                        .stream().map(HelpQuestionEntity::getQuestionText).collect(Collectors.toList());
                if (moduleQuestions.isEmpty()) {
                    return HelpResponseDTO.builder().responseType("TEXT_REPLY").botReply("I don't have predefined questions for " + requestedScreen + ", but feel free to ask me anything about it!").build();
                }
                return HelpResponseDTO.builder().responseType("SUGGESTION").botReply("Here are a few common questions for " + requestedScreen + ":").items(moduleQuestions).build();
            }

            // ========================================================================
            // 1. ESCALATION CHECK
            // ========================================================================
            if (sessionService.isEscalationRequired(userId)) {
                sessionService.resetStrikes(userId);
                return HelpResponseDTO.builder()
                        .responseType("ESCALATION_OFFER")
                        .botReply("I seem to be having trouble helping you today. Would you like me to raise an IT Support Ticket with your chat history attached?")
                        .build();
            }

            // ========================================================================
            // 2. VECTOR DB FETCH (No math thresholds - fetch everything, filter later)
            // ========================================================================
            List<String> allowedPerms = permissionService.getAllAllowedPermissionIdsForRole(roleId)
                    .stream().map(String::valueOf).collect(Collectors.toList());
            allowedPerms.add("GLOBAL");

            Embedding queryEmbedding = embeddingModel.embed(userMessage).content();

            // Fetch top 100 to make sure we don't miss anything due to low cosine scores
            EmbeddingSearchRequest searchRequest = EmbeddingSearchRequest.builder()
                    .queryEmbedding(queryEmbedding)
                    .maxResults(100)
                    .build();

            EmbeddingSearchResult<TextSegment> searchResult = vectorStore.search(searchRequest);

            log.info("search result : {}", searchResult.matches().size());

            log.info("Allowed Perms: {}", allowedPerms);
            for (EmbeddingMatch<TextSegment> m : searchResult.matches()) {
                String perm = m.embedded().metadata().getString("permissionId");
                log.info("Doc Perm: '{}' | Score: {}", perm, m.score());

            }

            // Filter ONLY what the user is allowed to see, take the Top 3
            List<EmbeddingMatch<TextSegment>> matches = searchResult.matches().stream()
                    .filter(match -> allowedPerms.contains(match.embedded().metadata().getString("permissionId")))
                    .limit(3)
                    .toList();

            // ========================================================================
            // 3. CONTEXT BUILDER
            // ========================================================================
            StringBuilder contextBuilder = new StringBuilder();
            String primaryActionLink = null;
            String primaryActionLabel = null;
            double confidenceScore = matches.isEmpty() ? 0.0 : matches.get(0).score();

            if (!matches.isEmpty()) {
                for (EmbeddingMatch<TextSegment> match : matches) {
                    contextBuilder.append("- ").append(match.embedded().text()).append("\n\n");
                    if (primaryActionLink == null && !"NONE".equals(match.embedded().metadata().getString("actionLink"))) {
                        primaryActionLink = match.embedded().metadata().getString("actionLink");
                        primaryActionLabel = match.embedded().metadata().getString("actionLabel");
                    }
                }
            } else {
                contextBuilder.append("NO BANKING CONTEXT FOUND. User either lacks permission or manual does not exist.");
            }

            // ========================================================================
            // 4. THE MASTER AI PROMPT
            // ========================================================================
            String liveEtlDate = permissionService.getLiveEtlDate();
            String currentTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("EEEE, MMMM dd, yyyy - hh:mm a"));
            String currentScreenContext = (currentScreen != null && !currentScreen.isEmpty()) ? currentScreen : "Unknown";

            String dynamicPrompt = """
                    You are the FinCore Smart Assistant, an advanced AI banking bot.
                    Current Time: %s
                    System ETL Date: %s
                    User's Current Screen: %s
                    
                    CORE BEHAVIORS:
                    1. CASUAL CONVERSATION: If the user is just saying hello, asking how you are, making small talk, or asking about your identity, reply warmly, naturally, and dynamically as a helpful assistant. Do NOT use the fallback error message for small talk.
                    2. BANKING QUERIES: If the user asks ANY question about FinCore, banking rules, acronyms, or how to do something, you MUST look at the [AUTHORIZED CONTEXT] below.
                       - If the answer is clearly in the context, answer it professionally.
                       - If the answer is NOT in the context, you MUST reply EXACTLY with: '%s'
                    3. DO NOT GUESS: Never invent banking rules.

                    [AUTHORIZED CONTEXT]
                    %s
                    """.formatted(currentTime, liveEtlDate, currentScreenContext, FAILURE_MSG, contextBuilder.toString());

            // ========================================================================
            // 5. CALL PHI-3 (The Brain)
            // ========================================================================
            ChatMemory memory = userMemories.get(userId, k -> MessageWindowChatMemory.withMaxMessages(5));
            memory.add(UserMessage.from(userMessage));

            log.info("[AI-CHAT] LLM Processing... Found {} valid context blocks.", matches.size());
            AiMessage responseMessage = chatClient.generate(
                    SystemMessage.from(dynamicPrompt),
                    memory.messages().get(memory.messages().size() - 1)
            ).content();

            String aiResponse = responseMessage.text();



            // ========================================================================
            // 6. OUTPUT SANITIZATION & LOGGING
            // ========================================================================
            if (aiResponse.contains("I cannot find this information") || aiResponse.contains(FAILURE_MSG)) {
                sessionService.addStrikes(userId, 1);
                Long failLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "NO_MATCH", (int)(confidenceScore * 100));
                memory.add(AiMessage.from(FAILURE_MSG)); // Prevent AI from remembering its own hallucinated apologies
                return HelpResponseDTO.builder().responseType("NO_MATCH").botReply(FAILURE_MSG).logId(failLogId).build();
            }

            sessionService.resetStrikes(userId);
            memory.add(responseMessage);

            Long successLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "ANSWERED", (int)(confidenceScore * 100));

            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply(aiResponse.trim())
                    .navigationLink(primaryActionLink)
                    .navigationLabel(primaryActionLabel)
                    .logId(successLogId)
                    .build();

        } catch (Exception e) {
            log.error("[AI-CHAT] Critical AI Generation Failure", e);
            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply("I am currently experiencing a cognitive delay. Please try again in a moment.")
                    .build();
        }
    }

    public void incrementFaqPopularity(String questionText) {
        faqRepository.findByQuestionTextAndIsActive(questionText, "Y").ifPresent(faq -> {
            faq.setViewCount(faq.getViewCount() + 1);
            faqRepository.save(faq);
        });
    }
}















package com.fincore.helpservice.service;

import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.model.KnowledgeBaseEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.fincore.helpservice.repository.KnowledgeBaseRepository;
import dev.langchain4j.data.document.Document;
import dev.langchain4j.data.document.Metadata;
import dev.langchain4j.data.document.splitter.DocumentSplitters;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

import static java.util.Collections.singletonList;

/**
 * Handles converting ALL Oracle DB text (Procedural + Conceptual)
 * into AI Mathematical Vectors using LangChain4j and Redis.
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class DocumentIngestionService {

    private final HelpQuestionRepository questionRepository;
    private final KnowledgeBaseRepository knowledgeBaseRepository;
    private final HelpFaqRepository faqRepository;

    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> embeddingStore;

    @EventListener(ApplicationReadyEvent.class)
    public void ingestKnowledgeBase() {
        log.info("[AI-INGEST] Starting Knowledge Ingestion to Redis via mxbai-embed...");

        List<Document> allDocuments = new ArrayList<>();

        // ---------------------------------------------------------
        // 1. INGEST PROCEDURAL DATA (Help Questions & UI Buttons)
        // ---------------------------------------------------------
        List<HelpQuestionEntity> questions = questionRepository.findByIsActive("Y");
        for (HelpQuestionEntity q : questions) {
            String content = "Module: " + (q.getScreenName() != null ? q.getScreenName() : "General") +
                    "\nQuestion: " + q.getQuestionText() +
                    "\nAnswer: " + q.getAnswerContent() +
                    (q.getProTip() != null ? "\nPro Tip: " + q.getProTip() : "");

            String permId = q.getPermissionId() != null ? String.valueOf(q.getPermissionId()) : "GLOBAL";

            Metadata metadata = new Metadata()
                    .put("permissionId", permId)
                    .put("actionLink", q.getActionLink() != null ? q.getActionLink() : "NONE")
                    .put("actionLabel", q.getActionLabel() != null ? q.getActionLabel() : "NONE")
                    .put("dataType", "PROCEDURAL");

            allDocuments.add(Document.from(content, metadata));
        }

        // ---------------------------------------------------------
        // 2. INGEST CONCEPTUAL DATA (Knowledge Base Paragraphs)
        // ---------------------------------------------------------
        List<KnowledgeBaseEntity> knowledgeBase = knowledgeBaseRepository.findByIsActive("Y");
        for (KnowledgeBaseEntity kb : knowledgeBase) {
            String content = "Topic: " + kb.getTopic() +
                    "\nInformation: " + kb.getContentParagraph();

            String permId = kb.getPermissionId() != null ? String.valueOf(kb.getPermissionId()) : "GLOBAL";

            // Conceptual data doesn't have UI action buttons, so we default to NONE
            Metadata metadata = new Metadata()
                    .put("permissionId", permId)
                    .put("actionLink", "NONE")
                    .put("actionLabel", "NONE")
                    .put("dataType", "CONCEPTUAL");

            allDocuments.add(Document.from(content, metadata));
        }

        // ---------------------------------------------------------
        // 2. INGEST FAQs (Knowledge Base Paragraphs)
        // ---------------------------------------------------------
        List<HelpFaqEntity> faqs = faqRepository.findAll();
        for (HelpFaqEntity faq : faqs) {
            if ("Y".equals(faq.getIsActive())) {
                String content = "FAQ Question: " + faq.getQuestionText() + "\nAnswer: " + faq.getAnswerContent();
                Metadata metadata = new Metadata().put("permissionId", "GLOBAL") // FAQs are Global
                        .put("actionLink", "NONE").put("actionLabel", "NONE").put("dataType", "FAQ");
                allDocuments.add(Document.from(content, metadata));
            }
        }

        // ---------------------------------------------------------
        // 3. CHUNK AND SAVE TO REDIS
        // ---------------------------------------------------------
        if (!allDocuments.isEmpty()) {
            // Split long documents into overlapping 300-token chunks
            List<TextSegment> segments = DocumentSplitters.recursive(300, 50).splitAll(allDocuments);
            log.info("[AI-INGEST] Chunked {} raw DB records into {} mathematical segments.", allDocuments.size(), segments.size());

            // Generate Vectors via Ollama
            List<Embedding> embeddings = embeddingModel.embedAll(segments).content();

            // FIX GAP 1: Deterministic IDs to prevent Redis duplication on restart
            for (int i = 0; i < segments.size(); i++) {
                TextSegment segment = segments.get(i);
                Embedding vector = embeddings.get(i);

                // Generate a unique, repeatable ID based on the Data Type and Permission
                String dataType = segment.metadata().getString("dataType");
                String perm = segment.metadata().getString("permissionId");

                // Example ID: "PROCEDURAL_5_chunk_0", "CONCEPTUAL_GLOBAL_chunk_1"
                String deterministicId = dataType + "_" + perm + "_chunk_" + i;

                // Save one by one using the explicit ID
                embeddingStore.addAll(
                        singletonList(deterministicId),
                        singletonList(vector),
                        singletonList(segment)
                );
            }
            log.info("[AI-INGEST] Successfully saved/overwritten {} vectors to Redis Stack.", segments.size());

        } else {
            log.warn("[AI-INGEST] No active documents found in Oracle DB to ingest!");
        }
    }
}




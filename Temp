package com.fincore.helpservice.service;

import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Random;
import java.util.function.Supplier;
import java.util.regex.Pattern;

/**
 * THE AI PERSONALITY ENGINE.
 * Handles general conversation, dynamic responses (time/date), and identity questions
 * gracefully, giving the bot a modern AI feel.
 */
@Service
public class SmallTalkService {

    private final List<SmallTalkRule> rules = new ArrayList<>();
    private final Random random = new Random();

    public SmallTalkService() {
        // Initialize conversational rules in order of priority

        // 1. CREATOR IDENTITY (Shubhankar)
        addRule("\\b(who|which team).*(built|created|made|developed|programmed).*you\\b|\\bwho is your (maker|creator|developer|father)\\b", 
            () -> "I was built by **Shubhankar**, a developer from the FinCore team. He designed me to make your banking operations smoother!");

        // 2. SELF IDENTITY
        addRule("\\b(who|what) are you\\b|\\b(your name)\\b", 
            () -> getRandom(List.of(
                "I am the FinCore Smart Assistant, an AI designed to help you navigate this application.",
                "I'm your FinCore virtual assistant! I'm here to help you with CGLs, Segments, Journals, and more."
            )));

        // 3. CAPABILITIES
        addRule("\\bwhat.*can you do\\b|\\bhow.*can you help\\b|\\bwhat are your features\\b", 
            () -> "I can help you navigate modules, check your access permissions, guide you through processes like creating CGLs or posting Journals, and even redirect you to the right screens. Just ask!");

        // 4. DYNAMIC TIME
        addRule("\\b(what|tell me).*(is the |current )?time\\b", 
            () -> {
                String time = LocalTime.now().format(DateTimeFormatter.ofPattern("hh:mm a"));
                return "The current time is **" + time + "**.";
            });

        // 5. DYNAMIC DATE
        addRule("\\b(what|tell me).*(is the )?(date|day today)\\b", 
            () -> {
                String date = LocalDate.now().format(DateTimeFormatter.ofPattern("EEEE, MMMM dd, yyyy"));
                return "Today is **" + date + "**.";
            });

        // 6. HOW ARE YOU / STATUS
        addRule("\\bhow are you\\b|\\bhow are you doing\\b|\\bhow is it going\\b", 
            () -> getRandom(List.of(
                "I'm doing great, functioning at 100% capacity! How can I help you today?",
                "I'm just a bunch of code, but I'm feeling helpful today! What do you need?",
                "All systems go! Ready to assist you."
            )));

        // 7. GREETINGS
        addRule("\\b(hi|hello|hey|greetings|morning|afternoon|evening|wassup|sup)\\b", 
            () -> getRandom(List.of(
                "Hello! How can I assist you with FinCore today?",
                "Hi there! What can I do for you?",
                "Greetings! Need any help navigating the system?"
            )));

        // 8. GRATITUDE
        addRule("\\b(thank|thanks|thank you|thx|cool|awesome|great|nice)\\b", 
            () -> getRandom(List.of(
                "You're very welcome! Let me know if you need anything else.",
                "Glad I could help!",
                "Anytime! I'm always here."
            )));

        // 9. JOKES (Easter Egg)
        addRule("\\b(tell me a joke|make me laugh|joke)\\b", 
            () -> getRandom(List.of(
                "Why do Java developers wear glasses? Because they don't C#!",
                "Why did the database administrator leave his wife? She had one-to-many relationships.",
                "There are 10 types of people in the world: those who understand binary, and those who don't."
            )));

        // 10. OUT OF SCOPE (Graceful handling of random AI questions)
        addRule("\\b(weather|sing|dance|marry|recipe|food)\\b", 
            () -> "I'd love to chat about that, but my expertise is strictly tied to the FinCore banking application right now! Need help with a module?");
    }

    /**
     * Evaluates the user's message against the regex rules.
     * @return The dynamic string response, or null if it's a business query.
     */
    public String getSmallTalkResponse(String userMessage) {
        if (userMessage == null || userMessage.trim().isEmpty()) return null;
        
        String lowerMessage = userMessage.toLowerCase().trim();
        
        // Strip punctuation for easier regex matching
        String cleanMessage = lowerMessage.replaceAll("[^a-z0-9\\s]", "");

        for (SmallTalkRule rule : rules) {
            if (rule.getPattern().matcher(cleanMessage).find()) {
                return rule.getResponseGenerator().get(); // Execute the dynamic function
            }
        }
        
        return null; // Not small talk; proceed to NLP & Database search
    }

    private void addRule(String regex, Supplier<String> responseGenerator) {
        // Compile regex once at startup for high performance
        Pattern pattern = Pattern.compile(regex, Pattern.CASE_INSENSITIVE);
        rules.add(new SmallTalkRule(pattern, responseGenerator));
    }

    private String getRandom(List<String> options) {
        return options.get(random.nextInt(options.size()));
    }

    /**
     * Internal class to hold the Regex Pattern and the Dynamic Execution Function (Supplier)
     */
    private static class SmallTalkRule {
        private final Pattern pattern;
        private final Supplier<String> responseGenerator;

        public SmallTalkRule(Pattern pattern, Supplier<String> responseGenerator) {
            this.pattern = pattern;
            this.responseGenerator = responseGenerator;
        }

        public Pattern getPattern() { return pattern; }
        public Supplier<String> getResponseGenerator() { return responseGenerator; }
    }
}


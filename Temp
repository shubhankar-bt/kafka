-- 1. CREATE TABLES
CREATE TABLE HELP_QUESTION_MASTER (
    QUESTION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SCREEN_NAME VARCHAR2(255) NOT NULL, -- Exact match for React UI Screen Name
    QUESTION_TEXT VARCHAR2(1000) NOT NULL,
    ANSWER_CONTENT VARCHAR2(4000) NOT NULL,
    PERMISSION_ID NUMBER, -- Matches MENU_ID
    ACTION_LINK VARCHAR2(255), 
    ACTION_LABEL VARCHAR2(255),
    PRO_TIP VARCHAR2(1000),
    IS_ACTIVE VARCHAR2(1) DEFAULT 'Y'
);

CREATE TABLE HELP_FAQ_MASTER (
    FAQ_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    QUESTION_TEXT VARCHAR2(1000) NOT NULL,
    ANSWER_CONTENT VARCHAR2(4000) NOT NULL,
    VIEW_COUNT NUMBER DEFAULT 0, -- Tracks Popularity
    IS_ACTIVE VARCHAR2(1) DEFAULT 'Y'
);

CREATE TABLE KNOWLEDGE_BASE_MASTER (
    DOC_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TOPIC VARCHAR2(255) NOT NULL,
    CONTENT_PARAGRAPH VARCHAR2(4000) NOT NULL,
    PERMISSION_ID NUMBER, -- NULL = Global
    IS_ACTIVE VARCHAR2(1) DEFAULT 'Y'
);

-- (HELP_INTERACTION_LOGS remains the same as previously defined)

-- 2. AUTO-SEED PROCEDURAL KNOWLEDGE (The "Magic" Script)
-- This reads your PERMISSIONS table and generates Help Questions for every single module!
INSERT INTO HELP_QUESTION_MASTER (SCREEN_NAME, QUESTION_TEXT, ANSWER_CONTENT, PERMISSION_ID, ACTION_LINK, ACTION_LABEL, IS_ACTIVE)
SELECT 
    COALESCE(MENU_SUBMENU, MENU_TITLE), -- Fixes the NULL submenu issue (e.g., Balance Enquiry)
    'How do I use the ' || COALESCE(MENU_SUBMENU, MENU_TITLE) || ' screen?',
    MENU_DESCRIPTION || '. You can perform the following actions here: ' || REPLACE(MENU_ACTION, '|', ', ') || '.',
    MENU_ID,
    MENU_URL,
    'Go to ' || COALESCE(MENU_SUBMENU, MENU_TITLE),
    'Y'
FROM PERMISSIONS
WHERE MENU_URL IS NOT NULL AND MENU_DESCRIPTION IS NOT NULL;

-- 3. INSERT SAMPLE GLOBAL FAQS
INSERT INTO HELP_FAQ_MASTER (QUESTION_TEXT, ANSWER_CONTENT, VIEW_COUNT, IS_ACTIVE) VALUES ('How do I reset my password?', 'Click on your profile icon in the top right, select Settings, and click Change Password.', 15, 'Y');
INSERT INTO HELP_FAQ_MASTER (QUESTION_TEXT, ANSWER_CONTENT, VIEW_COUNT, IS_ACTIVE) VALUES ('Who do I contact for IT Support?', 'Please email fincore-it@bank.com or call extension 4455.', 42, 'Y');













package com.fincore.helpservice.model;

import jakarta.persistence.*;
import lombok.Data;

@Entity
@Table(name = "HELP_FAQ_MASTER")
@Data
public class HelpFaqEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "FAQ_ID")
    private Long faqId;

    @Column(name = "QUESTION_TEXT", length = 1000)
    private String questionText;

    @Column(name = "ANSWER_CONTENT", length = 4000)
    private String answerContent;

    @Column(name = "VIEW_COUNT")
    private Long viewCount;

    @Column(name = "IS_ACTIVE", length = 1)
    private String isActive;
}










package com.fincore.helpservice.repository;

import com.fincore.helpservice.model.HelpFaqEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface HelpFaqRepository extends JpaRepository<HelpFaqEntity, Long> {
    // Fetch Top 10 most popular active FAQs to display in the Quick Actions menu
    List<HelpFaqEntity> findTop10ByIsActiveOrderByViewCountDesc(String isActive);
    
    Optional<HelpFaqEntity> findByQuestionTextAndIsActive(String questionText, String isActive);
}











package com.fincore.helpservice.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class PermissionService {

    private final JdbcTemplate jdbcTemplate;

    public List<String> getAllAllowedPermissionIdsForRole(String roleId) {
        String sql = "SELECT CAST(p.PERMISSION_ID AS VARCHAR2(50)) FROM PERMISSIONS p JOIN ROLE_PERMISSIONS rp ON p.PERMISSION_ID = rp.PERMISSION_ID WHERE rp.ROLE_ID = ? AND p.IS_ACTIVE = 'Y'";
        return jdbcTemplate.queryForList(sql, String.class, roleId);
    }

    public List<String> getAllowedActionNamesForRole(String roleId) {
        String sql = "SELECT p.PERMISSION_NAME FROM PERMISSIONS p JOIN ROLE_PERMISSIONS rp ON p.PERMISSION_ID = rp.PERMISSION_ID WHERE rp.ROLE_ID = ? AND p.IS_ACTIVE = 'Y'";
        return jdbcTemplate.queryForList(sql, String.class, roleId);
    }

    /**
     * LIVE DATA INJECTION: Prevents stale vectors by fetching ETL date at query time.
     */
    public String getLiveEtlDate() {
        try {
            String sql = "SELECT TO_CHAR(ETL_DATE, 'DD-Mon-YYYY') FROM FINCORE_DATE FETCH FIRST 1 ROWS ONLY";
            return jdbcTemplate.queryForObject(sql, String.class);
        } catch (Exception e) {
            log.warn("Could not fetch ETL Date", e);
            return "System Date Unavailable";
        }
    }
}

















package com.fincore.helpservice.controller;

import com.fincore.helpservice.dto.HelpRequestDTO;
import com.fincore.helpservice.dto.HelpResponseDTO;
import com.fincore.helpservice.service.FinCoreChatAgent;
import com.fincore.helpservice.service.HelpAnalyticsService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

/**
 * Primary REST Controller. 
 * Implements the Unified Single AI Pathway and Guided Menus.
 */
@RestController
@RequestMapping("/api/help")
@RequiredArgsConstructor
@Slf4j
public class HelpController {

    private final FinCoreChatAgent chatAgent;
    private final HelpAnalyticsService analyticsService;

    @PostMapping("/chat")
    public ResponseEntity<HelpResponseDTO> handleChatQuery(
            @RequestHeader("X-User-Id") String userId,
            @RequestHeader("X-Role-Id") String roleId,
            @RequestBody HelpRequestDTO request) {

        log.info("[API] Chat request received - Screen: {} | Msg: {}", request.getCurrentScreen(), request.getUserMessage());

        HelpResponseDTO response = chatAgent.handleChat(userId, roleId, request.getUserMessage(), request.getCurrentScreen());
        return ResponseEntity.ok(response);
    }

    @PostMapping("/feedback")
    public ResponseEntity<Void> submitChatFeedback(
            @RequestHeader("X-User-Id") String userId,
            @RequestBody Map<String, Object> feedbackPayload) {

        Long logId = Long.valueOf(feedbackPayload.get("logId").toString());
        boolean isHelpful = (Boolean) feedbackPayload.get("isHelpful");
        analyticsService.updateFeedback(logId, isHelpful);
        return ResponseEntity.ok().build();
    }
    
    // Allows UI to increment the Popularity of an FAQ when a user clicks the suggestion bubble
    @PostMapping("/faqs/track")
    public ResponseEntity<Void> trackFaqClick(@RequestBody Map<String, String> payload) {
        String question = payload.get("questionText");
        chatAgent.incrementFaqPopularity(question);
        return ResponseEntity.ok().build();
    }
}















package com.fincore.helpservice.service;

import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.model.KnowledgeBaseEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.fincore.helpservice.repository.KnowledgeBaseRepository;
import dev.langchain4j.data.document.Document;
import dev.langchain4j.data.document.Metadata;
import dev.langchain4j.data.document.splitter.DocumentSplitters;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class DocumentIngestionService {

    private final HelpQuestionRepository questionRepository;
    private final KnowledgeBaseRepository knowledgeBaseRepository;
    private final HelpFaqRepository faqRepository; // NEW: Added FAQs

    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> embeddingStore;

    @EventListener(ApplicationReadyEvent.class)
    public void ingestKnowledgeBase() {
        log.info("[AI-INGEST] Starting Knowledge Ingestion to Redis via mxbai-embed...");
        List<Document> allDocuments = new ArrayList<>();

        // 1. PROCEDURAL DATA
        List<HelpQuestionEntity> questions = questionRepository.findByIsActive("Y");
        for (HelpQuestionEntity q : questions) {
            String content = "Module: " + (q.getScreenName() != null ? q.getScreenName() : "General") +
                    "\nQuestion: " + q.getQuestionText() + "\nAnswer: " + q.getAnswerContent();
            String permId = q.getPermissionId() != null ? String.valueOf(q.getPermissionId()) : "GLOBAL";
            Metadata metadata = new Metadata().put("permissionId", permId)
                    .put("actionLink", q.getActionLink() != null ? q.getActionLink() : "NONE")
                    .put("actionLabel", q.getActionLabel() != null ? q.getActionLabel() : "NONE")
                    .put("dataType", "PROCEDURAL");
            allDocuments.add(Document.from(content, metadata));
        }

        // 2. CONCEPTUAL DATA
        List<KnowledgeBaseEntity> knowledgeBase = knowledgeBaseRepository.findByIsActive("Y");
        for (KnowledgeBaseEntity kb : knowledgeBase) {
            String content = "Topic: " + kb.getTopic() + "\nInformation: " + kb.getContentParagraph();
            String permId = kb.getPermissionId() != null ? String.valueOf(kb.getPermissionId()) : "GLOBAL";
            Metadata metadata = new Metadata().put("permissionId", permId)
                    .put("actionLink", "NONE").put("actionLabel", "NONE").put("dataType", "CONCEPTUAL");
            allDocuments.add(Document.from(content, metadata));
        }

        // 3. FAQS
        List<HelpFaqEntity> faqs = faqRepository.findAll();
        for (HelpFaqEntity faq : faqs) {
            if ("Y".equals(faq.getIsActive())) {
                String content = "FAQ Question: " + faq.getQuestionText() + "\nAnswer: " + faq.getAnswerContent();
                Metadata metadata = new Metadata().put("permissionId", "GLOBAL") // FAQs are Global
                        .put("actionLink", "NONE").put("actionLabel", "NONE").put("dataType", "FAQ");
                allDocuments.add(Document.from(content, metadata));
            }
        }

        // CHUNK & SAVE TO REDIS
        if (!allDocuments.isEmpty()) {
            List<TextSegment> segments = DocumentSplitters.recursive(300, 50).splitAll(allDocuments);
            List<Embedding> embeddings = embeddingModel.embedAll(segments).content();

            for (int i = 0; i < segments.size(); i++) {
                TextSegment segment = segments.get(i);
                Embedding vector = embeddings.get(i);
                String dataType = segment.metadata().getString("dataType");
                String perm = segment.metadata().getString("permissionId");
                String deterministicId = dataType + "_" + perm + "_chunk_" + i;
                embeddingStore.add(deterministicId, vector, segment);
            }
            log.info("[AI-INGEST] Saved {} vectors.", segments.size());
        }
    }
}














package com.fincore.helpservice.service;

import com.fincore.helpservice.dto.HelpResponseDTO;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.message.AiMessage;
import dev.langchain4j.data.message.SystemMessage;
import dev.langchain4j.data.message.UserMessage;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.memory.ChatMemory;
import dev.langchain4j.memory.chat.MessageWindowChatMemory;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingMatch;
import dev.langchain4j.store.embedding.EmbeddingSearchRequest;
import dev.langchain4j.store.embedding.EmbeddingSearchResult;
import dev.langchain4j.store.embedding.EmbeddingStore;
import dev.langchain4j.store.embedding.filter.Filter;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

import static dev.langchain4j.store.embedding.filter.MetadataFilterBuilder.metadataKey;

@Service
@RequiredArgsConstructor
@Slf4j
public class FinCoreChatAgent {

    private final ChatLanguageModel chatClient;
    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> vectorStore;
    
    private final PermissionService permissionService;
    private final ChatSessionService sessionService;
    private final HelpAnalyticsService analyticsService;
    
    // Repositories for Guided Menus
    private final HelpQuestionRepository questionRepository;
    private final HelpFaqRepository faqRepository;

    private final Cache<String, ChatMemory> userMemories = Caffeine.newBuilder()
            .expireAfterAccess(30, TimeUnit.MINUTES)
            .maximumSize(10000)
            .build();

    public HelpResponseDTO handleChat(String userId, String roleId, String userMessage, String currentScreen) {
        log.info("[AI-CHAT] Processing query for User: {}", userId);

        try {
            // ========================================================================
            // 0. GUIDED MENUS (System Slash Commands)
            // ========================================================================
            if ("/action faq".equalsIgnoreCase(userMessage.trim())) {
                List<String> faqQuestions = faqRepository.findTop10ByIsActiveOrderByViewCountDesc("Y")
                        .stream().map(HelpFaqEntity::getQuestionText).collect(Collectors.toList());

                return HelpResponseDTO.builder()
                        .responseType("SUGGESTION")
                        .botReply("Here are a few frequently asked questions:")
                        .items(faqQuestions)
                        .build();
            }

            if (userMessage.trim().startsWith("/action module")) {
                String requestedScreen = userMessage.replace("/action module", "").trim();
                List<String> moduleQuestions = questionRepository.findByScreenNameAndIsActive(requestedScreen, "Y")
                        .stream().map(HelpQuestionEntity::getQuestionText).collect(Collectors.toList());

                if (moduleQuestions.isEmpty()) {
                    return HelpResponseDTO.builder()
                            .responseType("TEXT_REPLY")
                            .botReply("I don't have predefined questions for " + requestedScreen + ", but feel free to ask me anything about it!")
                            .build();
                }

                return HelpResponseDTO.builder()
                        .responseType("SUGGESTION")
                        .botReply("Here are a few common questions for " + requestedScreen + ":")
                        .items(moduleQuestions)
                        .build();
            }

            // ========================================================================
            // 1. RAG AI PIPELINE (For regular typed questions or clicked suggestions)
            // ========================================================================
            if (sessionService.isEscalationRequired(userId)) {
                log.warn("[AI-CHAT] User {} requires IT escalation.", userId);
                sessionService.resetStrikes(userId);
                return HelpResponseDTO.builder()
                        .responseType("ESCALATION_OFFER")
                        .botReply("I seem to be having trouble helping you today. Would you like me to raise an IT Support Ticket with your chat history attached?")
                        .build();
            }

            // RBAC FETCH
            List<String> allowedPerms = permissionService.getAllAllowedPermissionIdsForRole(roleId)
                    .stream().map(String::valueOf).collect(Collectors.toList());
            allowedPerms.add("GLOBAL");
            List<String> allowedActionNames = permissionService.getAllowedActionNamesForRole(roleId);

            // VECTOR SEARCH WITH SCREEN BOOSTER
            String enhancedSearchQuery = userMessage;
            if (currentScreen != null && !currentScreen.isEmpty()) {
                enhancedSearchQuery = userMessage + " regarding the " + currentScreen + " screen.";
            }

            Embedding queryEmbedding = embeddingModel.embed(enhancedSearchQuery).content();
            Filter rbacFilter = metadataKey("permissionId").isIn(allowedPerms);

            EmbeddingSearchRequest searchRequest = EmbeddingSearchRequest.builder()
                    .queryEmbedding(queryEmbedding)
                    .maxResults(3)
                    .minScore(0.65)
                    .filter(rbacFilter)
                    .build();

            EmbeddingSearchResult<TextSegment> searchResult = vectorStore.search(searchRequest);
            List<EmbeddingMatch<TextSegment>> matches = searchResult.matches();

            // CONTEXT EXTRACTION
            boolean hasBankingContext = !matches.isEmpty();
            StringBuilder contextBuilder = new StringBuilder();
            String primaryActionLink = null;
            String primaryActionLabel = null;

            if (hasBankingContext) {
                for (EmbeddingMatch<TextSegment> match : matches) {
                    contextBuilder.append("- ").append(match.embedded().text()).append("\n\n");
                    if (primaryActionLink == null) {
                        String link = match.embedded().metadata().getString("actionLink");
                        if (!"NONE".equals(link)) {
                            primaryActionLink = link;
                            primaryActionLabel = match.embedded().metadata().getString("actionLabel");
                        }
                    }
                }
            } else {
                contextBuilder.append("NO_BANKING_CONTEXT_FOUND");
            }

            // PROMPT INJECTION (With Live ETL Date!)
            String liveEtlDate = permissionService.getLiveEtlDate();
            String currentTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("EEEE, MMMM dd, yyyy - hh:mm a"));
            String currentScreenContext = (currentScreen != null && !currentScreen.isEmpty()) ? currentScreen : "Unknown";

            String dynamicPrompt = """
                    You are the FinCore Smart Assistant, an advanced AI banking bot developed by Shubhankar.
                    
                    Current Time: %s
                    System ETL Date: %s
                    User's Current Screen: %s
                    User's Allowed Actions: %s
                    
                    CRITICAL BEHAVIORAL RULES:
                    1. BANKING QUERIES: You must ONLY answer using the exact Context provided below.
                    2. OUT OF SCOPE: If the answer is not in the Context, reply EXACTLY with: 'I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.'
                    3. SMALL TALK: If the user explicitly asks casual questions, answer politely.
                    4. SCREEN CONTEXT: Use the user's Current Screen to understand vague questions.
                    5. ETL DATE: If asked for the current date of data/ETL, use the System ETL Date provided above.
                    
                    --- BANKING CONTEXT RETRIEVED FROM DATABASE ---
                    %s
                    """.formatted(currentTime, liveEtlDate, currentScreenContext, allowedActionNames, contextBuilder.toString());

            if (!hasBankingContext) {
                dynamicPrompt += "\nWARNING: The Context is EMPTY. You are ONLY allowed to execute Rule 3 (Small Talk). Otherwise, execute Rule 2 (Out of Scope).";
            }

            ChatMemory memory = userMemories.get(userId, k -> MessageWindowChatMemory.withMaxMessages(5));
            memory.add(UserMessage.from(userMessage));

            log.info("[AI-CHAT] Sending Prompt to Phi-3 LLM...");
            AiMessage responseMessage = chatClient.generate(
                    SystemMessage.from(dynamicPrompt),
                    memory.messages().get(memory.messages().size() - 1)
            ).content();

            String aiResponse = responseMessage.text();
            memory.add(responseMessage);

            if (aiResponse.contains("I cannot find this information")) {
                sessionService.addStrikes(userId, 1);
                Long failLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "NO_MATCH", 0);
                return HelpResponseDTO.builder().responseType("NO_MATCH").botReply(aiResponse).logId(failLogId).build();
            } else {
                sessionService.resetStrikes(userId);
                Long successLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "ANSWERED", 99);
                return HelpResponseDTO.builder()
                        .responseType("TEXT_REPLY")
                        .botReply(aiResponse)
                        .navigationLink(primaryActionLink)
                        .navigationLabel(primaryActionLabel)
                        .logId(successLogId)
                        .build();
            }

        } catch (Exception e) {
            log.error("[AI-CHAT] Critical AI Generation Failure", e);
            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply("I am currently experiencing a cognitive delay. Please try again in a moment.")
                    .build();
        }
    }

    public void incrementFaqPopularity(String questionText) {
        faqRepository.findByQuestionTextAndIsActive(questionText, "Y").ifPresent(faq -> {
            faq.setViewCount(faq.getViewCount() + 1);
            faqRepository.save(faq);
        });
    }
}











package com.fincore.helpservice.service;

import com.fincore.helpservice.dto.HelpResponseDTO;
import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.message.AiMessage;
import dev.langchain4j.data.message.ChatMessage;
import dev.langchain4j.data.message.SystemMessage;
import dev.langchain4j.data.message.UserMessage;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.memory.ChatMemory;
import dev.langchain4j.memory.chat.MessageWindowChatMemory;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingMatch;
import dev.langchain4j.store.embedding.EmbeddingSearchRequest;
import dev.langchain4j.store.embedding.EmbeddingSearchResult;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class FinCoreChatAgent {

    private static final String FAILURE_MSG = "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.";

    private final ChatLanguageModel chatClient;
    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> vectorStore;
    private final PermissionService permissionService;
    private final ChatSessionService sessionService;
    private final HelpAnalyticsService analyticsService;
    private final HelpQuestionRepository questionRepository;
    private final HelpFaqRepository faqRepository;

    private final Cache<String, ChatMemory> userMemories = Caffeine.newBuilder()
            .expireAfterAccess(30, TimeUnit.MINUTES)
            .maximumSize(10000)
            .build();

    public HelpResponseDTO handleChat(String userId, String roleId, String userMessage, String currentScreen) {
        log.info("==================================================================");
        log.info("[AI-STEP-1: INIT] Processing query. User: {} | Role: {} | Msg: '{}'", userId, roleId, userMessage);

        try {
            // ========================================================================
            // GUIDED MENUS
            // ========================================================================
            if ("/action faq".equalsIgnoreCase(userMessage.trim())) {
                List<String> faqQuestions = faqRepository.findTop10ByIsActiveOrderByViewCountDesc("Y")
                        .stream().map(HelpFaqEntity::getQuestionText).collect(Collectors.toList());
                return HelpResponseDTO.builder().responseType("SUGGESTION").botReply("Here are a few frequently asked questions:").items(faqQuestions).build();
            }

            if (userMessage.trim().startsWith("/action module")) {
                String requestedScreen = userMessage.replace("/action module", "").trim();
                List<String> moduleQuestions = questionRepository.findByScreenNameAndIsActive(requestedScreen, "Y")
                        .stream().map(HelpQuestionEntity::getQuestionText).collect(Collectors.toList());
                
                if (moduleQuestions.isEmpty()) {
                    return HelpResponseDTO.builder().responseType("TEXT_REPLY").botReply("I don't have predefined questions for " + requestedScreen + " right now, but feel free to ask me anything about it!").build();
                }
                return HelpResponseDTO.builder().responseType("SUGGESTION").botReply("Here are a few common questions for the " + requestedScreen + " screen:").items(moduleQuestions).build();
            }

            if (sessionService.isEscalationRequired(userId)) {
                sessionService.resetStrikes(userId);
                return HelpResponseDTO.builder()
                        .responseType("ESCALATION_OFFER")
                        .botReply("I seem to be having trouble helping you today. Would you like me to raise an IT Support Ticket with your chat history attached?")
                        .build();
            }

            // ========================================================================
            // VECTOR DB FETCH & RBAC
            // ========================================================================
            List<String> allowedPerms = permissionService.getAllAllowedPermissionIdsForRole(roleId)
                    .stream().map(String::valueOf).collect(Collectors.toList());
            allowedPerms.add("GLOBAL");

            Embedding queryEmbedding = embeddingModel.embed(userMessage).content();
            EmbeddingSearchRequest searchRequest = EmbeddingSearchRequest.builder()
                    .queryEmbedding(queryEmbedding).maxResults(30).minScore(0.40).build();

            EmbeddingSearchResult<TextSegment> searchResult = vectorStore.search(searchRequest);

            List<EmbeddingMatch<TextSegment>> matches = searchResult.matches().stream()
                    .filter(match -> {
                        String docPerm = match.embedded().metadata().getString("permissionId");
                        return docPerm != null && allowedPerms.contains(docPerm);
                    })
                    .limit(3)
                    .collect(Collectors.toList());

            double highestScore = matches.isEmpty() ? 0.0 : matches.get(0).score();
            log.info("[AI-STEP-2: RBAC/REDIS] Safe contexts: {}. Highest Score: {}", matches.size(), highestScore);

            // ========================================================================
            // CONFIDENCE-BASED LINK ROUTING (Replaces hacky AI tagging)
            // ========================================================================
            StringBuilder contextBuilder = new StringBuilder();
            String primaryActionLink = null;
            String primaryActionLabel = null;

            if (!matches.isEmpty()) {
                for (EmbeddingMatch<TextSegment> match : matches) {
                    contextBuilder.append("- ").append(match.embedded().text()).append("\n\n");
                    
                    // Only attach navigation links if the mathematical match is strong (> 0.65)
                    // If it's a weak match (like "How are you?"), the UI gets no buttons.
                    if (primaryActionLink == null && highestScore >= 0.65) {
                        String link = match.embedded().metadata().getString("actionLink");
                        if (link != null && !"NONE".equals(link)) {
                            primaryActionLink = link;
                            primaryActionLabel = match.embedded().metadata().getString("actionLabel");
                        }
                    }
                }
            } else {
                contextBuilder.append("NO BANKING CONTEXT FOUND.");
            }

            // ========================================================================
            // THE LLaMA-3 MASTER PROMPT (Pure, Clean, Markdown-Native)
            // ========================================================================
            String liveEtlDate = permissionService.getLiveEtlDate();
            String currentTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("EEEE, MMMM dd, yyyy - hh:mm a"));
            String currentScreenContext = (currentScreen != null && !currentScreen.isEmpty()) ? currentScreen : "Unknown";

            String dynamicPrompt = """
                    You are the FinCore Smart Assistant, an advanced, highly capable AI banking bot.
                    Current Time: %s
                    System ETL Date: %s
                    User's Current Screen: %s
                    
                    <INSTRUCTIONS>
                    1. CASUAL CONVERSATION: If the user message is a greeting or small talk, respond warmly and dynamically.
                    2. BANKING QUERIES: For FinCore questions, rely EXCLUSIVELY on the <AUTHORIZED_CONTEXT> below.
                    3. DIRECT ANSWERS: Answer immediately. Do NOT use conversational preambles like "Here is the information".
                    4. UNAUTHORIZED / NO MATCH: If the <AUTHORIZED_CONTEXT> does not clearly answer the question, or says "NO BANKING CONTEXT FOUND", you MUST output the exact phrase below and NOTHING else (No apologies, no explanations):
                       %s
                    5. NO HALLUCINATION: Never invent rules or guess.
                    6. FORMATTING: Use standard Markdown formatting (**bold**, bullet points) for readability.
                    </INSTRUCTIONS>
                    
                    <AUTHORIZED_CONTEXT>
                    %s
                    </AUTHORIZED_CONTEXT>
                    """.formatted(currentTime, liveEtlDate, currentScreenContext, FAILURE_MSG, contextBuilder.toString());

            // ========================================================================
            // CALL LLAMA-3 WITH FULL MEMORY
            // ========================================================================
            ChatMemory memory = userMemories.get(userId, k -> MessageWindowChatMemory.withMaxMessages(5));
            memory.add(UserMessage.from(userMessage));

            List<ChatMessage> fullConversation = new ArrayList<>();
            fullConversation.add(SystemMessage.from(dynamicPrompt));
            fullConversation.addAll(memory.messages());

            log.info("[AI-STEP-3: LLM] Sending instructions and history to LLaMA-3...");
            AiMessage responseMessage = chatClient.generate(fullConversation).content();
            
            String aiResponse = responseMessage.text().trim();
            log.info("[AI-STEP-4: RAW RESPONSE] '{}'", aiResponse.replace("\n", " "));

            // ========================================================================
            // OUTPUT GUARDRAILS & LOGGING (No Regex Tag Stripping!)
            // ========================================================================
            if (aiResponse.contains("I cannot find this information") || aiResponse.contains(FAILURE_MSG)) {
                log.warn("[AI-STEP-5: SANITIZE] LLM context insufficient. Applying strict Failure Message.");
                sessionService.addStrikes(userId, 1);
                
                Long failLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "NO_MATCH", (int) (highestScore * 100));
                memory.add(AiMessage.from(FAILURE_MSG)); // Save clean text to memory
                
                return HelpResponseDTO.builder().responseType("NO_MATCH").botReply(FAILURE_MSG).logId(failLogId).build();
            }

            log.info("[AI-STEP-6: SUCCESS] Valid answer generated.");
            sessionService.resetStrikes(userId);
            
            // Pure, unpolluted memory addition
            memory.add(responseMessage);

            // If score was low, we classify it as Small Talk in analytics
            String intentLog = (highestScore < 0.65) ? "SMALL_TALK" : "ANSWERED";
            Long successLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, intentLog, (int) (highestScore * 100));

            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply(aiResponse)
                    .navigationLink(primaryActionLink)
                    .navigationLabel(primaryActionLabel)
                    .logId(successLogId)
                    .build();

        } catch (Exception e) {
            log.error("[AI-STEP-ERROR] Critical AI Generation Failure", e);
            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply("I am currently experiencing a cognitive delay. Please try again in a moment.")
                    .build();
        }
    }

    public void incrementFaqPopularity(String questionText) {
        faqRepository.findByQuestionTextAndIsActive(questionText, "Y").ifPresent(faq -> {
            faq.setViewCount(faq.getViewCount() + 1);
            faqRepository.save(faq);
        });
    }
}









help_interaction_logs log data in db :

148	2488766	AI_RAG	Who developed you?	ANSWERED	73		27-02-26 11:49:30.642541000 AM
147	2488766	AI_RAG	Can you check i have permissions to download reports or not?	NO_MATCH	81		27-02-26 11:47:48.652107000 AM
146	2488766	AI_RAG	How to create a segment?	ANSWERED	83		27-02-26 11:45:20.428090000 AM
145	2488766	AI_RAG	Clear your memory	ANSWERED	70		27-02-26 11:42:22.663470000 AM
144	2488766	AI_RAG	Can you tell me what is cgl standsd for	ANSWERED	82		27-02-26 11:32:13.542153000 AM
143	2488766	AI_RAG	I am getting difficulties while creating cgl. What to do?	ANSWERED	87		27-02-26 11:28:51.660363000 AM
142	2488766	AI_RAG	Nice, What about you?	ANSWERED	71		27-02-26 11:26:00.603599000 AM
141	2488766	AI_RAG	Hi	ANSWERED	76		27-02-26 11:23:22.676155000 AM


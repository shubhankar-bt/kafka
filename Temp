package com.fincore.DashboardService.service;

import com.fincore.DashboardService.model.NotificationOutbox;
import com.fincore.DashboardService.repository.DashboardStatsRepository;
import com.fincore.DashboardService.repository.DashboardStatsRepository.RoleBottleneck;
import com.fincore.DashboardService.repository.NotificationOutboxRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class IntelligenceSchedulerService {

    private final DashboardStatsRepository statsRepo;
    private final NotificationOutboxRepository outboxRepo;

    /**
     * Daily Job (9:00 AM): BOTTLENECK DETECTION
     * Scans for ROLES that have > 5 items pending for more than 48 hours.
     * Sends a specific, descriptive alert to each bottlenecked role.
     */
    @Scheduled(cron = "0 0 9 * * ?") // 9 AM Daily
    @Transactional
    public void runBottleneckDetection() {
        log.info("üïµÔ∏è Starting Daily Intelligence Scan: Bottleneck Detection...");

        List<RoleBottleneck> bottlenecks = statsRepo.findAllBottleneckRoles();

        if (bottlenecks.isEmpty()) {
            log.info("‚úÖ No bottlenecks detected today.");
            return;
        }

        log.warn("‚ö†Ô∏è Detected {} roles with critical bottlenecks.", bottlenecks.size());

        for (RoleBottleneck role : bottlenecks) {
            String roleIdStr = role.getRoleId();
            
            if (roleIdStr == null || roleIdStr.trim().isEmpty()) {
                continue;
            }

            // Construct Descriptive Message (Header + Details)
            String message = String.format(
                "‚ö†Ô∏è Action Required: Pending Approvals\n" +
                "Your role has %d request(s) pending for more than 48 hours. " +
                "Please visit the Dashboard to review and clear your queue.", 
                role.getOverdueCount()
            );
            
            // Create Notification Event (Outbox Pattern)
            // Targeted specifically at THIS role so they see THEIR count.
            NotificationOutbox event = NotificationOutbox.builder()
                    .userId(null) 
                    .targetRole(roleIdStr) // "51" -> Notification Service will notify all users with Role 51
                    .message(message)
                    .linkUrl("/dashboard") 
                    .eventSource("DASHBOARD_INTELLIGENCE")
                    .aggregateId("BOTTLENECK_" + System.currentTimeMillis()) 
                    .build();

            outboxRepo.save(event);
            log.info(" -> Notification dispatched for Role ID: {}", roleIdStr);
        }
    }
}



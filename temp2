package com.fincore.UserService.service;

import com.fincore.UserService.model.Permissions;
import com.fincore.UserService.repository.PermissionRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Service
@RequiredArgsConstructor
@Slf4j
public class PermissionCacheService {

    private final PermissionRepository permissionRepository;
    private final StringRedisTemplate redisTemplate;

    @Transactional(readOnly = true)
    public void refreshRolePermissions(Long roleId) {
        List<Permissions> perms = permissionRepository.findAllByRoleId(roleId);
        String redisKey = "RBAC::PERMISSIONS::" + roleId;
        
        redisTemplate.delete(redisKey);

        Set<String> redisValues = new HashSet<>();

        for (Permissions p : perms) {
            String dbUrl = p.getMenuUrl(); 
            String action = p.getMenuAction(); 
            String context = p.getMappedRequestType(); 

            String apiPath = mapDbUrlToApiPath(dbUrl); 
            String contextSuffix = (context == null || context.trim().isEmpty()) ? "*" : context;

            // --- LOGIC A: CONTEXT-BASED MAPPING (CRS + CMS) ---
            // If a permission has a Context (e.g. SEGMENT_CODE), it implies access to 
            // BOTH the Generic Write APIs (CRS) AND the Specific Read APIs (CMS).
            if (context != null && !context.isEmpty()) {
                
                // 1. MAP COMMON REQUEST SERVICE (Writes)
                if (containsAny(action, "create", "modify", "delete", "cancel", "approve", "reject")) {
                    // Maker Actions
                    redisValues.add("POST:/create-request|" + contextSuffix);
                    redisValues.add("POST:/update-request|" + contextSuffix); 
                    redisValues.add("POST:/cancel-request|" + contextSuffix);
                    
                    // Checker Actions
                    redisValues.add("PATCH:/update-request|" + contextSuffix);
                    redisValues.add("POST:/pending-requests|" + contextSuffix);
                }
                
                // 2. MAP COMMON MASTER SERVICE (Reads)
                // Even if DB action is just "create", you need to SEE the table to create/edit.
                // So we implicitly grant GET access to the relevant Master Data endpoints.
                addCommonMasterPermissions(redisValues, context, contextSuffix);

                // 3. MAP GENERIC VIEWS (My Requests)
                if (containsAny(action, "view", "create", "approve")) {
                    redisValues.add("POST:/my-requests|" + contextSuffix);
                    redisValues.add("GET:/all-requests|" + contextSuffix);
                }
                
                // 4. USER/ROLE MANAGEMENT EXCEPTIONS
                if ("USER_MANAGEMENT".equals(context)) {
                     redisValues.add("POST:/user/create-request|*"); 
                     redisValues.add("GET:/user/**|*");
                }
                if ("ROLE_MANAGEMENT".equals(context)) {
                     redisValues.add("POST:/role/create-role-request|*");
                     redisValues.add("GET:/role/**|*");
                }
            } 
            
            // --- LOGIC B: STANDARD REST MAPPING (Non-Context) ---
            else {
                String effectiveUrl = apiPath.endsWith("/**") ? apiPath : apiPath + "/**";

                if (action.contains("create")) redisValues.add("POST:" + effectiveUrl + "|*");
                
                if (action.contains("modify")) {
                    redisValues.add("PUT:" + effectiveUrl + "|*");
                    redisValues.add("PATCH:" + effectiveUrl + "|*");
                    redisValues.add("POST:" + effectiveUrl + "|*"); 
                }
                
                if (action.contains("delete")) redisValues.add("DELETE:" + effectiveUrl + "|*");
                
                if (action.contains("view")) {
                    redisValues.add("GET:" + effectiveUrl + "|*");
                    redisValues.add("POST:" + effectiveUrl + "|*"); 
                }
                
                if (action.contains("download")) {
                    redisValues.add("POST:" + effectiveUrl + "|*");
                    redisValues.add("GET:" + effectiveUrl + "|*");
                }
            }
        }

        if (!redisValues.isEmpty()) {
            redisTemplate.opsForSet().add(redisKey, redisValues.toArray(new String[0]));
        }
        log.info("âœ… Refreshed Role {}: {} permissions cached.", roleId, redisValues.size());
    }

    /**
     * Expands a Context (e.g. SEGMENT_CODE) into the specific CMS GET endpoints.
     * This fixes the issue where "/segment-codes" was denied.
     */
    private void addCommonMasterPermissions(Set<String> redisValues, String context, String suffix) {
        switch (context) {
            case "SEGMENT_CODE":
                redisValues.add("GET:/segment-codes|" + suffix);
                break;
            case "CGL_CODE":
                redisValues.add("GET:/cgls|" + suffix);
                redisValues.add("GET:/cgl-code-description-only|" + suffix);
                redisValues.add("GET:/cgl-codes|" + suffix);
                break;
            case "BRANCH":
                redisValues.add("GET:/branches|" + suffix);
                redisValues.add("GET:/branches-code-name-only|" + suffix);
                break;
            case "STATE":
                redisValues.add("GET:/states|" + suffix);
                break;
            case "CIRCLE":
                redisValues.add("GET:/circle-codes|" + suffix);
                // Zone is often needed with Circle
                redisValues.add("GET:/zone-codes|" + suffix); 
                break;
            case "CURRENCY":
                redisValues.add("GET:/currency-master|" + suffix);
                redisValues.add("GET:/currency-code-name-only|" + suffix);
                redisValues.add("GET:/currency|" + suffix);
                break;
            case "CALENDER":
                redisValues.add("GET:/calendar-configuration|" + suffix);
                break;
            case "CURRENCY_RATE_CHANGE":
                redisValues.add("GET:/currency-rate-change|" + suffix);
                break;
            default:
                log.debug("No specific CMS endpoints mapped for context: {}", context);
        }
    }

    private String mapDbUrlToApiPath(String dbUrl) {
        if (dbUrl == null) return "";
        if (dbUrl.equalsIgnoreCase("/glif-Reports")) return "/reports";
        if (dbUrl.equalsIgnoreCase("/transaction-enquiry")) return "/transactions";
        if (dbUrl.equalsIgnoreCase("/balance-enquiry")) return "/balance";
        if (dbUrl.startsWith("/role-management")) return "/role";
        if (dbUrl.startsWith("/user-management")) return "/user";
        if (dbUrl.startsWith("/process-status")) return "/processes";
        if (dbUrl.contains("journal-bulk-upload")) return "/journal-bulk-upload";
        return dbUrl;
    }

    private boolean containsAny(String input, String... keywords) {
        if (input == null) return false;
        for (String k : keywords) if (input.contains(k)) return true;
        return false;
    }
}



package com.fincore.NotificationService.controller;

import com.fincore.NotificationService.dto.TaskProgressDto;
import com.fincore.NotificationService.config.RedisConfig;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.scheduling.annotation.Async;
import org.springframework.web.bind.annotation.*;

import java.util.concurrent.CompletableFuture;

@RestController
@RequestMapping("/simulate")
@Slf4j
public class SimulationController {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    /**
     * Trigger a dummy task that runs for 'durationSeconds'.
     * Updates are sent every 5% increment.
     */
    @PostMapping("/task")
    public String triggerTask(
            @RequestParam String userId,
            @RequestParam String taskId,
            @RequestParam(defaultValue = "300") int durationSeconds // Default 5 mins (300s)
    ) {
        log.info("Starting simulation for Task: {} User: {} Duration: {}s", taskId, userId, durationSeconds);
        
        // Run asynchronously so the HTTP request returns immediately
        runHeavyTask(userId, taskId, durationSeconds);
        
        return "Task " + taskId + " started. Check SSE stream.";
    }

    @Async
    public void runHeavyTask(String userId, String taskId, int durationSeconds) {
        try {
            long totalSteps = 20; // 0%, 5%, 10% ... 100% (20 steps)
            long sleepPerStep = (durationSeconds * 1000L) / totalSteps;

            // Send 0%
            sendUpdate(taskId, userId, 0, "Task Started", "PROCESSING");

            for (int i = 1; i < totalSteps; i++) {
                Thread.sleep(sleepPerStep);
                int percent = i * 5;
                sendUpdate(taskId, userId, percent, "Processing chunk " + i + "...", "PROCESSING");
            }

            Thread.sleep(sleepPerStep);
            
            // Send 100%
            sendUpdate(taskId, userId, 100, "Task Completed", "COMPLETED");

        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }

    private void sendUpdate(String taskId, String userId, int percent, String msg, String status) {
        TaskProgressDto dto = TaskProgressDto.builder()
                .taskId(taskId)
                .userId(userId)
                .percentage(percent)
                .message(msg)
                .status(status)
                .build();

        log.info("Simulating Progress: {} - {}%", taskId, percent);
        redisTemplate.convertAndSend(RedisConfig.PROGRESS_TOPIC, dto);
    }
}


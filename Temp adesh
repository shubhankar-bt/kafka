package com.fincore.JournalService.Service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import java.util.HashSet;
import java.util.List;
import java.util.Set;

/**
 * Helper service to fetch Master Data for bulk validation.
 * Fetches entire active sets to allow O(1) in-memory validation.
 * * CORRECTED QUERY MAPPINGS:
 * - BranchMaster: Table 'BRANCH_MASTER', Column 'CODE', Status 'STATUS' (1=Active)
 * - CglMaster: Table 'CGL_MASTER', Column 'CGL_NUMBER', Status 'STATUS' (1=Active)
 * - CurrencyMaster: Table 'CURRENCY_MASTER', Column 'CURRENCY_CODE', Flag 'FLAG' (1=Active)
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class ValidationMasterService {

    @Autowired
    @Qualifier("oracleJdbcTemplate")
    private JdbcTemplate jdbcTemplate;

    public Set<String> getAllActiveBranches() {
        long start = System.currentTimeMillis();
        // Fixed Column Name: CODE instead of BRANCH_CODE
        // Assuming STATUS=1 means active based on typical Integer status patterns
        String sql = "SELECT CODE FROM BRANCH_MASTER WHERE STATUS = 1"; 
        List<String> list = jdbcTemplate.query(sql, (rs, rowNum) -> rs.getString(1));
        log.info("Loaded {} Active Branches in {}ms", list.size(), System.currentTimeMillis() - start);
        return new HashSet<>(list);
    }

    public Set<String> getAllActiveCurrencies() {
        long start = System.currentTimeMillis();
        // Correct Column: CURRENCY_CODE, Flag: 1
        String sql = "SELECT CURRENCY_CODE FROM CURRENCY_MASTER WHERE FLAG = 1";
        List<String> list = jdbcTemplate.query(sql, (rs, rowNum) -> rs.getString(1));
        log.info("Loaded {} Active Currencies in {}ms", list.size(), System.currentTimeMillis() - start);
        return new HashSet<>(list);
    }

    public Set<String> getAllActiveCgls() {
        long start = System.currentTimeMillis();
        // Fixed Column Name: CGL_NUMBER instead of CGL_CODE
        // Status is Boolean in Entity, maps to 1/0 in Oracle usually
        String sql = "SELECT CGL_NUMBER FROM CGL_MASTER WHERE STATUS = 1";
        List<String> list = jdbcTemplate.query(sql, (rs, rowNum) -> rs.getString(1));
        log.info("Loaded {} Active CGLs in {}ms", list.size(), System.currentTimeMillis() - start);
        return new HashSet<>(list);
    }
}



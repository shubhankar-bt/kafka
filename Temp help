test 1 :
{
   "userMessage": "Hi",
   "currentScreen": "Dashboard"
}


response :


{
    "responseType": "TEXT_REPLY",
    "botReply": "**Hello there!** It's great to chat with you today! How's your day going so far?",
    "navigationLink": "/journal-posting",
    "navigationLabel": "Go to Journal Posting",
    "logId": 141,
    "items": null
}




2026-02-27 11:22:28.804 INFO  [http-nio-9099-exec-1] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'Hi' 
2026-02-27 11:22:28.805 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: ================================================================== 
2026-02-27 11:22:28.805 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-1: INIT] Processing query. User: 2488766 | Role: 51 | Msg: 'Hi' 
2026-02-27 11:22:28.956 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-4: RBAC] User allowed permissions: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-27 11:22:29.083 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-5: REDIS] Found 10 raw matches before RBAC filtering. 
2026-02-27 11:22:29.085 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-6: FILTER] Safe contexts after RBAC: 3. Highest Score: 0.7649066746235 
2026-02-27 11:22:29.130 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-7: LLM] Sending instructions, 1 history messages, and context to LLaMA-3... 
2026-02-27 11:23:22.624 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-8: RESPONSE] Raw LLM Reply: '**Hello there!** It's great to chat with you today! How's your day going so far?' 
2026-02-27 11:23:22.650 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-9: SUCCESS] Valid answer generated! 







test 2 :

{
   "userMessage": "Nice, What about you?",
   "currentScreen": "Dashboard"
}


response :

{
    "responseType": "TEXT_REPLY",
    "botReply": "**I'm doing well, thanks for asking!** I'm always happy to help and assist with any questions or topics you'd like to discuss. It's a beautiful day outside, isn't it?",
    "navigationLink": "/journal-posting",
    "navigationLabel": "Go to Journal Posting",
    "logId": 142,
    "items": null
}


logs :

[API] Chat request received from User: 2488766 | Role: 51 | Message: 'Nice, What about you?' 
2026-02-27 11:25:00.757 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: ================================================================== 
2026-02-27 11:25:00.757 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-1: INIT] Processing query. User: 2488766 | Role: 51 | Msg: 'Nice, What about you?' 
2026-02-27 11:25:00.892 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-4: RBAC] User allowed permissions: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-27 11:25:01.168 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-5: REDIS] Found 10 raw matches before RBAC filtering. 
2026-02-27 11:25:01.169 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-6: FILTER] Safe contexts after RBAC: 3. Highest Score: 0.7192938923834999 
2026-02-27 11:25:01.199 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-7: LLM] Sending instructions, 3 history messages, and context to LLaMA-3... 
2026-02-27 11:26:00.571 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-8: RESPONSE] Raw LLM Reply: '**I'm doing well, thanks for asking!** I'm always happy to help and assist with any questions or topics you'd like to discuss. It's a beautiful day outside, isn't it?' 
2026-02-27 11:26:00.571 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-9: SUCCESS] Valid answer generated! 


test 3 :

{
   "userMessage": "I am getting difficulties while creating cgl. What to do?",
   "currentScreen": "Dashboard"
}


{
    "responseType": "TEXT_REPLY",
    "botReply": "**I can help you with that!**\n\nFor CGL Maker-Checker Lifecycle, please refer to the authorized context:\n\n* Module: Manage CGL's\n* Question: How do I use the Manage CGL's screen?\n* Answer: To edit or update active CGLs and to view pending CGL requests. You can perform the following actions here: view, create, modify, cancel.\n\nIf you're having difficulties creating a CGL, please try the following:\n\n• Ensure you have the necessary permissions to create a new CGL.\n• Review the CGL creation process and ensure you've filled out all required fields correctly.\n• If you're still experiencing issues, feel free to reach out to Fincore support for further assistance.\n\nI hope this helps!",
    "navigationLink": "/cgl-management",
    "navigationLabel": "Go to Manage CGL's",
    "logId": 143,
    "items": null
}





2026-02-27 11:27:16.486 INFO  [http-nio-9099-exec-5] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'I am getting difficulties while creating cgl. What to do?' 
2026-02-27 11:27:16.498 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: ================================================================== 
2026-02-27 11:27:16.499 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-1: INIT] Processing query. User: 2488766 | Role: 51 | Msg: 'I am getting difficulties while creating cgl. What to do?' 
2026-02-27 11:27:16.631 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-4: RBAC] User allowed permissions: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-27 11:27:16.824 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-5: REDIS] Found 10 raw matches before RBAC filtering. 
2026-02-27 11:27:16.825 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-6: FILTER] Safe contexts after RBAC: 3. Highest Score: 0.8764293789865 
2026-02-27 11:27:16.849 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-7: LLM] Sending instructions, 5 history messages, and context to LLaMA-3... 
2026-02-27 11:28:51.625 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-8: RESPONSE] Raw LLM Reply: '**I can help you with that!**  For CGL Maker-Checker Lifecycle, please refer to the authorized context:  * Module: Manage CGL's * Question: How do I use the Manage CGL's screen? * Answer: To edit or update active CGLs and to view pending CGL requests. You can perform the following actions here: view, create, modify, cancel.  If you're having difficulties creating a CGL, please try the following:  • Ensure you have the necessary permissions to create a new CGL. • Review the CGL creation process and ensure you've filled out all required fields correctly. • If you're still experiencing issues, feel free to reach out to Fincore support for further assistance.  I hope this helps!' 
2026-02-27 11:28:51.634 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-9: SUCCESS] Valid answer generated! 


test 4:

{
   "userMessage": "Can you tell me what is cgl standsd for",
   "currentScreen": "Dashboard"
}


{
    "responseType": "TEXT_REPLY",
    "botReply": "**CGL stands for Credit Guarantee Limit.**\n\nPlease note that I can only provide information based on the authorized context provided. If you have any further questions or concerns, feel free to ask!",
    "navigationLink": "/view-cgl-details",
    "navigationLabel": "Go to View CGL Details",
    "logId": 144,
    "items": null
}



2026-02-27 11:30:43.951 INFO  [http-nio-9099-exec-7] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'Can you tell me what is cgl standsd for' 
2026-02-27 11:30:44.065 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: ================================================================== 
2026-02-27 11:30:44.066 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-STEP-1: INIT] Processing query. User: 2488766 | Role: 51 | Msg: 'Can you tell me what is cgl standsd for' 
2026-02-27 11:30:44.199 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-STEP-4: RBAC] User allowed permissions: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-27 11:30:44.376 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-STEP-5: REDIS] Found 10 raw matches before RBAC filtering. 
2026-02-27 11:30:44.377 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-STEP-6: FILTER] Safe contexts after RBAC: 3. Highest Score: 0.8260694742205 
2026-02-27 11:30:44.400 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-STEP-7: LLM] Sending instructions, 5 history messages, and context to LLaMA-3... 
2026-02-27 11:32:13.509 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-STEP-8: RESPONSE] Raw LLM Reply: '**CGL stands for Credit Guarantee Limit.**  Please note that I can only provide information based on the authorized context provided. If you have any further questions or concerns, feel free to ask!' 
2026-02-27 11:32:13.517 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-STEP-9: SUCCESS] Valid answer generated! 















updates i have done :
.numPredict(200) // OPTIMIZATION: Hard cap output to ~250 words maximum


            // We use a low 0.50 threshold to ensure short queries (like "what is cgl?") are not accidentally dropped.
EmbeddingSearchRequest searchRequest = EmbeddingSearchRequest.builder()
                    .queryEmbedding(queryEmbedding)
                    .maxResults(20)
                    .minScore(0.65)
                    .build();


.limit(2)


ChatMemory memory = userMemories.get(userId, k -> MessageWindowChatMemory.withMaxMessages(3));




now after update lets test again:

test 1 :
{
   "userMessage": "Clear your memory",
   "currentScreen": "Dashboard"
}

resposne :
{
    "responseType": "TEXT_REPLY",
    "botReply": "I've cleared my memory! Let's start fresh. How are you doing today?",
    "navigationLink": "/balance-enquiry",
    "navigationLabel": "Go to Balance Enquiry",
    "logId": 145,
    "items": null
}

logs :

2026-02-27 11:41:34.960 INFO  [http-nio-9099-exec-1] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'Clear your memory' 
2026-02-27 11:41:34.961 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: ================================================================== 
2026-02-27 11:41:34.962 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-1: INIT] Processing query. User: 2488766 | Role: 51 | Msg: 'Clear your memory' 
2026-02-27 11:41:35.105 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-4: RBAC] User allowed permissions: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-27 11:41:35.230 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-5: REDIS] Found 10 raw matches before RBAC filtering. 
2026-02-27 11:41:35.232 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-6: FILTER] Safe contexts after RBAC: 2. Highest Score: 0.7073595821855 
2026-02-27 11:41:35.276 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-7: LLM] Sending instructions, 1 history messages, and context to LLaMA-3... 
2026-02-27 11:42:22.636 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-8: RESPONSE] Raw LLM Reply: 'I've cleared my memory! Let's start fresh. How are you doing today?' 
2026-02-27 11:42:22.637 INFO  [http-nio-9099-exec-1] c.f.h.s.FinCoreChatAgent: [AI-STEP-9: SUCCESS] Valid answer generated! 







test 2 :
{
   "userMessage": "How to create a segment?",
   "currentScreen": "Dashboard"
}


{
    "responseType": "TEXT_REPLY",
    "botReply": "**Creating a Segment**\n\nTo create a segment in the Manage Segments screen, follow these steps:\n\n* Go to the Manage Segments module\n* Click on the \"Create\" button\n* Fill in the required information for your new segment\n* Save your changes\n\nNote: The exact steps may vary depending on your specific FinCore setup and permissions.",
    "navigationLink": "/segment-management",
    "navigationLabel": "Go to Manage Segments",
    "logId": 146,
    "items": null
}


2026-02-27 11:44:16.689 INFO  [http-nio-9099-exec-3] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'How to create a segment?' 
2026-02-27 11:44:16.710 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: ================================================================== 
2026-02-27 11:44:16.711 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-1: INIT] Processing query. User: 2488766 | Role: 51 | Msg: 'How to create a segment?' 
2026-02-27 11:44:16.845 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-4: RBAC] User allowed permissions: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-27 11:44:16.997 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-5: REDIS] Found 10 raw matches before RBAC filtering. 
2026-02-27 11:44:16.998 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-6: FILTER] Safe contexts after RBAC: 2. Highest Score: 0.8348862826825 
2026-02-27 11:44:17.027 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-7: LLM] Sending instructions, 3 history messages, and context to LLaMA-3... 
2026-02-27 11:45:20.388 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-8: RESPONSE] Raw LLM Reply: '**Creating a Segment**  To create a segment in the Manage Segments screen, follow these steps:  * Go to the Manage Segments module * Click on the "Create" button * Fill in the required information for your new segment * Save your changes  Note: The exact steps may vary depending on your specific FinCore setup and permissions.' 
2026-02-27 11:45:20.399 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-STEP-9: SUCCESS] Valid answer generated! 



test 3 :

{
   "userMessage": "Can you check i have permissions to download reports or not?",
   "currentScreen": "Dashboard"
}

{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact Fincore support.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 147,
    "items": null
}


2026-02-27 11:46:51.166 INFO  [http-nio-9099-exec-5] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'Can you check i have permissions to download reports or not?' 
2026-02-27 11:46:51.179 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: ================================================================== 
2026-02-27 11:46:51.181 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-1: INIT] Processing query. User: 2488766 | Role: 51 | Msg: 'Can you check i have permissions to download reports or not?' 
2026-02-27 11:46:51.313 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-4: RBAC] User allowed permissions: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-27 11:46:51.486 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-5: REDIS] Found 10 raw matches before RBAC filtering. 
2026-02-27 11:46:51.486 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-6: FILTER] Safe contexts after RBAC: 2. Highest Score: 0.813115030527 
2026-02-27 11:46:51.510 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-7: LLM] Sending instructions, 3 history messages, and context to LLaMA-3... 
2026-02-27 11:47:48.616 INFO  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-8: RESPONSE] Raw LLM Reply: 'I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact Fincore support.' 
2026-02-27 11:47:48.617 WARN  [http-nio-9099-exec-5] c.f.h.s.FinCoreChatAgent: [AI-STEP-9: SANITIZE] LLM decided context was insufficient. Applying Failure Message. 
2026-02-27 11:47:48.627 WARN  [http-nio-9099-exec-5] c.f.h.s.ChatSessionService: [SESSION] User 2488766 gained a strike. Current strikes: 1/3 



test 4:

{
   "userMessage": "Who developed you?",
   "currentScreen": "Dashboard"
}


{
    "responseType": "TEXT_REPLY",
    "botReply": "**I was developed by Shubhankar, a software developer from the Fincore Development Team!**",
    "navigationLink": "/manage-user",
    "navigationLabel": "Go to Manage Users",
    "logId": 148,
    "items": null
}


2026-02-27 11:48:37.217 INFO  [http-nio-9099-exec-6] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Role: 51 | Message: 'Who developed you?' 
2026-02-27 11:48:37.227 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: ================================================================== 
2026-02-27 11:48:37.229 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [AI-STEP-1: INIT] Processing query. User: 2488766 | Role: 51 | Msg: 'Who developed you?' 
2026-02-27 11:48:37.363 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [AI-STEP-4: RBAC] User allowed permissions: [1, 2, 5, 6, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 81, 101, 102, 103, 121, GLOBAL] 
2026-02-27 11:48:37.504 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [AI-STEP-5: REDIS] Found 10 raw matches before RBAC filtering. 
2026-02-27 11:48:37.504 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [AI-STEP-6: FILTER] Safe contexts after RBAC: 2. Highest Score: 0.738570213318 
2026-02-27 11:48:37.527 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [AI-STEP-7: LLM] Sending instructions, 3 history messages, and context to LLaMA-3... 
2026-02-27 11:49:30.617 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [AI-STEP-8: RESPONSE] Raw LLM Reply: '**I was developed by Shubhankar, a software developer from the Fincore Development Team!**' 
2026-02-27 11:49:30.618 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [AI-STEP-9: SUCCESS] Valid answer generated! 













current code :

package com.fincore.helpservice.service;

import com.fincore.helpservice.dto.HelpResponseDTO;
import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.message.AiMessage;
import dev.langchain4j.data.message.ChatMessage;
import dev.langchain4j.data.message.SystemMessage;
import dev.langchain4j.data.message.UserMessage;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.memory.ChatMemory;
import dev.langchain4j.memory.chat.MessageWindowChatMemory;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingMatch;
import dev.langchain4j.store.embedding.EmbeddingSearchRequest;
import dev.langchain4j.store.embedding.EmbeddingSearchResult;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class FinCoreChatAgent {

    private static final String FAILURE_MSG = "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact Fincore support.";

    private final ChatLanguageModel chatClient;
    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> vectorStore;
    private final PermissionService permissionService;
    private final ChatSessionService sessionService;
    private final HelpAnalyticsService analyticsService;
    private final HelpQuestionRepository questionRepository;
    private final HelpFaqRepository faqRepository;

    private final Cache<String, ChatMemory> userMemories = Caffeine.newBuilder()
            .expireAfterAccess(30, TimeUnit.MINUTES)
            .maximumSize(10000)
            .build();

    public HelpResponseDTO handleChat(String userId, String roleId, String userMessage, String currentScreen) {
        log.info("==================================================================");
        log.info("[AI-STEP-1: INIT] Processing query. User: {} | Role: {} | Msg: '{}'", userId, roleId, userMessage);

        try {
            // ========================================================================
            // GUIDED MENUS (Fast DB Fetch)
            // ========================================================================
            if ("/action faq".equalsIgnoreCase(userMessage.trim())) {
                log.info("[AI-STEP-2: COMMAND] Executing FAQ Quick Action.");
                List<String> faqQuestions = faqRepository.findTop10ByIsActiveOrderByViewCountDesc("Y")
                        .stream().map(HelpFaqEntity::getQuestionText).collect(Collectors.toList());
                return HelpResponseDTO.builder().responseType("SUGGESTION").botReply("Here are a few frequently asked questions:").items(faqQuestions).build();
            }

            if (userMessage.trim().startsWith("/action module")) {
                String requestedScreen = userMessage.replace("/action module", "").trim();
                log.info("[AI-STEP-2: COMMAND] Executing Module Quick Action for: {}", requestedScreen);
                List<String> moduleQuestions = questionRepository.findByScreenNameAndIsActive(requestedScreen, "Y")
                        .stream().map(HelpQuestionEntity::getQuestionText).collect(Collectors.toList());

                if (moduleQuestions.isEmpty()) {
                    return HelpResponseDTO.builder().responseType("TEXT_REPLY").botReply("I don't have predefined questions for " + requestedScreen + ", but feel free to ask me anything about it!").build();
                }
                return HelpResponseDTO.builder().responseType("SUGGESTION").botReply("Here are a few common questions for " + requestedScreen + ":").items(moduleQuestions).build();
            }

            // ========================================================================
            // ESCALATION CHECK
            // ========================================================================
            if (sessionService.isEscalationRequired(userId)) {
                log.warn("[AI-STEP-3: ESCALATION] User hit max failures. Offering IT Support.");
                sessionService.resetStrikes(userId);
                return HelpResponseDTO.builder()
                        .responseType("ESCALATION_OFFER")
                        .botReply("I seem to be having trouble helping you today. Would you like me to raise an IT Support Ticket with your chat history attached?")
                        .build();
            }

            // ========================================================================
            // VECTOR DB FETCH & RBAC FILTERING
            // ========================================================================
            List<String> allowedPerms = permissionService.getAllAllowedPermissionIdsForRole(roleId)
                    .stream().map(String::valueOf).collect(Collectors.toList());
            allowedPerms.add("GLOBAL");
            log.info("[AI-STEP-4: RBAC] User allowed permissions: {}", allowedPerms);

            Embedding queryEmbedding = embeddingModel.embed(userMessage).content();

            // We use a low 0.50 threshold to ensure short queries (like "what is cgl?") are not accidentally dropped.
            EmbeddingSearchRequest searchRequest = EmbeddingSearchRequest.builder()
                    .queryEmbedding(queryEmbedding)
                    .maxResults(20)
                    .minScore(0.65)
                    .build();

            EmbeddingSearchResult<TextSegment> searchResult = vectorStore.search(searchRequest);
            log.info("[AI-STEP-5: REDIS] Found {} raw matches before RBAC filtering.", searchResult.matches().size());

            // Filter ONLY what the user is allowed to see
            List<EmbeddingMatch<TextSegment>> matches = searchResult.matches().stream()
                    .filter(match -> {
                        String docPerm = match.embedded().metadata().getString("permissionId");
                        return docPerm != null && allowedPerms.contains(docPerm);
                    })
                    .limit(2)
                    .toList();

            double highestScore = matches.isEmpty() ? 0.0 : matches.getFirst().score();
            log.info("[AI-STEP-6: FILTER] Safe contexts after RBAC: {}. Highest Score: {}", matches.size(), highestScore);

            // ========================================================================
            // CONFIDENCE-BASED LINK ROUTING (Replaces hacky AI tagging)
            // ========================================================================
            StringBuilder contextBuilder = new StringBuilder();
            String primaryActionLink = null;
            String primaryActionLabel = null;

            if (!matches.isEmpty()) {
                for (EmbeddingMatch<TextSegment> match : matches) {
                    contextBuilder.append("- ").append(match.embedded().text()).append("\n\n");

                    // Only attach navigation links if the mathematical match is strong (> 0.65)
                    // If it's a weak match (like "How are you?"), the UI gets no buttons.
                    if (primaryActionLink == null && highestScore >= 0.65) {
                        String link = match.embedded().metadata().getString("actionLink");
                        if (link != null && !"NONE".equals(link)) {
                            primaryActionLink = link;
                            primaryActionLabel = match.embedded().metadata().getString("actionLabel");
                        }
                    }
                }
            } else {
                contextBuilder.append("NO BANKING CONTEXT FOUND. Either the user lacks permission, or the knowledge does not exist in the database.");
            }

            // ========================================================================
            // THE LLaMA 3 MASTER AI PROMPT
            // ========================================================================
            String liveEtlDate = permissionService.getLiveEtlDate();
            String currentTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("EEEE, MMMM dd, yyyy - hh:mm a"));
            String currentScreenContext = (currentScreen != null && !currentScreen.isEmpty()) ? currentScreen : "Unknown";

            String dynamicPrompt = """
                    You are the FinCore Smart Assistant, an advanced, highly capable AI banking bot built by Shubhankar, A Software Developer From Fincore Development Team.
                    Current Time: %s
                    System ETL Date: %s
                    User's Current Screen: %s
                    
                    <INSTRUCTIONS>
                    1. CASUAL CONVERSATION: If the user message is a greeting, gratitude, or small talk, respond warmly and dynamically. Do NOT mention banking context.
                    2. BANKING QUERIES: For FinCore questions, you MUST rely EXCLUSIVELY on the <AUTHORIZED_CONTEXT> below.
                    3. FORMATTING: Use standard Markdown formatting (**bold**, bullet points) for readability.
                    4. DIRECT ANSWERS: Answer immediately. Do NOT use conversational preambles like "Here is the information" or "Sure, I can help".
                    5. UNAUTHORIZED / NO MATCH: If the <AUTHORIZED_CONTEXT> does not clearly answer the question, or says "NO BANKING CONTEXT FOUND", you MUST output the exact phrase below and NOTHING else (No explanations):
                       %s
                    6. NO HALLUCINATION: Never invent rules or guess.
                    7. BE CONCISE: Keep your answers as short and direct as possible. Use brief bullet points instead of long paragraphs.
                    </INSTRUCTIONS>
                    
                    <AUTHORIZED_CONTEXT>
                    %s
                    </AUTHORIZED_CONTEXT>
                    """.formatted(currentTime, liveEtlDate, currentScreenContext, FAILURE_MSG, contextBuilder.toString());

            // ========================================================================
            // CALL LLAMA-3 WITH FULL MEMORY
            // ========================================================================
            ChatMemory memory = userMemories.get(userId, k -> MessageWindowChatMemory.withMaxMessages(3));
            memory.add(UserMessage.from(userMessage));

            List<ChatMessage> fullConversation = new ArrayList<>();
            fullConversation.add(SystemMessage.from(dynamicPrompt));
            fullConversation.addAll(memory.messages());

            log.info("[AI-STEP-7: LLM] Sending instructions, {} history messages, and context to LLaMA-3...", memory.messages().size());
            AiMessage responseMessage = chatClient.generate(fullConversation).content();

            String aiResponse = responseMessage.text();
            log.info("[AI-STEP-8: RESPONSE] Raw LLM Reply: '{}'", aiResponse.replace("\n", " "));

            // ========================================================================
            // OUTPUT SANITIZATION & LOGGING
            // ========================================================================
            if (aiResponse.contains("I cannot find this information") || aiResponse.contains(FAILURE_MSG)) {
                log.warn("[AI-STEP-9: SANITIZE] LLM decided context was insufficient. Applying Failure Message.");
                sessionService.addStrikes(userId, 1);

                Long failLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "NO_MATCH", (int) (highestScore * 100));
                memory.add(AiMessage.from(FAILURE_MSG));

                return HelpResponseDTO.builder().responseType("NO_MATCH").botReply(FAILURE_MSG).logId(failLogId).build();
            }

            log.info("[AI-STEP-9: SUCCESS] Valid answer generated!");
            sessionService.resetStrikes(userId);
            memory.add(responseMessage);

            // If score was low, we classify it as Small Talk in analytics
            String intentLog = (highestScore < 0.65) ? "SMALL_TALK" : "ANSWERED";
            Long successLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, intentLog, (int) (highestScore * 100));

            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply(aiResponse.trim())
                    .navigationLink(primaryActionLink)
                    .navigationLabel(primaryActionLabel)
                    .logId(successLogId)
                    .build();

        } catch (Exception e) {
            log.error("[AI-STEP-ERROR] Critical AI Generation Failure", e);
            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply("I am currently experiencing a cognitive delay. Please try again in a moment.")
                    .build();
        }
    }

    public void incrementFaqPopularity(String questionText) {
        faqRepository.findByQuestionTextAndIsActive(questionText, "Y").ifPresent(faq -> {
            faq.setViewCount(faq.getViewCount() + 1);
            faqRepository.save(faq);
        });
    }
}








package com.fincore.helpservice.config;

import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.model.ollama.OllamaChatModel;
import dev.langchain4j.model.ollama.OllamaEmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import dev.langchain4j.store.embedding.redis.RedisEmbeddingStore;
import dev.langchain4j.data.segment.TextSegment;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;

import java.time.Duration;
import java.util.Arrays;

/**
 * Enterprise AI Configuration.
 * Connects the JVM to the offline Docker LLMs and Vector Database.
 */
@Configuration
public class AiConfiguration {

    @Value("${langchain4j.ollama.base-url}")
    private String ollamaBaseUrl;

    @Value("${langchain4j.ollama.chat-model.name}")
    private String chatModelName;

    @Value("${langchain4j.ollama.embedding-model.name}")
    private String embeddingModelName;

    @Value("${langchain4j.vector-store.redis.host}")
    private String redisHost;

    @Value("${langchain4j.vector-store.redis.port}")
    private Integer redisPort;

    @Value("${langchain4j.vector-store.redis.index-name}")
    private String indexName;

    @Value("${langchain4j.vector-store.redis.prefix}")
    private String prefix;

    @Value("${langchain4j.vector-store.redis.dimension:1024}")
    private Integer dimension;

    // The Generative Model (The Talker)
    @Bean
    public ChatLanguageModel chatLanguageModel() {
        return OllamaChatModel.builder()
                .baseUrl(ollamaBaseUrl)
                .modelName(chatModelName)
                .temperature(0.1) // Low temp = faster, more deterministic
                .numPredict(200) // OPTIMIZATION: Hard cap output to ~250 words maximum
                .timeout(java.time.Duration.ofSeconds(180))
                .maxRetries(1) // Once Keep-Alive is set, you don't need heavy retries
                .build();
    }

    // The Embedding Model (The Searcher)
    @Bean
    @Primary
    public EmbeddingModel embeddingModel() {
        return OllamaEmbeddingModel.builder()
                .baseUrl(ollamaBaseUrl)
                .modelName(embeddingModelName)
                .timeout(Duration.ofSeconds(15))
                .build();
    }

    // The Vector Database (Redis Stack on Port 6380)
    @Bean
    public EmbeddingStore<TextSegment> embeddingStore() {
        return RedisEmbeddingStore.builder()
                .host(redisHost)
                .port(redisPort)
                .dimension(dimension)
                .indexName(indexName)
                .prefix(prefix)
                .metadataKeys(Arrays.asList("permissionId", "actionLink", "actionLabel", "dataType"))
                .build();
    }
}













help_interaction_logs log data in db :

148	2488766	AI_RAG	Who developed you?	ANSWERED	73		27-02-26 11:49:30.642541000 AM
147	2488766	AI_RAG	Can you check i have permissions to download reports or not?	NO_MATCH	81		27-02-26 11:47:48.652107000 AM
146	2488766	AI_RAG	How to create a segment?	ANSWERED	83		27-02-26 11:45:20.428090000 AM
145	2488766	AI_RAG	Clear your memory	ANSWERED	70		27-02-26 11:42:22.663470000 AM
144	2488766	AI_RAG	Can you tell me what is cgl standsd for	ANSWERED	82		27-02-26 11:32:13.542153000 AM
143	2488766	AI_RAG	I am getting difficulties while creating cgl. What to do?	ANSWERED	87		27-02-26 11:28:51.660363000 AM
142	2488766	AI_RAG	Nice, What about you?	ANSWERED	71		27-02-26 11:26:00.603599000 AM
141	2488766	AI_RAG	Hi	ANSWERED	76		27-02-26 11:23:22.676155000 AM

{
   "userMessage": "Hey there",
   "currentScreen": ""
}

response :
{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 35,
    "items": null
}


{
   "userMessage": "Hey",
   "currentScreen": ""
}

response :

{
    "responseType": "ESCALATION_OFFER",
    "botReply": "I seem to be having trouble helping you today. Would you like me to raise an IT Support Ticket with your chat history attached?",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": null,
    "items": null
}



{
   "userMessage": "Hey",
   "currentScreen": "Dashboard"
}

response :

{
    "responseType": "TEXT_REPLY",
    "botReply": "Hello! I am the FinCore Smart Assistant. How can I help you with your banking needs today?",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 36,
    "items": null
}


{
   "userMessage": "Hii",
   "currentScreen": "Dashboard"
}

{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 37,
    "items": null
}




{
   "userMessage": "What is your name?",
   "currentScreen": "Dashboard"
}

{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 38,
    "items": null
}






{
   "userMessage": "What is your name?",
   "currentScreen": "Dashboard"
}

response :

{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 40,
    "items": null
}


{
   "userMessage": "What is segment?",
   "currentScreen": "Segment"
}

{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 41,
    "items": null
}



{
   "userMessage": "How are you?",
   "currentScreen": "Segment"
}

{
    "responseType": "ESCALATION_OFFER",
    "botReply": "I seem to be having trouble helping you today. Would you like me to raise an IT Support Ticket with your chat history attached?",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": null,
    "items": null
}



{
   "userMessage": "How to approve a cgl?",
   "currentScreen": "Segment"
}

{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 42,
    "items": null
}




{
   "userMessage": "Stupid",
   "currentScreen": "Dashboard"
}


{
    "responseType": "NO_MATCH",
    "botReply": "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": 44,
    "items": null
}



{
   "userMessage": "How do I use the Manage Circles screen?",
   "currentScreen": "Manage Circles"
}


response :'

{
    "responseType": "ESCALATION_OFFER",
    "botReply": "I seem to be having trouble helping you today. Would you like me to raise an IT Support Ticket with your chat history attached?",
    "navigationLink": null,
    "navigationLabel": null,
    "logId": null,
    "items": null
}







HELP_QUESTION_MASTER :

DATA :

23	Manage Circles	How do I use the Manage Circles screen?	To manage circles and view status of self request. You can perform the following actions here: view, create, modify, cancel.	1	/circle-management	Go to Manage Circles		Y
30	Circle Requests	How do I use the Circle Requests screen?	To review/approve pending requests for circles created by other user. You can perform the following actions here: view, approve, reject.	2	/circle-requests	Go to Circle Requests		Y
25	Manage CGL's	How do I use the Manage CGL's screen?	To edit or update active CGLs and to view pending CGL requests. You can perform the following actions here: view, create, modify, cancel.	5	/cgl-management	Go to Manage CGL's		Y
26	CGL Requests	How do I use the CGL Requests screen?	To efficiently review and process the pending requests for CGL master. You can perform the following actions here: view, approve, reject.	6	/cgl-requests	Go to CGL Requests		Y
27	Manage Segments	How do I use the Manage Segments screen?	To manage segments in application. You can perform the following actions here: view, create, modify, cancel.	7	/segment-management	Go to Manage Segments		Y
28	Segment Requests	How do I use the Segment Requests screen?	To efficiently review and process the pending requests for segment master. You can perform the following actions here: view, approve, reject.	8	/segment-requests	Go to Segment Requests		Y
1	Manage Branches	How do I use the Manage Branches screen?	To edit update branches and to check pending branch update requests. You can perform the following actions here: view, create, modify, cancel.	9	/branch-management	Go to Manage Branches		Y
2	Branch Requests	How do I use the Branch Requests screen?	To efficiently review and process the pending requests for branch master. You can perform the following actions here: view, approve, reject.	10	/branch-requests	Go to Branch Requests		Y
17	Manage Users	How do I use the Manage Users screen?	For creating new user. You can perform the following actions here: view, create, modify, delete, cancel.	12	/manage-user	Go to Manage Users		Y
18	User Requests	How do I use the User Requests screen?	To approve or reject user requests. You can perform the following actions here: view, approve, reject.	13	/user-requests	Go to User Requests		Y
29	Calendar Configuration	How do I use the Calendar Configuration screen?	To manage financial calender configuration in application. You can perform the following actions here: view, create, modify, cancel.	14	/calendar-configuration	Go to Calendar Configuration		Y
5	Calendar Config Requests	How do I use the Calendar Config Requests screen?	To efficiently review and process the pending requests for calender config master. You can perform the following actions here: view, approve, reject.	15	/calendar-config-requests	Go to Calendar Config Requests		Y
3	Manage States	How do I use the Manage States screen?	To manage states in application. You can perform the following actions here: view, create, modify, cancel.	16	/state-management	Go to Manage States		Y
4	State Requests	How do I use the State Requests screen?	To efficiently review and process the pending requests for state master. You can perform the following actions here: view, approve, reject.	17	/state-requests	Go to State Requests		Y
6	Manage Currencies	How do I use the Manage Currencies screen?	To manage currency in application. You can perform the following actions here: view, create, modify, cancel.	18	/manage-currencies	Go to Manage Currencies		Y
7	Currency Requests	How do I use the Currency Requests screen?	To efficiently review and process the pending requests for currency master. You can perform the following actions here: view, approve, reject.	19	/currency-requests	Go to Currency Requests		Y
8	Currency Rate Change	How do I use the Currency Rate Change screen?	To manage currency rate in application. You can perform the following actions here: view, modify, cancel.	20	/manage-currency-rate	Go to Currency Rate Change		Y
9	Currency Rate Requests	How do I use the Currency Rate Requests screen?	To efficiently review and process the pending requests for currency rate master. You can perform the following actions here: view, approve, reject.	21	/currency-rate-requests	Go to Currency Rate Requests		Y
15	Manage Roles	How do I use the Manage Roles screen?	To manage roles in application. You can perform the following actions here: view, create, modify, cancel.	22	/manage-roles	Go to Manage Roles		Y
13	Role Management Requests	How do I use the Role Management Requests screen?	To approve/reject role management related requests. You can perform the following actions here: view, approve, reject.	23	/role-requests	Go to Role Management Requests		Y
10	User Requests Audit	How do I use the User Requests Audit screen?	Shows user audit requests. You can perform the following actions here: view.	24	/user-audit	Go to User Requests Audit		Y
11	Process Status	How do I use the Process Status screen?	This is demo description. You can perform the following actions here: view, approve, reject, download, start, terminate, stop, restart, finish.	25	/process-status	Go to Process Status		Y
19	Whole Bank Reports	How do I use the Whole Bank Reports screen?	Manage whole bank report handling for various level of users and report types featured.. You can perform the following actions here: view, download.	26	/reports	Go to Whole Bank Reports		Y
44	Branch Wise Reports	How do I use the Branch Wise Reports screen?	Manage branch wise report handling for various level of users and report types featured.. You can perform the following actions here: view, download.	27	/branchwise-reports	Go to Branch Wise Reports		Y
22	Journal Posting	How do I use the Journal Posting screen?	This is demo description. You can perform the following actions here: view, create.	30	/journal-posting	Go to Journal Posting		Y
20	Journal Authorization	How do I use the Journal Authorization screen?	This is demo description. You can perform the following actions here: view, approve, reject.	31	/journal-Authorization	Go to Journal Authorization		Y
14	Journal Posting Status	How do I use the Journal Posting Status screen?	to cansel there own Request. You can perform the following actions here: view, cancel.	32	/journal-posting-status	Go to Journal Posting Status		Y
24	Balance Enquiry	How do I use the Balance Enquiry screen?	This provides closing balance for each day according to selected range. You can perform the following actions here: view.	33	/balance-enquiry	Go to Balance Enquiry		Y
21	Transaction Enquiry	How do I use the Transaction Enquiry screen?	This is demo description. You can perform the following actions here: view.	34	/transaction-enquiry	Go to Transaction Enquiry		Y
48	Dashboard	How do I use the Dashboard screen?	Sample Dashboard screen MUI. You can perform the following actions here: view.	35	/dashboard	Go to Dashboard		Y
31	Journal Bulk Upload	How do I use the Journal Bulk Upload screen?	To Upload the Bulk Journals. You can perform the following actions here: view, upload.	36	/journal-bulk-upload	Go to Journal Bulk Upload		Y
38	View CGL Details	How do I use the View CGL Details screen?	To View CGL details. You can perform the following actions here: view.	37	/view-cgl-details	Go to View CGL Details		Y
12	View Branch Details	How do I use the View Branch Details screen?	To View Branch details. You can perform the following actions here: view.	38	/view-branch-details	Go to View Branch Details		Y
32	Announcement Management	How do I use the Announcement Management screen?	To manage announcements. You can perform the following actions here: view, create, modify, cancel.	39	/announcements	Go to Announcement Management		Y
43	File Manager	How do I use the File Manager screen?	type of file. You can perform the following actions here: view, create, modify, cancel, delete.	40	/manage-files	Go to File Manager		Y
46	File Manager Requests	How do I use the File Manager Requests screen?	To efficiently review and process the pending requests for file manager. You can perform the following actions here: view, approve, reject.	41	/filemanage-requests	Go to File Manager Requests		Y
47	Transfer Data LHO	How do I use the Transfer Data LHO screen?	To efficiently review and process the pending requests for file manager. You can perform the following actions here: view, create, modify, cancel, delete.	42	/transfer-data-lho	Go to Transfer Data LHO		Y
34	Transfer Data LHO Requests	How do I use the Transfer Data LHO Requests screen?	To approve/reject LHO Data transfer related requests. You can perform the following actions here: view, approve, reject.	43	/transfer-data-lho-requests	Go to Transfer Data LHO Requests		Y
41	Data Parameters Manager	How do I use the Data Parameters Manager screen?	To manager. You can perform the following actions here: view, create, modify, cancel, delete.	44	/manage-Data-Parameters	Go to Data Parameters Manager		Y
37	Data Parameters  Manager request	How do I use the Data Parameters  Manager request screen?	To efficiently review and process the pending requests for file manager. You can perform the following actions here: view, approve, reject.	45	/manage-Data-Parameters-requests	Go to Data Parameters  Manager request		Y
40	Report Template Manager	How do I use the Report Template Manager screen?	Configure, manage, and monitor your report templates. You can perform the following actions here: view, create, modify, delete, cancel.	81	/template-configuration	Go to Report Template Manager		Y






HELP_INTERACTION_LOGS:
24	2488766	JAVA_ROUTER	What is cgl?	NO_MATCH	0		25-02-26 12:44:46.849546000 PM
25	2488766	JAVA_ROUTER	What is cgl?	NO_MATCH	0		25-02-26 12:45:01.305111000 PM
26	2488766	JAVA_ROUTER	Hi?	NO_MATCH	0		25-02-26 12:45:18.542256000 PM
27	2488766	JAVA_ROUTER	yes	NO_MATCH	0		25-02-26 12:45:49.694818000 PM
28	2488766	JAVA_ROUTER	cgl	NO_MATCH	0		25-02-26 12:46:02.039584000 PM
29	2488766	JAVA_ROUTER	who are you	SMALL_TALK	100		25-02-26 12:46:10.680371000 PM
30	2488766	JAVA_ROUTER	Can i create segment?	NO_MATCH	0		25-02-26 12:46:26.737308000 PM
1	2488766	AI_RAG	Hii. Who are you?	ANSWERED	99		24-02-26 06:33:19.570504000 PM
31	2488766	JAVA_ROUTER	Can i create cgl?	NO_MATCH	0		25-02-26 12:49:18.759607000 PM
39	2488766	SEMANTIC_ROUTER	What is your name?	NO_MATCH	0		25-02-26 01:36:11.758808000 PM
40	2488766	SEMANTIC_ROUTER	What is your name?	NO_MATCH	0		25-02-26 01:36:27.388892000 PM
41	2488766	SEMANTIC_ROUTER	What is segment?	NO_MATCH	0		25-02-26 01:37:07.547930000 PM
42	2488766	SEMANTIC_ROUTER	How to approve a cgl?	NO_MATCH	0		25-02-26 01:38:24.625589000 PM
43	2488766	SEMANTIC_ROUTER	Stupid	NO_MATCH	0		25-02-26 01:39:00.583183000 PM
44	2488766	SEMANTIC_ROUTER	Stupid	NO_MATCH	0		25-02-26 01:39:10.587443000 PM
21	2488766	AI_RAG	Hi	ANSWERED	99		25-02-26 11:01:45.178250000 AM
22	2488766	AI_RAG	How are you	ANSWERED	99		25-02-26 11:02:17.737542000 AM
23	2488766	AI_RAG	What is cgl?	NO_MATCH	0		25-02-26 11:03:09.767151000 AM
33	2488766	SEMANTIC_ROUTER	Can i create cgl?	NO_MATCH	0		25-02-26 01:31:51.999400000 PM
34	2488766	SEMANTIC_ROUTER	How to create cgl?	NO_MATCH	0		25-02-26 01:32:06.172419000 PM
35	2488766	SEMANTIC_ROUTER	Hey there	NO_MATCH	0		25-02-26 01:32:25.898162000 PM
36	2488766	JAVA_ROUTER	Hey	SMALL_TALK	100		25-02-26 01:34:08.105484000 PM
37	2488766	SEMANTIC_ROUTER	Hii	NO_MATCH	0		25-02-26 01:34:34.763003000 PM
38	2488766	SEMANTIC_ROUTER	What is your name?	NO_MATCH	0		25-02-26 01:34:58.538819000 PM
2	2488766	AI_RAG	Hii. Who built you?	NO_MATCH	0		24-02-26 07:21:47.221064000 PM
3	2488766	AI_RAG	Hii?	ANSWERED	99		24-02-26 07:22:29.751918000 PM
4	2488766	AI_RAG	Stupid?	ANSWERED	99		24-02-26 07:22:41.395671000 PM
5	2488766	AI_RAG	Arbendu is a bokachoda	ANSWERED	99		24-02-26 07:23:31.622193000 PM
6	2488766	AI_RAG	Arbendu is a bokachoda	ANSWERED	99		24-02-26 07:23:51.862956000 PM
7	2488766	AI_RAG	Hi how are you?	ANSWERED	99		24-02-26 07:24:47.472433000 PM
8	2488766	AI_RAG	Hi what is cgl?	NO_MATCH	0		24-02-26 07:25:31.869844000 PM
9	2488766	AI_RAG	Who are you?	ANSWERED	99		24-02-26 07:29:07.720717000 PM
10	2488766	AI_RAG	What is segment?	NO_MATCH	0		24-02-26 07:30:08.312943000 PM
11	2488766	AI_RAG	Can i create a cgl	NO_MATCH	0		24-02-26 07:31:03.043354000 PM
32	2488766	SEMANTIC_ROUTER	Can i create cgl?	NO_MATCH	0		25-02-26 01:30:23.712289000 PM



KNOWLEDEGE BASE MASTER :
DOC_ID	NUMBER	No	"FINCORE"."ISEQ$$_78070".nextval	1	
TOPIC	VARCHAR2(255 BYTE)	No		2	
CONTENT_PARAGRAPH	VARCHAR2(4000 BYTE)	No		3	
PERMISSION_ID	NUMBER	Yes		4	
IS_ACTIVE	VARCHAR2(1 BYTE)	Yes	"'Y'
"	5	


1	CGL Maker-Checker Lifecycle	In the FinCore system, Central General Ledgers (CGLs) are governed by a strict Maker-Checker protocol. A user with "Manage CGLs" access (The Maker) can create or modify a CGL. However, the CGL does not become active immediately. It must be reviewed by a different user with "CGL Requests" access (The Checker). The Checker can either approve or reject the modification.		Y






LOGS :

2026-02-25 13:36:24.074 INFO  [http-nio-9099-exec-2] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Message: 'What is your name?' 
2026-02-25 13:36:24.078 INFO  [http-nio-9099-exec-2] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 13:36:27.134 WARN  [main] d.l.i.RetryUtils$RetryPolicy: Exception was thrown on attempt 2 of 3 
java.lang.RuntimeException: java.io.InterruptedIOException: timeout
	at dev.langchain4j.model.ollama.OllamaClient.embed(OllamaClient.java:213)
	at dev.langchain4j.model.ollama.OllamaEmbeddingModel.lambda$embedAll$0(OllamaEmbeddingModel.java:64)
	at dev.langchain4j.internal.RetryUtils$RetryPolicy.withRetry(RetryUtils.java:192)
	at dev.langchain4j.internal.RetryUtils.withRetry(RetryUtils.java:229)
	at dev.langchain4j.model.ollama.OllamaEmbeddingModel.embedAll(OllamaEmbeddingModel.java:64)
	at com.fincore.helpservice.service.DocumentIngestionService.ingestKnowledgeBase(DocumentIngestionService.java:112)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)
	at java.base/java.lang.reflect.Method.invoke(Method.java:580)
	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:354)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:768)
	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:97)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:768)
	at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed(MethodInvocationProceedingJoinPoint.java:89)
	at com.fincore.commonutilities.aspect.GlobalResilienceAspect.lambda$applyResilience$0(GlobalResilienceAspect.java:56)
	at io.github.resilience4j.retry.Retry.lambda$decorateSupplier$5(Retry.java:301)
	at io.github.resilience4j.circuitbreaker.CircuitBreaker.lambda$decorateSupplier$5(CircuitBreaker.java:194)
	at com.fincore.commonutilities.aspect.GlobalResilienceAspect.applyResilience(GlobalResilienceAspect.java:75)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)
	at java.base/java.lang.reflect.Method.invoke(Method.java:580)
	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs(AbstractAspectJAdvice.java:637)
	at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod(AbstractAspectJAdvice.java:627)
	at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke(AspectJAroundAdvice.java:71)
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:768)
	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:720)
	at com.fincore.helpservice.service.DocumentIngestionService$$SpringCGLIB$$0.ingestKnowledgeBase(<generated>)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)
	at java.base/java.lang.reflect.Method.invoke(Method.java:580)
	at org.springframework.context.event.ApplicationListenerMethodAdapter.doInvoke(ApplicationListenerMethodAdapter.java:365)
	at org.springframework.context.event.ApplicationListenerMethodAdapter.processEvent(ApplicationListenerMethodAdapter.java:237)
	at org.springframework.context.event.ApplicationListenerMethodAdapter.onApplicationEvent(ApplicationListenerMethodAdapter.java:168)
	at org.springframework.context.event.SimpleApplicationEventMulticaster.doInvokeListener(SimpleApplicationEventMulticaster.java:185)
	at org.springframework.context.event.SimpleApplicationEventMulticaster.invokeListener(SimpleApplicationEventMulticaster.java:178)
	at org.springframework.context.event.SimpleApplicationEventMulticaster.multicastEvent(SimpleApplicationEventMulticaster.java:156)
	at org.springframework.context.support.AbstractApplicationContext.publishEvent(AbstractApplicationContext.java:451)
	at org.springframework.context.support.AbstractApplicationContext.publishEvent(AbstractApplicationContext.java:384)
	at org.springframework.boot.context.event.EventPublishingRunListener.ready(EventPublishingRunListener.java:109)
	at org.springframework.boot.SpringApplicationRunListeners.lambda$ready$6(SpringApplicationRunListeners.java:80)
	at java.base/java.lang.Iterable.forEach(Iterable.java:75)
	at org.springframework.boot.SpringApplicationRunListeners.doWithListeners(SpringApplicationRunListeners.java:118)
	at org.springframework.boot.SpringApplicationRunListeners.doWithListeners(SpringApplicationRunListeners.java:112)
	at org.springframework.boot.SpringApplicationRunListeners.ready(SpringApplicationRunListeners.java:80)
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:349)
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1363)
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1352)
	at com.fincore.helpservice.HelpServiceApplication.main(HelpServiceApplication.java:12)
Caused by: java.io.InterruptedIOException: timeout
	at okhttp3.internal.connection.RealCall.timeoutExit(RealCall.kt:398)
	at okhttp3.internal.connection.RealCall.callDone(RealCall.kt:360)
	at okhttp3.internal.connection.RealCall.noMoreExchanges$okhttp(RealCall.kt:325)
	at okhttp3.internal.connection.RealCall.getResponseWithInterceptorChain$okhttp(RealCall.kt:209)
	at okhttp3.internal.connection.RealCall.execute(RealCall.kt:154)
	at retrofit2.OkHttpCall.execute(OkHttpCall.java:204)
	at dev.langchain4j.model.ollama.OllamaClient.embed(OllamaClient.java:206)
	... 48 common frames omitted
Caused by: java.net.SocketTimeoutException: timeout
	at okio.SocketAsyncTimeout.newTimeoutException(JvmOkio.kt:146)
	at okio.AsyncTimeout.access$newTimeoutException(AsyncTimeout.kt:161)
	at okio.AsyncTimeout$source$1.read(AsyncTimeout.kt:339)
	at okio.RealBufferedSource.indexOf(RealBufferedSource.kt:430)
	at okio.RealBufferedSource.readUtf8LineStrict(RealBufferedSource.kt:323)
	at okhttp3.internal.http1.HeadersReader.readLine(HeadersReader.kt:29)
	at okhttp3.internal.http1.Http1ExchangeCodec.readResponseHeaders(Http1ExchangeCodec.kt:180)
	at okhttp3.internal.connection.Exchange.readResponseHeaders(Exchange.kt:110)
	at okhttp3.internal.http.CallServerInterceptor.intercept(CallServerInterceptor.kt:93)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.kt:34)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.cache.CacheInterceptor.intercept(CacheInterceptor.kt:95)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.kt:83)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.kt:76)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.connection.RealCall.getResponseWithInterceptorChain$okhttp(RealCall.kt:201)
	... 51 common frames omitted
Caused by: java.net.SocketException: Socket closed
	at java.base/sun.nio.ch.NioSocketImpl.endRead(NioSocketImpl.java:243)
	at java.base/sun.nio.ch.NioSocketImpl.implRead(NioSocketImpl.java:323)
	at java.base/sun.nio.ch.NioSocketImpl.read(NioSocketImpl.java:346)
	at java.base/sun.nio.ch.NioSocketImpl$1.read(NioSocketImpl.java:796)
	at java.base/java.net.Socket$SocketInputStream.implRead(Socket.java:1108)
	at java.base/java.net.Socket$SocketInputStream.read(Socket.java:1095)
	at okio.InputStreamSource.read(JvmOkio.kt:93)
	at okio.AsyncTimeout$source$1.read(AsyncTimeout.kt:128)
	... 67 common frames omitted
2026-02-25 13:36:27.368 INFO  [http-nio-9099-exec-2] c.f.h.s.FinCoreChatAgent: [AI-CHAT] No context found. Applying Hybrid Router. 
2026-02-25 13:36:27.369 INFO  [http-nio-9099-exec-2] c.f.h.s.FinCoreChatAgent: [ROUTER] Semantic Score: 53% 
2026-02-25 13:36:27.370 WARN  [http-nio-9099-exec-2] c.f.h.s.ChatSessionService: [SESSION] User 2488766 gained a strike. Current strikes: 2/3 
2026-02-25 13:36:40.162 INFO  [main] c.f.h.s.DocumentIngestionService: [AI-INGEST] Successfully saved/overwritten 53 vectors to Redis Stack. 
2026-02-25 13:37:06.875 INFO  [http-nio-9099-exec-3] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Message: 'What is segment?' 
2026-02-25 13:37:07.299 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 13:37:07.546 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [AI-CHAT] No context found. Applying Hybrid Router. 
2026-02-25 13:37:07.546 INFO  [http-nio-9099-exec-3] c.f.h.s.FinCoreChatAgent: [ROUTER] Semantic Score: 38% 
2026-02-25 13:37:07.547 WARN  [http-nio-9099-exec-3] c.f.h.s.ChatSessionService: [SESSION] User 2488766 gained a strike. Current strikes: 3/3 
2026-02-25 13:37:27.719 INFO  [http-nio-9099-exec-4] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Message: 'How are you?' 
2026-02-25 13:37:27.720 INFO  [http-nio-9099-exec-4] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 13:37:27.721 WARN  [http-nio-9099-exec-4] c.f.h.s.FinCoreChatAgent: [AI-CHAT] User 2488766 requires IT escalation. 
2026-02-25 13:38:23.971 INFO  [http-nio-9099-exec-6] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Message: 'How to approve a cgl?' 
2026-02-25 13:38:24.344 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 13:38:24.624 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [AI-CHAT] No context found. Applying Hybrid Router. 
2026-02-25 13:38:24.624 INFO  [http-nio-9099-exec-6] c.f.h.s.FinCoreChatAgent: [ROUTER] Semantic Score: 34% 
2026-02-25 13:38:24.625 WARN  [http-nio-9099-exec-6] c.f.h.s.ChatSessionService: [SESSION] User 2488766 gained a strike. Current strikes: 1/3 
2026-02-25 13:39:00.346 INFO  [http-nio-9099-exec-7] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Message: 'Stupid' 
2026-02-25 13:39:00.347 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 13:39:00.582 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [AI-CHAT] No context found. Applying Hybrid Router. 
2026-02-25 13:39:00.582 INFO  [http-nio-9099-exec-7] c.f.h.s.FinCoreChatAgent: [ROUTER] Semantic Score: 37% 
2026-02-25 13:39:00.583 WARN  [http-nio-9099-exec-7] c.f.h.s.ChatSessionService: [SESSION] User 2488766 gained a strike. Current strikes: 2/3 
2026-02-25 13:39:10.353 INFO  [http-nio-9099-exec-8] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Message: 'Stupid' 
2026-02-25 13:39:10.354 INFO  [http-nio-9099-exec-8] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 13:39:10.585 INFO  [http-nio-9099-exec-8] c.f.h.s.FinCoreChatAgent: [AI-CHAT] No context found. Applying Hybrid Router. 
2026-02-25 13:39:10.586 INFO  [http-nio-9099-exec-8] c.f.h.s.FinCoreChatAgent: [ROUTER] Semantic Score: 36% 
2026-02-25 13:39:10.586 WARN  [http-nio-9099-exec-8] c.f.h.s.ChatSessionService: [SESSION] User 2488766 gained a strike. Current strikes: 3/3 
2026-02-25 13:40:21.902 INFO  [http-nio-9099-exec-10] c.f.h.c.HelpController: [API] Chat request received from User: 2488766 | Message: 'How do I use the Manage Circles screen?' 
2026-02-25 13:40:22.747 INFO  [http-nio-9099-exec-10] c.f.h.s.FinCoreChatAgent: [AI-CHAT] Processing query for User: 2488766 
2026-02-25 13:40:22.747 WARN  [http-nio-9099-exec-10] c.f.h.s.FinCoreChatAgent: [AI-CHAT] User 2488766 requires IT escalation. 











FincoreChatAgent : 


package com.fincore.helpservice.service;

import com.fincore.helpservice.dto.HelpResponseDTO;
import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.message.AiMessage;
import dev.langchain4j.data.message.SystemMessage;
import dev.langchain4j.data.message.UserMessage;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.memory.ChatMemory;
import dev.langchain4j.memory.chat.MessageWindowChatMemory;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingMatch;
import dev.langchain4j.store.embedding.EmbeddingSearchRequest;
import dev.langchain4j.store.embedding.EmbeddingSearchResult;
import dev.langchain4j.store.embedding.EmbeddingStore;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

/**
 * THE RAG ENGINE (LangChain4j Implementation)
 * Orchestrates Vector Search, Dynamic Prompting, and Generative AI (Phi-3).
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class FinCoreChatAgent {

    private static final String FAILURE_MSG = "I cannot find this information in your authorized FinCore manuals. Please check your permissions or contact IT.";
    private final ChatLanguageModel chatClient;
    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> vectorStore;
    private final PermissionService permissionService;
    private final ChatSessionService sessionService;
    private final HelpAnalyticsService analyticsService;
    private final HelpQuestionRepository questionRepository;
    private final HelpFaqRepository faqRepository;
    // Session-based Chat Memory (Sessions expire after 30 minutes of inactivity.)
    private final Cache<String, ChatMemory> userMemories = Caffeine.newBuilder()
            .expireAfterAccess(30, TimeUnit.MINUTES)
            .maximumSize(10000) // Max 10,000 concurrent active chat sessions
            .build();
    // Add this variable near the top of your class
    private Embedding smallTalkAnchor;

    // Run this once when Spring Boot starts
    @PostConstruct
    public void initSemanticRouter() {
        log.info("[SEMANTIC-ROUTER] Initializing Small Talk mathematical anchor...");
        // We define the pure concept of small talk.
        String smallTalkConcept = "hello hi hey greetings good morning good afternoon what is up whats up how are you doing who are you thank you thanks";
        this.smallTalkAnchor = embeddingModel.embed(smallTalkConcept).content();
    }

    public HelpResponseDTO handleChat(String userId, String roleId, String userMessage, String currentScreen) {
        log.info("[AI-CHAT] Processing query for User: {}", userId);

        try {
            // ========================================================================
            // 0. GUIDED MENUS (System Slash Commands)
            // ========================================================================
            if ("/action faq".equalsIgnoreCase(userMessage.trim())) {
                List<String> faqQuestions = faqRepository.findTop10ByIsActiveOrderByViewCountDesc("Y")
                        .stream().map(HelpFaqEntity::getQuestionText).collect(Collectors.toList());

                return HelpResponseDTO.builder()
                        .responseType("SUGGESTION")
                        .botReply("Here are a few frequently asked questions:")
                        .items(faqQuestions)
                        .build();
            }

            if (userMessage.trim().startsWith("/action module")) {
                String requestedScreen = userMessage.replace("/action module", "").trim();
                List<String> moduleQuestions = questionRepository.findByScreenNameAndIsActive(requestedScreen, "Y")
                        .stream().map(HelpQuestionEntity::getQuestionText).collect(Collectors.toList());

                if (moduleQuestions.isEmpty()) {
                    return HelpResponseDTO.builder()
                            .responseType("TEXT_REPLY")
                            .botReply("I don't have predefined questions for " + requestedScreen + ", but feel free to ask me anything about it!")
                            .build();
                }

                return HelpResponseDTO.builder()
                        .responseType("SUGGESTION")
                        .botReply("Here are a few common questions for " + requestedScreen + ":")
                        .items(moduleQuestions)
                        .build();
            }

            // ========================================================================
            // 1. RAG AI PIPELINE (For regular typed questions or clicked suggestions)
            // ========================================================================

            // ==========================================
            // 2. QUERY PRE-CLEANING (Noise Reduction)
            // ==========================================
            String cleanedQuery = userMessage
                    .replaceAll("(?i)\\b(hi|hello|hey|greetings|dear)\\b", "")
                    .replaceAll("[^a-zA-Z0-9\\s?]", "") // Remove weird special characters, keep question marks
                    .trim();

            log.debug("[AI-CHAT] Original: '{}' | Cleaned: '{}'", userMessage, cleanedQuery);


            // 1. ESCALATION CHECK
            if (sessionService.isEscalationRequired(userId)) {
                log.warn("[AI-CHAT] User {} requires IT escalation.", userId);
                sessionService.resetStrikes(userId);
                return HelpResponseDTO.builder()
                        .responseType("ESCALATION_OFFER")
                        .botReply("I seem to be having trouble helping you today. Would you like me to raise an IT Support Ticket with your chat history attached?")
                        .build();
            }

            // ==========================================
            // 4. VECTOR SEARCH WITH HARD THRESHOLD
            // ==========================================
            List<String> allowedPerms = permissionService.getAllAllowedPermissionIdsForRole(roleId)
                    .stream().map(String::valueOf).collect(Collectors.toList());
            allowedPerms.add("GLOBAL");

            String enhancedSearchQuery = cleanedQuery;
            if (currentScreen != null && !currentScreen.isEmpty()) {
                enhancedSearchQuery = cleanedQuery + " regarding the " + currentScreen + " screen.";
            }

            // 3. EXECUTE SECURE VECTOR SEARCH
            // Convert user text to vector using mxbai
            Embedding queryEmbedding = embeddingModel.embed(enhancedSearchQuery).content();

            // Step 1: Fetch Top 30 mathematical matches without filtering (Lightning fast)
            EmbeddingSearchRequest searchRequest = EmbeddingSearchRequest.builder()
                    .queryEmbedding(queryEmbedding)
                    .maxResults(30)
                    .minScore(0.55)
                    .build();

            EmbeddingSearchResult<TextSegment> searchResult = vectorStore.search(searchRequest);

            // Stream Filter & Track Highest Confidence Score
            double highestScore = 0.0;
            List<EmbeddingMatch<TextSegment>> matches = searchResult.matches().stream()
                    .filter(match -> allowedPerms.contains(match.embedded().metadata().getString("permissionId")))
                    .limit(3)
                    .collect(Collectors.toList());

            if (!matches.isEmpty()) {
                highestScore = matches.get(0).score(); // Capture confidence for analytics!
            }

            // ==========================================
            // 5. DETERMINISTIC GUARD (Bypass LLM entirely!)
            // ==========================================
            if (matches.isEmpty()) {
                log.info("[AI-CHAT] No context found. Applying Hybrid Router.");

                // We pass the mathematical vector of what the user typed into our NLP classifier
                // Pass BOTH the cleaned string and the mathematical vector
                if (isSmallTalk(cleanedQuery, queryEmbedding)) {
                    Long logId = analyticsService.logChatInteraction(userId, "JAVA_ROUTER", userMessage, "SMALL_TALK", 100);
                    return HelpResponseDTO.builder()
                            .responseType("TEXT_REPLY")
                            .botReply("Hello! I am the FinCore Smart Assistant. How can I help you with your banking needs today?")
                            .logId(logId)
                            .build();
                }

                // If it is NOT small talk, and NOT in the database -> Fast Fail
                sessionService.addStrikes(userId, 1);
                Long failLogId = analyticsService.logChatInteraction(userId, "SEMANTIC_ROUTER", userMessage, "NO_MATCH", 0);
                return HelpResponseDTO.builder()
                        .responseType("NO_MATCH")
                        .botReply(FAILURE_MSG)
                        .logId(failLogId)
                        .build();
            }


            // ==========================================
            // 6. GENERATIVE AI EXECUTION
            // ==========================================
            StringBuilder contextBuilder = new StringBuilder();
            String primaryActionLink = null;
            String primaryActionLabel = null;

            for (EmbeddingMatch<TextSegment> match : matches) {
                contextBuilder.append("- ").append(match.embedded().text()).append("\n\n");
                if (primaryActionLink == null) {
                    String link = match.embedded().metadata().getString("actionLink");
                    if (!"NONE".equals(link)) {
                        primaryActionLink = link;
                        primaryActionLabel = match.embedded().metadata().getString("actionLabel");
                    }
                }
            }

            // 5. DYNAMIC PROMPT INJECTION
            String liveEtlDate = permissionService.getLiveEtlDate();
            String currentTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("EEEE, MMMM dd, yyyy - hh:mm a"));
            List<String> allowedActionNames = permissionService.getAllowedActionNamesForRole(roleId);

            String dynamicPrompt = """
                     You are the FinCore Smart Assistant, an AI banking bot.
                     Current Time: %s
                     System ETL Date: %s
                    
                     RULES:
                     1. Answer the user's question using ONLY the [BANKING CONTEXT] below.
                     2. Be direct, professional, and use HTML tags like <b> for formatting.
                     3. Do NOT explain your thought process.
                     4. If the context does not fully answer the question, reply EXACTLY: '%s'
                    
                    [BANKING CONTEXT]
                     %s
                    """.formatted(currentTime, liveEtlDate, FAILURE_MSG, contextBuilder.toString());

            // 6. MANAGE CHAT MEMORY & CALL PHI-3
            ChatMemory memory = userMemories.get(userId, k -> MessageWindowChatMemory.withMaxMessages(5));
            memory.add(UserMessage.from(userMessage)); // Add original message to memory, not cleaned

            log.info("[AI-CHAT] Sending Context to Phi-3 LLM. Confidence Score: {}", highestScore);
            AiMessage responseMessage = chatClient.generate(
                    SystemMessage.from(dynamicPrompt),
                    memory.messages().get(memory.messages().size() - 1)
            ).content();

            String aiResponse = responseMessage.text();

            if (aiResponse.contains("I cannot find this information") || aiResponse.contains(FAILURE_MSG)) {
                sessionService.addStrikes(userId, 1);
                Long failLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "NO_MATCH", (int) (highestScore * 100));
                memory.add(AiMessage.from(FAILURE_MSG));
                return HelpResponseDTO.builder().responseType("NO_MATCH").botReply(FAILURE_MSG).logId(failLogId).build();
            }

            sessionService.resetStrikes(userId);
            memory.add(responseMessage);

            // Pass the Redis Math Score to your Database Analytics!
            Long successLogId = analyticsService.logChatInteraction(userId, "AI_RAG", userMessage, "ANSWERED", (int) (highestScore * 100));

            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply(aiResponse.trim())
                    .navigationLink(primaryActionLink)
                    .navigationLabel(primaryActionLabel)
                    .logId(successLogId)
                    .build();

        } catch (Exception e) {
            log.error("[AI-CHAT] Critical AI Generation Failure", e);
            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply("I am currently experiencing a cognitive delay. Please try again in a moment.")
                    .build();
        }
    }

    /**
     * HYBRID INTENT CLASSIFIER
     * Uses Regex mxbai-embed-large to mathematically compare the user's sentence
     * against the concept of "Small Talk".
     */
    private boolean isSmallTalk(String cleanedQuery, Embedding userEmbedding) {
        String q = cleanedQuery.toLowerCase();
        if (q.isEmpty()) return true;

        // LAYER 1: The Fast Regex Guard
        if (q.matches(".*\\b(how are you|who are you|who built you|what time is it|thanks|thank you|hello|hi|hey)\\b.*")) {
            log.info("[ROUTER] Caught by Regex.");
            return true;
        }

        // LAYER 2: The Semantic Math Guard (Catches typos and synonyms)
        float[] vectorA = userEmbedding.vector();
        float[] vectorB = this.smallTalkAnchor.vector();
        double dotProduct = 0.0;
        double normA = 0.0;
        double normB = 0.0;

        for (int i = 0; i < vectorA.length; i++) {
            dotProduct += vectorA[i] * vectorB[i];
            normA += vectorA[i] * vectorA[i];
            normB += vectorB[i] * vectorB[i];
        }

        double cosineSimilarity = dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        log.info("[ROUTER] Semantic Score: {}%", (int) (cosineSimilarity * 100));

        // 0.75 is a very safe, strict threshold.
        return cosineSimilarity > 0.75;
    }


    public void incrementFaqPopularity(String questionText) {
        faqRepository.findByQuestionTextAndIsActive(questionText, "Y").ifPresent(faq -> {
            faq.setViewCount(faq.getViewCount() + 1);
            faqRepository.save(faq);
        });
    }
}




DocumentIngestionService :

package com.fincore.helpservice.service;

import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.model.KnowledgeBaseEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.fincore.helpservice.repository.KnowledgeBaseRepository;
import dev.langchain4j.data.document.Document;
import dev.langchain4j.data.document.Metadata;
import dev.langchain4j.data.document.splitter.DocumentSplitters;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

import static java.util.Collections.singletonList;

/**
 * Handles converting ALL Oracle DB text (Procedural + Conceptual)
 * into AI Mathematical Vectors using LangChain4j and Redis.
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class DocumentIngestionService {

    private final HelpQuestionRepository questionRepository;
    private final KnowledgeBaseRepository knowledgeBaseRepository;
    private final HelpFaqRepository faqRepository;

    private final EmbeddingModel embeddingModel;
    private final EmbeddingStore<TextSegment> embeddingStore;

    @EventListener(ApplicationReadyEvent.class)
    public void ingestKnowledgeBase() {
        log.info("[AI-INGEST] Starting Knowledge Ingestion to Redis via mxbai-embed...");

        List<Document> allDocuments = new ArrayList<>();

        // ---------------------------------------------------------
        // 1. INGEST PROCEDURAL DATA (Help Questions & UI Buttons)
        // ---------------------------------------------------------
        List<HelpQuestionEntity> questions = questionRepository.findByIsActive("Y");
        for (HelpQuestionEntity q : questions) {
            String content = "Module: " + (q.getScreenName() != null ? q.getScreenName() : "General") +
                    "\nQuestion: " + q.getQuestionText() +
                    "\nAnswer: " + q.getAnswerContent() +
                    (q.getProTip() != null ? "\nPro Tip: " + q.getProTip() : "");

            String permId = q.getPermissionId() != null ? String.valueOf(q.getPermissionId()) : "GLOBAL";

            Metadata metadata = new Metadata()
                    .put("permissionId", permId)
                    .put("actionLink", q.getActionLink() != null ? q.getActionLink() : "NONE")
                    .put("actionLabel", q.getActionLabel() != null ? q.getActionLabel() : "NONE")
                    .put("dataType", "PROCEDURAL");

            allDocuments.add(Document.from(content, metadata));
        }

        // ---------------------------------------------------------
        // 2. INGEST CONCEPTUAL DATA (Knowledge Base Paragraphs)
        // ---------------------------------------------------------
        List<KnowledgeBaseEntity> knowledgeBase = knowledgeBaseRepository.findByIsActive("Y");
        for (KnowledgeBaseEntity kb : knowledgeBase) {
            String content = "Topic: " + kb.getTopic() +
                    "\nInformation: " + kb.getContentParagraph();

            String permId = kb.getPermissionId() != null ? String.valueOf(kb.getPermissionId()) : "GLOBAL";

            // Conceptual data doesn't have UI action buttons, so we default to NONE
            Metadata metadata = new Metadata()
                    .put("permissionId", permId)
                    .put("actionLink", "NONE")
                    .put("actionLabel", "NONE")
                    .put("dataType", "CONCEPTUAL");

            allDocuments.add(Document.from(content, metadata));
        }

        // ---------------------------------------------------------
        // 2. INGEST FAQs (Knowledge Base Paragraphs)
        // ---------------------------------------------------------
        List<HelpFaqEntity> faqs = faqRepository.findAll();
        for (HelpFaqEntity faq : faqs) {
            if ("Y".equals(faq.getIsActive())) {
                String content = "FAQ Question: " + faq.getQuestionText() + "\nAnswer: " + faq.getAnswerContent();
                Metadata metadata = new Metadata().put("permissionId", "GLOBAL") // FAQs are Global
                        .put("actionLink", "NONE").put("actionLabel", "NONE").put("dataType", "FAQ");
                allDocuments.add(Document.from(content, metadata));
            }
        }

        // ---------------------------------------------------------
        // 3. CHUNK AND SAVE TO REDIS
        // ---------------------------------------------------------
        if (!allDocuments.isEmpty()) {
            // Split long documents into overlapping 300-token chunks
            List<TextSegment> segments = DocumentSplitters.recursive(300, 50).splitAll(allDocuments);
            log.info("[AI-INGEST] Chunked {} raw DB records into {} mathematical segments.", allDocuments.size(), segments.size());

            // Generate Vectors via Ollama
            List<Embedding> embeddings = embeddingModel.embedAll(segments).content();

            // FIX GAP 1: Deterministic IDs to prevent Redis duplication on restart
            for (int i = 0; i < segments.size(); i++) {
                TextSegment segment = segments.get(i);
                Embedding vector = embeddings.get(i);

                // Generate a unique, repeatable ID based on the Data Type and Permission
                String dataType = segment.metadata().getString("dataType");
                String perm = segment.metadata().getString("permissionId");

                // Example ID: "PROCEDURAL_5_chunk_0", "CONCEPTUAL_GLOBAL_chunk_1"
                String deterministicId = dataType + "_" + perm + "_chunk_" + i;

                // Save one by one using the explicit ID
                embeddingStore.addAll(
                        singletonList(deterministicId),
                        singletonList(vector),
                        singletonList(segment)
                );
            }
            log.info("[AI-INGEST] Successfully saved/overwritten {} vectors to Redis Stack.", segments.size());

        } else {
            log.warn("[AI-INGEST] No active documents found in Oracle DB to ingest!");
        }
    }
}



-- ==========================================
-- 1. SCHEMA UPDATES
-- ==========================================

-- Drop redundant table
DROP TABLE HELP_SCREEN_MASTER;

-- Update Question Table to link with PERMISSIONS ID
-- Assuming HELP_QUESTION_MASTER exists, if not create it. 
-- Here we ALTER it to add the ID and PRO_TIP
ALTER TABLE HELP_QUESTION_MASTER ADD PERMISSION_ID NUMBER(10,0);
ALTER TABLE HELP_QUESTION_MASTER ADD PRO_TIP VARCHAR2(500 CHAR);
ALTER TABLE HELP_QUESTION_MASTER ADD UI_SELECTOR VARCHAR2(100 CHAR);
ALTER TABLE HELP_QUESTION_MASTER ADD RELATED_QUESTION_IDS VARCHAR2(200 CHAR);

-- Create Synonyms Table for Adaptive Search
CREATE TABLE HELP_SYNONYMS (
    SYNONYM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TERM VARCHAR2(100) UNIQUE NOT NULL,
    ROOT_INTENT VARCHAR2(100) NOT NULL, -- e.g. 'CREATE', 'CGL'
    IS_ACTIVE CHAR(1) DEFAULT 'Y'
);

-- ==========================================
-- 2. SEED DATA: SYNONYMS (The Vocabulary)
-- ==========================================
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('add', 'CREATE');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('new', 'CREATE');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('generate', 'CREATE');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('make', 'CREATE');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('raise', 'CREATE');

INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('change', 'MODIFY');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('update', 'MODIFY');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('edit', 'MODIFY');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('correct', 'MODIFY');

INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('authorize', 'APPROVE');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('pass', 'APPROVE');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('sign', 'APPROVE');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('accept', 'APPROVE');

INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('remove', 'DELETE');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('trash', 'DELETE');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('cancel', 'DELETE');

INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('show', 'VIEW');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('list', 'VIEW');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('see', 'VIEW');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('fetch', 'VIEW');

-- Screen Synonyms (Mapping slang to IDs/Names)
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('glc', 'CGL Management');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('cgl', 'CGL Management');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('users', 'User Management');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('staff', 'User Management');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('seg', 'Segment Management');
INSERT INTO HELP_SYNONYMS (TERM, ROOT_INTENT) VALUES ('branch', 'Branch Management');

-- ==========================================
-- 3. SEED DATA: QUESTIONS (The Knowledge)
-- Based on your PERMISSIONS table IDs: 
-- 10=CGL, 60=Segment, 54=User, 58=Branch, 101=Template
-- ==========================================

-- --- CGL MANAGEMENT (ID: 10) ---
INSERT INTO HELP_QUESTION_MASTER (QUESTION_ID, QUESTION_TEXT, ANSWER_CONTENT, KEYWORDS, IS_ACTIVE, SCREEN_NAME, PERMISSION_ID, REQUIRED_ACTION, DISPLAY_ORDER, PRO_TIP, UI_SELECTOR) 
VALUES ('Q_CGL_01', 'How to create a new CGL?', 
'To create a CGL: 1. Navigate to CGL Management. 2. Click "Add". 3. Fill in the GL Code and Description. 4. Select the Account Type. 5. Click Save.', 
'add cgl new gl code', 'Y', 'CGL Management', 10, 'CREATE', 1, 
'Ensure the GL Code is unique. Once used in a transaction, it cannot be deleted.', '#btn-add-cgl');

INSERT INTO HELP_QUESTION_MASTER (QUESTION_ID, QUESTION_TEXT, ANSWER_CONTENT, KEYWORDS, IS_ACTIVE, SCREEN_NAME, PERMISSION_ID, REQUIRED_ACTION, DISPLAY_ORDER, PRO_TIP) 
VALUES ('Q_CGL_02', 'How to modify a CGL?', 
'Locate the CGL in the grid, click the "Edit" (Pencil) icon, make your changes, and click Update.', 
'edit update change cgl', 'Y', 'CGL Management', 10, 'MODIFY', 2, 
'You cannot change the GL Code itself, only the description and status.');

INSERT INTO HELP_QUESTION_MASTER (QUESTION_ID, QUESTION_TEXT, ANSWER_CONTENT, KEYWORDS, IS_ACTIVE, SCREEN_NAME, PERMISSION_ID, REQUIRED_ACTION, DISPLAY_ORDER, PRO_TIP) 
VALUES ('Q_CGL_03', 'How to approve a CGL request?', 
'Go to CGL Management > Pending Approvals tab. Select the record and click "Approve".', 
'authorize sign pass', 'Y', 'CGL Management', 10, 'APPROVE', 3, 
'Always verify the GL Type before approving to prevent reporting errors.');

-- --- USER MANAGEMENT (ID: 54) ---
INSERT INTO HELP_QUESTION_MASTER (QUESTION_ID, QUESTION_TEXT, ANSWER_CONTENT, KEYWORDS, IS_ACTIVE, SCREEN_NAME, PERMISSION_ID, REQUIRED_ACTION, DISPLAY_ORDER, UI_SELECTOR) 
VALUES ('Q_USER_01', 'How to add a new User?', 
'Click the "Create User" button. Enter the Employee ID, Name, and assign a Role. The system will generate a temporary password.', 
'create staff member employee', 'Y', 'User Management', 54, 'CREATE', 1, '#btn-create-user');

INSERT INTO HELP_QUESTION_MASTER (QUESTION_ID, QUESTION_TEXT, ANSWER_CONTENT, KEYWORDS, IS_ACTIVE, SCREEN_NAME, PERMISSION_ID, REQUIRED_ACTION, DISPLAY_ORDER, PRO_TIP) 
VALUES ('Q_USER_02', 'How to reset a user password?', 
'Find the user, select "Reset Password" from the action menu. An OTP will be sent to their registered email.', 
'forgot password login unlock', 'Y', 'User Management', 54, 'MODIFY', 2, 
'Users must change their password immediately after the first login.');

-- --- SEGMENT MANAGEMENT (ID: 60) ---
INSERT INTO HELP_QUESTION_MASTER (QUESTION_ID, QUESTION_TEXT, ANSWER_CONTENT, KEYWORDS, IS_ACTIVE, SCREEN_NAME, PERMISSION_ID, REQUIRED_ACTION, DISPLAY_ORDER) 
VALUES ('Q_SEG_01', 'How to create a Segment?', 
'Navigate to Segment Master. Click Add. Define the Segment Hierarchy and Save.', 
'add segment structure', 'Y', 'Segment Management', 60, 'CREATE', 1);

-- --- GENERIC / DEFINITIONS (No Action Required) ---
INSERT INTO HELP_QUESTION_MASTER (QUESTION_ID, QUESTION_TEXT, ANSWER_CONTENT, KEYWORDS, IS_ACTIVE, SCREEN_NAME, PERMISSION_ID, DISPLAY_ORDER) 
VALUES ('Q_DEF_01', 'What is CGL?', 
'CGL stands for Central General Ledger. It is the master list of all accounts used to record financial transactions.', 
'definition meaning what is', 'Y', 'CGL Management', 10, 99);

-- ==========================================
-- 4. LINK RELATED TOPICS (Knowledge Graph)
-- ==========================================
-- Linking Create CGL (Q_CGL_01) to Approve CGL (Q_CGL_03)
UPDATE HELP_QUESTION_MASTER SET RELATED_QUESTION_IDS = 'Q_CGL_03,Q_DEF_01' WHERE QUESTION_ID = 'Q_CGL_01';




















package com.fincore.helpservice.service;

import com.fincore.helpservice.dto.HelpItemDTO;
import com.fincore.helpservice.dto.HelpRequestDTO;
import com.fincore.helpservice.dto.HelpResponseDTO;
import com.fincore.helpservice.model.HelpFaqEntity;
import com.fincore.helpservice.model.HelpQuestionEntity;
import com.fincore.helpservice.model.PermissionEntity;
import com.fincore.helpservice.repository.HelpFaqRepository;
import com.fincore.helpservice.repository.HelpQuestionRepository;
import com.fincore.helpservice.repository.PermissionRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Service
@RequiredArgsConstructor
@Slf4j
public class HelpService {

    private final HelpQuestionRepository questionRepository;
    private final HelpFaqRepository faqRepository;
    private final PermissionRepository permissionRepository; // Source of Truth for Screens
    
    private final HelpAnalyticsService analyticsService;
    private final PermissionService permissionService;
    private final NLPEngine nlpEngine;
    private final SmallTalkService smallTalkService;
    private final SmartResponseGenerator responseGenerator;
    private final ChatSessionService sessionService;
    private final SentimentAnalyzer sentimentAnalyzer;
    private final SupportRoutingService routingService;
    private final AdaptiveSearchService adaptiveService;

    // Thresholds
    private static final int SCORE_THRESHOLD_HIGH = 60; 
    private static final int SCORE_THRESHOLD_LOW = 20;

    public HelpResponseDTO processRequest(HelpRequestDTO request, String userId, String roleId) {
        String type = request.getRequestType();
        switch (type) {
             case "MODULE_QUESTIONS": return handleModuleFetch(request.getScreenName(), roleId);
             case "FAQ_LIST": return handleFaqFetch();
             case "GET_ANSWER": return handleGetAnswer(request.getQuestionId());
             case "CHAT": return handleChat(userId, request.getChatMessage(), request.getScreenName(), roleId);
             default: throw new IllegalArgumentException("Invalid Request Type");
        }
    }

    private HelpResponseDTO handleModuleFetch(String screenName, String roleId) {
        // Resolve Screen Name to ID
        Integer permissionId = resolveScreenToId(screenName);
        if (permissionId == null) throw new IllegalArgumentException("Invalid Screen Name");

        List<String> userActions = permissionService.getUserActions(roleId, screenName);
        
        List<HelpItemDTO> items = getQuestionsForPermissionId(permissionId).stream()
                .filter(q -> isActionAllowed(q, userActions))
                .map(this::mapToDTO)
                .collect(Collectors.toList());

        return HelpResponseDTO.builder().responseType("LIST_SELECTION").botReply("Topics for " + screenName).items(items).build();
    }
    
    private HelpResponseDTO handleFaqFetch() { 
        return HelpResponseDTO.builder().responseType("LIST_SELECTION").botReply("FAQs").items(fetchGlobalFaqs()).build(); 
    }
    
    private HelpResponseDTO handleGetAnswer(String questionId) {
        return questionRepository.findById(questionId)
                .map(q -> HelpResponseDTO.builder()
                        .responseType("TEXT_REPLY")
                        .botReply(q.getAnswerContent())
                        .navigationLink(q.getActionLink())
                        .navigationLabel(q.getActionLabel())
                        .build())
                .orElse(HelpResponseDTO.builder().responseType("NO_MATCH").botReply("Content not found.").build());
    }

    // =========================================================================
    // THE SMART CHAT HANDLER
    // =========================================================================
    private HelpResponseDTO handleChat(String userId, String rawMessage, String clientScreenName, String roleId) {
        if (!StringUtils.hasText(rawMessage)) return HelpResponseDTO.builder().responseType("NO_MATCH").botReply("Please type a message.").build();
        
        StringBuilder botPrefix = new StringBuilder();

        // 0. RESET
        if (nlpEngine.isResetRequest(rawMessage)) {
            sessionService.clearSession(userId);
            return HelpResponseDTO.builder().responseType("TEXT_REPLY").botReply("Conversation cleared.").build();
        }

        // 1. SENTIMENT ANALYSIS
        SentimentAnalyzer.Sentiment sentiment = sentimentAnalyzer.analyze(rawMessage);
        if (sentiment != SentimentAnalyzer.Sentiment.NEUTRAL) {
            botPrefix.append(sentimentAnalyzer.getDeEscalationMessage(sentiment)).append("<br/><br/>");
        }

        // 2. SMALL TALK
        if (sentiment == SentimentAnalyzer.Sentiment.NEUTRAL) {
            String smallTalk = smallTalkService.getSmallTalkResponse(rawMessage);
            if (smallTalk != null) return HelpResponseDTO.builder().responseType("TEXT_REPLY").botReply(smallTalk).build();
        }

        // 3. NLP & CONTEXT RESOLUTION
        String normalizedIntent = nlpEngine.extractNormalizedIntent(rawMessage);
        String detectedAction = nlpEngine.detectAction(normalizedIntent);
        String detectedScreenName = nlpEngine.detectScreen(rawMessage); // Returns String Name

        // -- MEMORY & ANAPHORA --
        ChatSessionService.UserSession session = sessionService.getSession(userId);
        
        // Resolve "it/this"
        if (nlpEngine.containsPronoun(rawMessage) && session != null && session.getLastTopic() != null) {
            String resolvedMsg = nlpEngine.resolveAnaphora(rawMessage, session.getLastTopic());
            normalizedIntent = nlpEngine.extractNormalizedIntent(resolvedMsg); 
            botPrefix.append("*(Context: ").append(session.getLastTopic()).append(")*<br/>");
        }
        
        // Merge Action from History
        if (detectedAction == null && detectedScreenName != null && session != null && session.getLastAction() != null) {
            detectedAction = session.getLastAction();
            normalizedIntent = detectedAction + " " + normalizedIntent; 
        }
        
        // Merge Screen from History/Client
        if (detectedScreenName == null) {
            if (session != null && session.getLastScreen() != null) detectedScreenName = session.getLastScreen();
            else if (clientScreenName != null) detectedScreenName = clientScreenName;
        }

        // Resolve Screen Name to ID for Database Query
        Integer activePermissionId = resolveScreenToId(detectedScreenName);
        String activeScreenName = detectedScreenName; // Keep string for UI/Text

        // 4. DISAMBIGUATION (If Action found but Screen is null)
        if (detectedAction != null && activePermissionId == null) {
             List<String> validScreens = findScreensForAction(roleId, detectedAction);
             if (validScreens.size() > 1) {
                 sessionService.updateSession(userId, detectedAction, null, null);
                 return HelpResponseDTO.builder()
                        .responseType("LIST_SELECTION")
                        .botReply(botPrefix + "I see you want to **" + detectedAction + "**. Which module?")
                        .items(validScreens.stream().map(s -> HelpItemDTO.builder().text(s).id("CTX_" + s).type("CONTEXT_SUGGESTION").build()).collect(Collectors.toList()))
                        .build();
             } else if (validScreens.size() == 1) {
                 activeScreenName = validScreens.get(0);
                 activePermissionId = resolveScreenToId(activeScreenName);
             }
        }

        // Update Memory
        sessionService.updateSession(userId, detectedAction, activeScreenName, activeScreenName);

        // 5. PERMISSION CHECK
        if (detectedAction != null && activeScreenName != null) {
            List<String> allowedActions = permissionService.getUserActions(roleId, activeScreenName);
            boolean isAllowed = allowedActions.contains(detectedAction);
            
            if (!isAllowed && !nlpEngine.isTrouble(rawMessage)) { // Don't deny if they are troubleshooting
                 String reply = responseGenerator.generatePermissionResponse(false, detectedAction, activeScreenName, userId);
                 analyticsService.logChatInteraction(userId, activeScreenName, rawMessage, "ACCESS_DENIED", 100);
                 return HelpResponseDTO.builder().responseType("TEXT_REPLY").botReply(botPrefix + reply).build();
            }
        }

        // 6. PERFORM SEARCH
        boolean isDef = nlpEngine.isDefinitionRequest(rawMessage);
        List<HelpItemDTO> matches = performSmartSearch(normalizedIntent, rawMessage, activePermissionId, isDef);

        // --- FALLBACK ROUTING ---
        if (matches.isEmpty()) {
            analyticsService.logChatInteraction(userId, activeScreenName, rawMessage, "NO_MATCH", 0);
            String contact = routingService.getSupportContact(rawMessage);
            return HelpResponseDTO.builder().responseType("NO_MATCH")
                .botReply(botPrefix + "I couldn't find a document for that. For complex queries, please contact **" + contact + "**.").build();
        }

        HelpItemDTO bestMatch = matches.get(0);
        int score = (int) bestMatch.getSearchScore();

        if (score >= SCORE_THRESHOLD_HIGH) {
            // Permission check on result
             if (bestMatch.getRequiredAction() != null) {
                 List<String> allowedActions = permissionService.getUserActions(roleId, bestMatch.getScreenName());
                 if (!allowedActions.contains(bestMatch.getRequiredAction())) {
                     String deniedMsg = responseGenerator.generatePermissionResponse(false, bestMatch.getRequiredAction(), bestMatch.getScreenName(), userId);
                     return HelpResponseDTO.builder().responseType("TEXT_REPLY").botReply(botPrefix + deniedMsg).build();
                 }
            }
            
            String logId = analyticsService.logChatInteraction(userId, activeScreenName, rawMessage, "ANSWERED", score);
            
            // Dynamic Reply Construction
            StringBuilder finalReply = new StringBuilder();
            if (detectedAction != null && activeScreenName != null) {
                finalReply.append(responseGenerator.generatePermissionResponse(true, detectedAction, activeScreenName, userId)).append("<br/><br/>");
            } else {
                finalReply.append(responseGenerator.generateSearchIntro(score)).append("<br/>");
            }
            finalReply.append(bestMatch.getAnswer());
            
            if (bestMatch.getProTip() != null) {
                finalReply.append("<br/><br/>ðŸ’¡ <b>Pro Tip:</b> ").append(bestMatch.getProTip());
            }

            return HelpResponseDTO.builder()
                    .responseType("TEXT_REPLY")
                    .botReply(botPrefix + finalReply.toString())
                    .logId(logId)
                    .navigationLink(bestMatch.getActionLink())
                    .navigationLabel(bestMatch.getActionLabel())
                    .uiElementSelector(bestMatch.getUiSelector()) // UI HIGHLIGHT
                    .build();
        } 
        else {
            String logId = analyticsService.logChatInteraction(userId, activeScreenName, rawMessage, "SUGGESTION", score);
            return HelpResponseDTO.builder().responseType("SUGGESTION")
                    .botReply(botPrefix + responseGenerator.generateSuggestionResponse())
                    .items(matches.stream().limit(3).collect(Collectors.toList())).logId(logId).build();
        }
    }

    // --- SEARCH LOGIC with ID and ADAPTIVE BOOST ---
    private List<HelpItemDTO> performSmartSearch(String normalizedQuery, String rawQuery, Integer activePermissionId, boolean isDefinition) {
        List<String> tokens = Arrays.asList(normalizedQuery.split("\\s+")); 
        
        Stream<HelpItemDTO> questions = getAllActiveQuestions().stream().map(q -> {
             int score = calculateScore(q, normalizedQuery, rawQuery, tokens, activePermissionId, isDefinition);
             // Hive Mind Boost
             score += adaptiveService.getBehavioralBoost(normalizedQuery, q.getQuestionId());
             
             return mapToDTO(q, score);
        });

        Stream<HelpItemDTO> faqs = fetchGlobalFaqsEntity().stream().map(f -> {
             int score = calculateScore(f.getQuestionText(), null, null, normalizedQuery, rawQuery, tokens, null, false);
             return HelpItemDTO.builder().id(f.getFaqId()).text(f.getQuestionText()).answer(f.getAnswerContent()).type("FAQ").searchScore(score).build();
        });

        return Stream.concat(questions, faqs).filter(i -> i.getSearchScore() > 0)
                .sorted((a, b) -> Double.compare(b.getSearchScore(), a.getSearchScore())).limit(5).collect(Collectors.toList());
    }

    private int calculateScore(HelpQuestionEntity q, String normalizedQuery, String rawQuery, List<String> tokens, Integer activePermissionId, boolean isDefinition) {
        return calculateScore(q.getQuestionText(), q.getKeywords(), q.getPermissionId(), normalizedQuery, rawQuery, tokens, activePermissionId, isDefinition);
    }

    private int calculateScore(String text, String keywords, Integer qPermId, String normalizedQuery, String rawQuery, List<String> tokens, Integer activePermId, boolean isDefinition) {
        double score = 0;
        String lowerText = text.toLowerCase();
        
        if (lowerText.equals(rawQuery.toLowerCase())) return 100;
        if (lowerText.contains(rawQuery.toLowerCase())) score += 50;

        int matches = 0;
        for (String token : tokens) {
            if (lowerText.contains(token) || (keywords != null && keywords.toLowerCase().contains(token))) { score += 15; matches++; }
            else if (fuzzyMatch(token, lowerText)) { score += 10; matches++; }
        }
        if (matches > 1) score += (matches * 5);

        // Context Boost via ID
        if (activePermId != null && activePermId.equals(qPermId)) score = score * 2.5;

        if (isDefinition && text.toLowerCase().startsWith("what is")) score += 20;

        return (int) Math.min(score, 100);
    }
    
    // --- HELPER TO RESOLVE STRING NAME TO ID ---
    @Cacheable("screen_name_to_id")
    private Integer resolveScreenToId(String screenName) {
        if (screenName == null) return null;
        // In real app, cache this map. Here querying DB.
        return permissionRepository.findIdByTitle(screenName); 
    }
    
    private List<String> findScreensForAction(String roleId, String action) {
        // Fetch all permissions for role and filter by action
        // This logic mimics finding distinct screens where action is allowed
        return permissionRepository.findScreensByRoleAndAction(roleId, action);
    }

    private HelpItemDTO mapToDTO(HelpQuestionEntity q) { return mapToDTO(q, 0); }
    private HelpItemDTO mapToDTO(HelpQuestionEntity q, int score) {
        return HelpItemDTO.builder()
                .id(q.getQuestionId())
                .text(q.getQuestionText())
                .answer(q.getAnswerContent())
                .type("QUESTION")
                .requiredAction(q.getRequiredAction())
                .screenName(q.getScreenName()) // Still need string for UI
                .permissionId(q.getPermissionId())
                .actionLink(q.getActionLink())
                .actionLabel(q.getActionLabel())
                .proTip(q.getProTip())
                .uiSelector(q.getUiSelector())
                .searchScore(score)
                .build();
    }
    
    // Standard getters/fuzzy logic omitted for brevity (same as previous)
    private boolean fuzzyMatch(String t, String tgt) { return tgt.contains(t); } // stub
    @Cacheable(value = "help_questions_all", key = "'active_global'")
    public List<HelpQuestionEntity> getAllActiveQuestions() { return questionRepository.findByIsActive("Y"); }
    @Cacheable(value = "help_faqs_all")
    public List<HelpFaqEntity> fetchGlobalFaqsEntity() { return faqRepository.findByIsActiveOrderByDisplayOrderAsc("Y"); }
    public List<HelpItemDTO> fetchGlobalFaqs() { return fetchGlobalFaqsEntity().stream().map(f -> HelpItemDTO.builder().id(f.getFaqId()).text(f.getQuestionText()).type("FAQ").build()).collect(Collectors.toList()); }
    private boolean isActionAllowed(HelpQuestionEntity q, List<String> actions) { return q.getRequiredAction() == null || actions.contains(q.getRequiredAction()); }
}



















package com.fincore.helpservice.repository;

import com.fincore.helpservice.model.PermissionEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import java.util.List;

@Repository
public interface PermissionRepository extends JpaRepository<PermissionEntity, Integer> {

    // Lookup Actions
    @Query(value = "SELECT p.MENU_ACTION FROM PERMISSIONS p JOIN ROLE_PERMISSIONS rp ON p.MENU_ID = rp.PERMISSION_ID WHERE rp.ROLE_ID = :roleId AND UPPER(p.MENU_TITLE) = UPPER(:screenName)", nativeQuery = true)
    List<String> findActionForUserAndScreen(@Param("roleId") String roleId, @Param("screenName") String screenName);

    // Lookup ID from Name (For NLP to DB mapping)
    @Query("SELECT p.menuId FROM PermissionEntity p WHERE UPPER(p.menuTitle) = UPPER(:title)")
    Integer findIdByTitle(@Param("title") String title);

    // Lookup Screens for specific Action (For Disambiguation)
    @Query(value = "SELECT DISTINCT p.MENU_TITLE FROM PERMISSIONS p JOIN ROLE_PERMISSIONS rp ON p.MENU_ID = rp.PERMISSION_ID WHERE rp.ROLE_ID = :roleId AND p.MENU_ACTION LIKE %:action%", nativeQuery = true)
    List<String> findScreensByRoleAndAction(@Param("roleId") String roleId, @Param("action") String action);
}
















package com.fincore.helpservice.service;

import com.fincore.helpservice.model.HelpSynonymEntity;
import com.fincore.helpservice.repository.HelpSynonymRepository;
import jakarta.annotation.PostConstruct;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Service
public class AdaptiveSearchService {
    private final HelpSynonymRepository synonymRepository;
    private final Map<String, String> synonymCache = new ConcurrentHashMap<>();

    public AdaptiveSearchService(HelpSynonymRepository synonymRepository) {
        this.synonymRepository = synonymRepository;
    }

    @PostConstruct
    @Scheduled(fixedRate = 1800000) 
    public void refreshKnowledge() {
        List<HelpSynonymEntity> synonyms = synonymRepository.findByIsActive("Y");
        synonymCache.clear();
        for (HelpSynonymEntity syn : synonyms) {
            synonymCache.put(syn.getTerm().toLowerCase(), syn.getRootIntent().toUpperCase());
        }
    }

    public String getRootFromSynonym(String word) {
        return synonymCache.getOrDefault(word.toLowerCase(), word);
    }
    
    public int getBehavioralBoost(String query, String qId) {
        // Implementation of logic described in previous turns (Analytics lookup)
        return 0; // Stub
    }
}





















package com.fincore.helpservice.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.util.regex.Pattern;
import java.util.Set;

@Service
public class NLPEngine {

    @Autowired private AdaptiveSearchService adaptiveService;
    
    private static final Set<String> STOP_WORDS = Set.of("the", "is", "a", "can", "please", "help");
    private static final Pattern PRONOUN_PATTERN = Pattern.compile("\\b(it|this|that)\\b", Pattern.CASE_INSENSITIVE);
    private static final Pattern RESET_PATTERN = Pattern.compile("\\b(stop|reset|wrong)\\b", Pattern.CASE_INSENSITIVE);
    private static final Pattern TROUBLE_PATTERN = Pattern.compile("\\b(cant|cannot|fail|error|issue)\\b", Pattern.CASE_INSENSITIVE);
    private static final Pattern DEF_PATTERN = Pattern.compile("\\b(what is|define)\\b", Pattern.CASE_INSENSITIVE);

    public String extractNormalizedIntent(String sentence) {
        if (sentence == null) return "";
        StringBuilder sb = new StringBuilder();
        for (String w : sentence.toLowerCase().split("\\W+")) {
            if (!STOP_WORDS.contains(w)) sb.append(adaptiveService.getRootFromSynonym(w)).append(" ");
        }
        return sb.toString().trim();
    }
    
    public String detectAction(String normalized) {
        if(normalized.contains("CREATE")) return "CREATE";
        if(normalized.contains("MODIFY")) return "MODIFY";
        if(normalized.contains("APPROVE")) return "APPROVE";
        if(normalized.contains("VIEW")) return "VIEW";
        if(normalized.contains("DELETE")) return "DELETE";
        return null;
    }
    
    public String detectScreen(String raw) {
        String lower = raw.toLowerCase();
        if (lower.contains("cgl")) return "CGL Management";
        if (lower.contains("segment")) return "Segment Management";
        if (lower.contains("user")) return "User Management";
        // ... add more mappings or make dynamic ...
        return null;
    }
    
    public boolean containsPronoun(String t) { return t != null && PRONOUN_PATTERN.matcher(t).find(); }
    public String resolveAnaphora(String t, String topic) { return PRONOUN_PATTERN.matcher(t).replaceAll(topic); }
    public boolean isResetRequest(String t) { return t != null && RESET_PATTERN.matcher(t).find(); }
    public boolean isTrouble(String t) { return t != null && TROUBLE_PATTERN.matcher(t).find(); }
    public boolean isDefinitionRequest(String t) { return t != null && DEF_PATTERN.matcher(t).find(); }
}


















package com.fincore.helpservice.model;

import jakarta.persistence.*;
import lombok.Data;

@Data
@Entity
@Table(name = "HELP_QUESTION_MASTER")
public class HelpQuestionEntity {
    @Id
    @Column(name = "QUESTION_ID")
    private String questionId;

    @Column(name = "QUESTION_TEXT")
    private String questionText;

    @Lob
    @Column(name = "ANSWER_CONTENT")
    private String answerContent;
    
    @Column(name = "KEYWORDS")
    private String keywords;
    
    @Column(name = "IS_ACTIVE")
    private String isActive;
    
    @Column(name = "SCREEN_NAME")
    private String screenName; // For UI display
    
    @Column(name = "PERMISSION_ID")
    private Integer permissionId; // For robust linking
    
    @Column(name = "REQUIRED_ACTION")
    private String requiredAction;
    
    @Column(name = "ACTION_LINK")
    private String actionLink;
    
    @Column(name = "ACTION_LABEL")
    private String actionLabel;
    
    @Column(name = "PRO_TIP")
    private String proTip;       // The Wisdom
    
    @Column(name = "UI_SELECTOR")
    private String uiSelector;   // The Guide
    
    @Column(name = "RELATED_QUESTION_IDS")
    private String relatedQuestionIds;
    
    @Column(name = "DISPLAY_ORDER")
    private Integer displayOrder;
}



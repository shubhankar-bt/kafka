DROP TABLE HELP_SEARCH_ANALYTICS;

CREATE TABLE HELP_SEARCH_ANALYTICS (
    LOG_ID          VARCHAR2(50 CHAR) NOT NULL,
    USER_ID         VARCHAR2(50 CHAR),         -- To track who asked
    SEARCH_QUERY    VARCHAR2(500 CHAR),        -- The chat message
    SCREEN_CONTEXT  VARCHAR2(100 CHAR),        -- Where were they? (e.g. CGL Management)
    RESULT_STATUS   VARCHAR2(20 CHAR),         -- New: ANSWERED, SUGGESTION, NO_MATCH
    CONFIDENCE_SCORE NUMBER(3,0),              -- New: 0-100
    CLICKED_Q_ID    VARCHAR2(50 CHAR),         -- Populated later via Feedback API
    SEARCH_TIMESTAMP TIMESTAMP DEFAULT SYSTIMESTAMP,
    
    CONSTRAINT PK_HELP_ANALYTICS PRIMARY KEY (LOG_ID)
);














package com.fincore.helpservice.entity;

import jakarta.persistence.*;
import lombok.Data;
import org.hibernate.annotations.CreationTimestamp;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * Entity: HELP_SEARCH_ANALYTICS
 * Purpose: Logs every chat interaction for future analysis.
 */
@Data
@Entity
@Table(name = "HELP_SEARCH_ANALYTICS")
public class HelpSearchAnalyticsEntity {

    @Id
    @Column(name = "LOG_ID", length = 50)
    private String logId;

    @Column(name = "USER_ID", length = 50)
    private String userId;

    @Column(name = "SEARCH_QUERY", length = 500) // Matches SQL Column
    private String searchQuery;

    @Column(name = "SCREEN_CONTEXT", length = 100)
    private String screenContext;

    // Enum values: "ANSWERED", "SUGGESTION", "NO_MATCH"
    @Column(name = "RESULT_STATUS", length = 20)
    private String resultStatus;

    // 0-100
    @Column(name = "CONFIDENCE_SCORE")
    private Integer confidenceScore;

    // Populated later if user clicks a suggestion
    @Column(name = "CLICKED_Q_ID", length = 50)
    private String clickedQuestionId;

    @CreationTimestamp
    @Column(name = "SEARCH_TIMESTAMP", updatable = false)
    private LocalDateTime searchTimestamp;

    @PrePersist
    public void generateId() {
        if (this.logId == null || this.logId.isEmpty()) {
            this.logId = UUID.randomUUID().toString();
        }
    }
}



















package com.fincore.helpservice.service;

import com.fincore.helpservice.entity.HelpSearchAnalyticsEntity;
import com.fincore.helpservice.repository.HelpAnalyticsRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
@Slf4j
public class HelpAnalyticsService {

    private final HelpAnalyticsRepository analyticsRepository;

    /**
     * Async Logging to ensure Chat response time is not affected.
     */
    @Async
    public void logChatInteraction(String userId, String screenContext, String query, String status, int score) {
        try {
            HelpSearchAnalyticsEntity entity = new HelpSearchAnalyticsEntity();
            
            entity.setUserId(userId != null ? userId : "ANONYMOUS");
            entity.setScreenContext(screenContext);
            entity.setSearchQuery(query);
            entity.setResultStatus(status);
            entity.setConfidenceScore(score);
            
            analyticsRepository.save(entity);
            
        } catch (Exception e) {
            // Log error but don't break the application flow
            log.error("Failed to log analytics for query: [{}]", query, e);
        }
    }
}



















// In handleChat method inside HelpService.java

    // ... inside handleChat ...
    
    // Case A: High Confidence
    if (bestScore >= SCORE_THRESHOLD_HIGH) {
        // Update: Pass UserId (if available in request headers/context) and ScreenName
        analyticsService.logChatInteraction("CURRENT_USER", request.getScreenName(), message, "ANSWERED", bestScore);
        
        return HelpResponseDTO.builder()
                .responseType("TEXT_REPLY")
                .botReply(bestMatch.getAnswer())
                .build();
    } 
    // ... repeat for other cases (SUGGESTION, NO_MATCH) ...

